<div class="checklist-instance" *ngIf="!isLoading">
  <!-- Header Section -->
  <div class="header-section">
    <div class="instance-info">
      <h2>
        <i class="fas fa-clipboard-check"></i>
        {{ template?.name }}
      </h2>
      <div class="instance-meta">
        <span class="meta-item">
          <i class="fas fa-folder"></i>
          {{ template?.category | titlecase }}
        </span>
        <span class="meta-item">
          <i class="fas fa-tag"></i>
          {{ template?.type | titlecase }}
        </span>
        <span class="meta-item">
          <i class="fas fa-clock"></i>
          {{ instance?.startedDate | date:'short' }}
        </span>
        <span class="meta-item" *ngIf="instance?.assignedTo">
          <i class="fas fa-user"></i>
          {{ instance.assignedTo }}
        </span>
      </div>
    </div>

    <div class="progress-section">
      <div class="progress-info">
        <span class="progress-text">
          {{ completedItems }} of {{ totalItems }} completed
        </span>
        <span class="progress-percentage">
          {{ progressPercentage.toFixed(0) }}%
        </span>
      </div>
      <div class="progress-bar-wrapper">
        <div class="progress">
          <div 
            class="progress-bar bg-success" 
            role="progressbar" 
            [style.width.%]="progressPercentage">
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Work Order Information Section -->
  <div class="work-order-section card mb-3" *ngIf="instance">
    <div class="card-body">
      <h5 class="card-title mb-3">
        <i class="fas fa-info-circle"></i>
        Work Order Information
      </h5>
      <div class="row">
        <div class="col-md-3 col-sm-6 mb-2" *ngIf="instance.workOrderNumber">
          <strong>Work Order:</strong>
          <div class="text-primary">{{ instance.workOrderNumber }}</div>
        </div>
        <div class="col-md-3 col-sm-6 mb-2" *ngIf="instance.partNumber">
          <strong>Part Number:</strong>
          <div class="text-dark">{{ instance.partNumber }}</div>
        </div>
        <div class="col-md-3 col-sm-6 mb-2" *ngIf="instance.serialNumber">
          <strong>Serial Number:</strong>
          <div class="text-dark">{{ instance.serialNumber }}</div>
        </div>
        <div class="col-md-3 col-sm-6 mb-2" *ngIf="instance.operatorName">
          <strong>Operator:</strong>
          <div class="text-dark">{{ instance.operatorName }}</div>
        </div>
      </div>
      <div class="row mt-2" *ngIf="template?.version || template?.description">
        <div class="col-md-3 col-sm-6 mb-2" *ngIf="template?.version">
          <strong>Template Version:</strong>
          <div class="text-muted">{{ template.version }}</div>
        </div>
        <div class="col-md-9 col-sm-6 mb-2" *ngIf="template?.description">
          <strong>Description:</strong>
          <div class="text-muted">{{ template.description }}</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Navigation Controls -->
  <div class="navigation-section">
    <div class="nav-buttons">
      <button 
        type="button" 
        class="btn btn-outline-secondary"
        (click)="goToPreviousItem()"
        [disabled]="currentItemIndex === 0">
        <i class="fas fa-chevron-left"></i>
        Previous
      </button>

      <div class="item-selector">
        <span class="current-item">
          Item {{ currentItemIndex + 1 }} of {{ totalItems }}
        </span>
        <button 
          type="button" 
          class="btn btn-outline-info btn-sm"
          (click)="showAllItems = !showAllItems">
          <i class="fas fa-list"></i>
          {{ showAllItems ? 'Hide' : 'Show' }} All
        </button>
        <button 
          type="button" 
          class="btn btn-outline-primary btn-sm ms-2"
          (click)="openFullChecklistModal()"
          title="View Full Checklist">
          <i class="fas fa-table"></i>
          Full View
        </button>
      </div>

      <button 
        type="button" 
        class="btn btn-outline-secondary"
        (click)="goToNextItem()"
        [disabled]="currentItemIndex >= totalItems - 1">
        Next
        <i class="fas fa-chevron-right"></i>
      </button>
    </div>

    <!-- Item Overview -->
    <div class="items-overview" *ngIf="showAllItems && instance">
      <div class="items-grid">
        <div 
          *ngFor="let item of instance.items; let i = index"
          class="item-overview-card"
          [class.active]="i === currentItemIndex"
          [class.completed]="item.status === 'completed'"
          [class.skipped]="item.status === 'skipped'"
          (click)="goToItem(i)">
          <div class="item-number">{{ i + 1 }}</div>
          <div class="item-info">
            <div class="item-title">{{ template?.items[i]?.title }}</div>
            <div class="item-status">
              <span class="badge" [ngClass]="getStatusBadgeClass(item.status)">
                {{ item.status | titlecase }}
              </span>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Current Item Section -->
  <div class="current-item-section" *ngIf="getCurrentItem() && getCurrentTemplateItem()">
    <div class="card">
      <div class="card-header">
        <div class="item-header-info">
          <h4>
            <span class="item-number">{{ currentItemIndex + 1 }}</span>
            {{ getCurrentTemplateItem()?.title }}
          </h4>
          <div class="item-badges">
            <span *ngIf="getCurrentTemplateItem()?.required" class="badge badge-warning">
              Required
            </span>
            <span class="badge badge-info">
              {{ getCurrentTemplateItem()?.type | titlecase }}
            </span>
            <span class="badge" [ngClass]="getStatusBadgeClass(getCurrentItem()!.status)">
              {{ getCurrentItem()!.status | titlecase }}
            </span>
          </div>
        </div>
      </div>

      <div class="card-body">
        <!-- Item Description -->
        <div class="item-description" *ngIf="getCurrentTemplateItem()?.description">
          <div [innerHTML]="getCurrentTemplateItem()?.description"></div>
        </div>

        <!-- Reference Image Section (Only show when photos are required) -->
        <div class="reference-images-section mb-4" 
             *ngIf="getCurrentTemplateItem()?.samplePhotoUrl && getCurrentTemplateItem()?.requiresPhoto">
          <h6 class="text-info mb-3">
            <i class="fas fa-images"></i>
            Reference Image
          </h6>
          
          <div class="reference-image-container">
            <img 
              [src]="getCurrentTemplateItem()?.samplePhotoUrl" 
              class="reference-image img-fluid rounded shadow-sm"
              alt="Reference image"
              (click)="previewImage(getCurrentTemplateItem()?.samplePhotoUrl)"
              style="max-height: 300px; cursor: pointer;">
          </div>
        </div>

        <!-- Input Form -->
        <form [formGroup]="itemForm" class="item-form">
          <!-- Check/Verify Type -->
          <div *ngIf="getCurrentTemplateItem()?.type === 'check'" class="form-group">
            <label class="form-label">Status</label>
            <div class="form-check-group">
              <div class="form-check">
                <input 
                  class="form-check-input" 
                  type="radio" 
                  formControlName="value" 
                  value="true"
                  id="check-yes">
                <label class="form-check-label" for="check-yes">
                  <i class="fas fa-check text-success"></i>
                  Yes / Pass
                </label>
              </div>
              <div class="form-check">
                <input 
                  class="form-check-input" 
                  type="radio" 
                  formControlName="value" 
                  value="false"
                  id="check-no">
                <label class="form-check-label" for="check-no">
                  <i class="fas fa-times text-danger"></i>
                  No / Fail
                </label>
              </div>
            </div>
          </div>

          <!-- Text Input Type -->
          <div *ngIf="getCurrentTemplateItem()?.type === 'text'" class="form-group">
            <label class="form-label">Value</label>
            <input 
              type="text" 
              class="form-control" 
              formControlName="value"
              placeholder="Enter text value">
          </div>

          <!-- Number Input Type -->
          <div *ngIf="getCurrentTemplateItem()?.type === 'number'" class="form-group">
            <label class="form-label">Value</label>
            <input 
              type="number" 
              class="form-control" 
              formControlName="value"
              placeholder="Enter numeric value">
          </div>

          <!-- Measurement Type -->
          <div *ngIf="getCurrentTemplateItem()?.type === 'measure'" class="form-group">
            <label class="form-label">
              Measurement 
              <span *ngIf="getCurrentTemplateItem()?.unit">({{ getCurrentTemplateItem()?.unit }})</span>
            </label>
            <div class="measurement-input">
              <input 
                type="number" 
                class="form-control" 
                formControlName="value"
                [min]="getCurrentTemplateItem()?.minValue"
                [max]="getCurrentTemplateItem()?.maxValue"
                step="0.01"
                placeholder="Enter measurement">
              <div class="measurement-info" *ngIf="getCurrentTemplateItem()?.minValue !== undefined">
                <small class="text-muted">
                  Range: {{ getCurrentTemplateItem()?.minValue }} - {{ getCurrentTemplateItem()?.maxValue }}
                  <span *ngIf="getCurrentTemplateItem()?.targetValue">
                    (Target: {{ getCurrentTemplateItem()?.targetValue }})
                  </span>
                </small>
              </div>
            </div>
          </div>

          <!-- Photo Type -->
          <div *ngIf="getCurrentTemplateItem()?.type === 'photo'" class="form-group">
            <label class="form-label">Photos</label>
            
            <!-- Photo not required - Verification Button (Only show verification, no photo upload) -->
            <div *ngIf="!getCurrentTemplateItem()?.requiresPhoto && (!getCurrentItem()?.photos || getCurrentItem()!.photos!.length === 0)">
              <div class="alert mb-3"
                   [ngClass]="getCurrentItem()?.status === 'completed' ? 'alert-success' : 'alert-info'">
                <div class="d-flex align-items-center justify-content-between">
                  <div>
                    <i class="fas me-2" [ngClass]="getCurrentItem()?.status === 'completed' ? 'fa-check-circle' : 'fa-info-circle'"></i>
                    <strong>Photos are optional for this item.</strong>
                    <p class="mb-0 mt-1" *ngIf="getCurrentItem()?.status !== 'completed'">
                      You can mark this item as verified without taking photos.
                    </p>
                    <p class="mb-0 mt-1" *ngIf="getCurrentItem()?.status === 'completed'">
                      This item has been verified without photos.
                    </p>
                  </div>
                  <div>
                    <button 
                      type="button" 
                      class="btn btn-sm"
                      [ngClass]="getCurrentItem()?.status === 'completed' ? 'btn-outline-warning' : 'btn-success'"
                      (click)="toggleVerification()">
                      <i class="fas me-1" [ngClass]="getCurrentItem()?.status === 'completed' ? 'fa-times-circle' : 'fa-check-circle'"></i>
                      {{ getCurrentItem()?.status === 'completed' ? 'Unmark Verified' : 'Mark as Verified' }}
                    </button>
                  </div>
                </div>
              </div>
            </div>
            
            <!-- Photo Actions (Only show when photos are required OR user wants to add photos anyway) -->
            <div *ngIf="getCurrentTemplateItem()?.requiresPhoto || (getCurrentItem()?.photos && getCurrentItem()!.photos!.length > 0)">
              <div class="photo-actions">
                <button 
                  type="button" 
                  class="btn btn-primary btn-sm"
                  (click)="openPhotoCapture(getCurrentItem()!)">
                  <i class="fas fa-camera"></i>
                  Take Photo
                </button>
                
                <input 
                  #fileInput
                  type="file" 
                  class="d-none"
                  accept="image/*"
                  (change)="onFileSelect($event, getCurrentItem()!)">
                
                <button 
                  type="button" 
                  class="btn btn-outline-primary btn-sm"
                  (click)="fileInput.click()">
                  <i class="fas fa-upload"></i>
                  Upload Photo
                </button>
              </div>

              <!-- Existing Photos -->
              <div class="photos-grid" *ngIf="getCurrentItem()?.photos && getCurrentItem()!.photos!.length > 0">
                <div *ngFor="let photo of getCurrentItem()!.photos" class="photo-item">
                  <img [src]="photo.url" class="photo-thumbnail" [alt]="photo.fileName">
                  <div class="photo-overlay">
                    <button 
                      type="button" 
                      class="btn btn-sm btn-danger"
                      (click)="deletePhoto(getCurrentItem()!, photo)"
                      title="Delete Photo">
                      <i class="fas fa-trash"></i>
                    </button>
                  </div>
                  <div class="photo-info">
                    <small>{{ photo.fileName }}</small>
                    <div *ngIf="photo.qualityScore" class="quality-score">
                      Quality: {{ photo.qualityScore }}%
                    </div>
                  </div>
                </div>
              </div>

              <!-- Pending Photos -->
              <div class="pending-photos" *ngIf="pendingPhotos.get(getCurrentItem()!.id)?.length">
                <div *ngFor="let upload of pendingPhotos.get(getCurrentItem()!.id)" class="pending-photo">
                  <img [src]="upload.preview" class="photo-thumbnail" alt="Uploading...">
                  <div class="upload-overlay" *ngIf="upload.uploading">
                    <div class="spinner-border spinner-border-sm" role="status"></div>
                    <div class="upload-progress">{{ upload.progress }}%</div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Notes -->
          <div class="form-group">
            <label class="form-label">Notes (Optional)</label>
            <textarea 
              class="form-control" 
              formControlName="notes"
              rows="3"
              placeholder="Add any additional notes or observations..."></textarea>
          </div>
        </form>

        <!-- Action Buttons -->
        <div class="item-actions">
          <button 
            type="button" 
            class="btn btn-success"
            (click)="completeCurrentItem()"
            [disabled]="isSaving || getCurrentItem()?.status === 'completed'">
            <i class="fas fa-check"></i>
            {{ isSaving ? 'Saving...' : 'Complete Item' }}
          </button>

          <button 
            type="button" 
            class="btn btn-outline-warning"
            (click)="skipCurrentItem()"
            [disabled]="isSaving || getCurrentItem()?.status === 'skipped'">
            <i class="fas fa-forward"></i>
            Skip Item
          </button>

          <button 
            type="button" 
            class="btn btn-outline-secondary"
            (click)="saveCurrentItem()"
            [disabled]="isSaving">
            <i class="fas fa-save"></i>
            Save Progress
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Submission Section -->
  <div class="submission-section" *ngIf="progressPercentage === 100">
    <div class="card border-success">
      <div class="card-header bg-success text-white">
        <h5 class="mb-0">
          <i class="fas fa-flag-checkered"></i>
          Ready for Submission
        </h5>
      </div>
      <div class="card-body">
        <p class="card-text">
          All required items have been completed. You can now submit this inspection checklist.
        </p>
        <button 
          type="button" 
          class="btn btn-success btn-lg"
          (click)="submitInstance()"
          [disabled]="!canSubmitInstance()">
          <i class="fas fa-paper-plane"></i>
          Submit Checklist
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Loading State -->
<div class="loading-state" *ngIf="isLoading">
  <div class="text-center py-5">
    <div class="spinner-border spinner-border-lg" role="status">
      <span class="sr-only">Loading...</span>
    </div>
    <p class="mt-3">Loading inspection checklist...</p>
  </div>
</div>

<!-- Photo Capture Modal -->
<div class="modal fade show" 
     *ngIf="showPhotoCapture" 
     style="display: block; background: rgba(0,0,0,0.5);">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">
          <i class="fas fa-camera"></i>
          Capture Photo
        </h5>
        <button 
          type="button" 
          class="close"
          (click)="closePhotoCapture()">
          <span>&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <div class="camera-container">
          <video 
            id="cameraVideo" 
            autoplay 
            playsinline 
            class="camera-video">
          </video>
          <canvas 
            id="photoCanvas" 
            class="d-none">
          </canvas>
        </div>
        <div class="camera-controls">
          <button 
            type="button" 
            class="btn btn-primary"
            (click)="startCamera()">
            <i class="fas fa-video"></i>
            Start Camera
          </button>
          <button 
            type="button" 
            class="btn btn-success"
            (click)="capturePhoto()">
            <i class="fas fa-camera"></i>
            Capture
          </button>
          <button 
            type="button" 
            class="btn btn-secondary"
            (click)="closePhotoCapture()">
            Cancel
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Signature Modal -->
<div class="modal fade show" 
     *ngIf="showSignature" 
     style="display: block; background: rgba(0,0,0,0.5);">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">
          <i class="fas fa-signature"></i>
          Digital Signature
        </h5>
      </div>
      <div class="modal-body">
        <form [formGroup]="signatureForm">
          <div class="form-group">
            <label>Please provide your digital signature to complete the submission:</label>
            <div class="signature-pad">
              <canvas 
                #signaturePad 
                class="signature-canvas"
                width="400" 
                height="200">
              </canvas>
            </div>
            <div class="signature-actions">
              <button 
                type="button" 
                class="btn btn-outline-secondary btn-sm"
                (click)="clearSignature()">
                <i class="fas fa-eraser"></i>
                Clear
              </button>
              <button 
                type="button" 
                class="btn btn-outline-primary btn-sm"
                (click)="saveSignature()">
                <i class="fas fa-save"></i>
                Save Signature
              </button>
            </div>
          </div>
          
          <div class="form-group">
            <label>Final Notes (Optional)</label>
            <textarea 
              class="form-control" 
              formControlName="notes"
              rows="3"
              placeholder="Any final notes or comments..."></textarea>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button 
          type="button" 
          class="btn btn-secondary"
          (click)="showSignature = false">
          Cancel
        </button>
        <button 
          type="button" 
          class="btn btn-success"
          (click)="finalizeSubmission()"
          [disabled]="signatureForm.invalid || isSubmitting">
          <i class="fas fa-paper-plane"></i>
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Image Preview Modal -->
<div class="modal fade show" 
     *ngIf="showImagePreview" 
     style="display: block; background: rgba(0,0,0,0.8);"
     (click)="closeImagePreview()">
  <div class="modal-dialog modal-xl modal-dialog-centered">
    <div class="modal-content bg-transparent border-0">
      <div class="modal-header border-0 pb-0">
        <button 
          type="button" 
          class="close text-white"
          (click)="closeImagePreview()"
          aria-label="Close"
          style="font-size: 2rem; opacity: 0.8;">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body text-center p-4" (click)="$event.stopPropagation()">
        <img 
          [src]="previewImageUrl" 
          class="img-fluid rounded shadow-lg" 
          style="max-height: 80vh; max-width: 100%; object-fit: contain;"
          alt="Preview image">
      </div>
      <div class="modal-footer border-0 justify-content-center pt-0">
        <button 
          type="button" 
          class="btn btn-light btn-sm"
          (click)="openImageInNewTab()">
          <i class="fas fa-external-link-alt me-1"></i>Open in New Tab
        </button>
        <button 
          type="button" 
          class="btn btn-secondary btn-sm"
          (click)="closeImagePreview()">
          <i class="fas fa-times me-1"></i>Close
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Full Checklist Overview Modal -->
<div class="modal fade show" 
     *ngIf="showFullChecklistModal" 
     style="display: block; background: rgba(0,0,0,0.5);"
     (click)="closeFullChecklistModal()">
  <div class="modal-dialog modal-fullscreen">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <div class="modal-header bg-primary text-white">
        <h5 class="modal-title">
          <i class="fas fa-clipboard-list me-2"></i>
          Full Checklist Overview - {{ template?.name }}
        </h5>
        <button 
          type="button" 
          class="close text-white"
          (click)="closeFullChecklistModal()"
          aria-label="Close"
          style="opacity: 0.8;">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body p-4" style="overflow-x: auto;">
        <div class="table-responsive">
          <table class="table table-bordered table-hover">
            <thead class="table-light">
              <tr>
                <th style="width: 50px;">#</th>
                <th style="width: 300px;">Task</th>
                <th style="width: 200px;">Description</th>
                <th style="width: 100px;">Type</th>
                <th style="width: 120px;">Status</th>
                <th style="width: 150px;">Value</th>
                <th style="width: 200px;">Photos</th>
                <th style="width: 200px;">Notes</th>
                <th style="width: 100px;">Actions</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let item of instance?.items; let i = index"
                  [class.table-primary]="i === currentItemIndex">
                <td class="text-center fw-bold">{{ i + 1 }}</td>
                <td>
                  <div class="fw-semibold">{{ template?.items[i]?.title }}</div>
                  <span class="badge badge-warning badge-sm" *ngIf="template?.items[i]?.required">Required</span>
                </td>
                <td>
                  <div class="small text-muted" style="max-width: 200px; overflow: hidden; text-overflow: ellipsis;">
                    <div [innerHTML]="template?.items[i]?.description || 'N/A'"></div>
                  </div>
                </td>
                <td>
                  <span class="badge badge-info">{{ template?.items[i]?.type | titlecase }}</span>
                </td>
                <td>
                  <span class="badge" [ngClass]="getStatusBadgeClass(getItemDisplayStatus(item, template?.items[i]!))">
                    {{ getItemDisplayStatus(item, template?.items[i]!) | titlecase }}
                  </span>
                </td>
                <td>
                  <span *ngIf="item.value">{{ formatValue(item.value, template?.items[i]!) }}</span>
                  <span class="text-muted" *ngIf="!item.value">-</span>
                </td>
                <td>
                  <div class="d-flex flex-wrap gap-1" *ngIf="item.photos && item.photos.length > 0">
                    <img 
                      *ngFor="let photo of item.photos" 
                      [src]="photo.url" 
                      class="img-thumbnail cursor-pointer"
                      style="width: 50px; height: 50px; object-fit: cover;"
                      [alt]="photo.fileName"
                      (click)="previewImage(photo.url)"
                      [title]="photo.fileName">
                    <span class="badge bg-secondary">{{ item.photos.length }}</span>
                  </div>
                  <span class="text-muted small" *ngIf="!item.photos || item.photos.length === 0">No photos</span>
                </td>
                <td>
                  <div class="small" style="max-width: 200px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" 
                       [title]="item.notes || ''">
                    {{ item.notes || '-' }}
                  </div>
                </td>
                <td>
                  <button 
                    type="button" 
                    class="btn btn-sm btn-outline-primary"
                    (click)="navigateToItemFromModal(i)"
                    title="Go to this item">
                    <i class="fas fa-arrow-right"></i>
                  </button>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
      <div class="modal-footer">
        <div class="me-auto">
          <strong>Progress:</strong> {{ completedItems }} of {{ totalItems }} items completed 
          ({{ progressPercentage.toFixed(0) }}%)
        </div>
        <button 
          type="button" 
          class="btn btn-secondary"
          (click)="closeFullChecklistModal()">
          Close
        </button>
      </div>
    </div>
  </div>
</div>
