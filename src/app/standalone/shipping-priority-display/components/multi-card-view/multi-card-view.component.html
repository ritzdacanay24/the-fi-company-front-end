<div class="multi-card-view" [ngClass]="containerClass" [attr.data-theme]="currentTheme">
  <!-- Header Section -->
  <!-- <div class="row mb-4">
    <div class="col-12">
      <div class="d-flex justify-content-between align-items-center">
        <h3 class="mb-0">
          <i class="mdi mdi-layers"></i>
          {{ displayMode === 'top3' ? 'Top 3 Priorities' : 
             displayMode === 'top6' ? 'Top 6 Priorities' : 
             'All Priorities Grid' }}
        </h3>
        <div class="header-actions">
          <span class="badge bg-info me-2">
            Showing {{ displayedItems.length }} of {{ groupedItems.length }}
          </span>
          <button class="btn btn-outline-primary btn-sm" (click)="onRefreshData()">
            <i class="mdi mdi-refresh"></i>
            Refresh
          </button>
        </div>
      </div>
    </div>
  </div> -->

  <!-- Cards Grid -->
  <div class="row gx-3" *ngIf="displayedItems.length > 0">
    <div *ngFor="let item of displayedItems; let i = index" 
         [ngClass]="cardClass" 
         class="mb-3"
         [class.loading-overlay]="isRefreshing && showRefreshOverlay">
      <div class="card priority-card h-100" 
           [ngClass]="[getPriorityCardColor(i), isOwnerInProduction(item) ? 'in-production' : '']"
           [class.refreshing]="isRefreshing && showRefreshOverlay">
        
        <!-- Production Status Banner (shown at top of card when owner is working) -->
        <div class="production-banner" *ngIf="isOwnerInProduction(item)">
          <i class="mdi mdi-hammer-wrench me-2"></i>
          <span class="fw-bold">IN PRODUCTION</span>
          <span class="ms-2" *ngIf="getProductionOwnerName(item)">- {{ getProductionOwnerName(item) }}</span>
        </div>
        
        <!-- Card Header - Compact Priority & Status Only -->
        <div class="card-header d-flex justify-content-between align-items-center py-2">
          <!-- Executive Priority Ranking -->
          <div class="executive-priority-rank">
            <div class="priority-circle" [ngClass]="getPriorityRankClass(i)">
              <div class="priority-number">{{ i + 1 }}</div>
              <div class="priority-label">PRIORITY</div>
            </div>
          </div>
          
          <div class="header-right d-flex align-items-center gap-3">
            <!-- Priority Source Badge -->
            <div class="priority-source-badge" *ngIf="item.orders[0]?.priority_source && item.orders[0]?.priority_source !== 'shipping'">
              <span class="badge" 
                    [ngClass]="{
                      'bg-primary': item.orders[0]?.priority_source === 'kanban',
                      'bg-warning text-dark': item.orders[0]?.priority_source === 'both'
                    }">
                <i class="mdi" 
                   [ngClass]="{
                     'mdi-view-column': item.orders[0]?.priority_source === 'kanban',
                     'mdi-link-variant': item.orders[0]?.priority_source === 'both'
                   }"></i>
                {{ item.orders[0]?.priority_source === 'both' ? 'Both' : 'Kanban' }}
              </span>
            </div>
            <!-- Owner Badge -->
            <div class="owner-badge" *ngIf="item.orders[0]?.misc?.owner_name">
              <span class="badge bg-secondary">
                <i class="mdi mdi-account-circle me-1"></i>
                {{ item.orders[0].misc.owner_name }}
              </span>
            </div>
            
            <!-- Customer Logo or Name -->
            <div class="customer-branding">
              <img *ngIf="getCustomerLogo(getPrimaryCustomer(item))"
                   [src]="getCustomerLogo(getPrimaryCustomer(item))" 
                   [alt]="getPrimaryCustomer(item) + ' logo'"
                   class="executive-customer-logo"
                   [title]="getPrimaryCustomer(item)">
              <div *ngIf="!getCustomerLogo(getPrimaryCustomer(item))" 
                   class="customer-name-badge">
                <span class="fw-bold">{{ getPrimaryCustomer(item) }}</span>
              </div>
            </div>
            <!-- Priority Status Indicators -->
            <div class="priority-status">
              <div class="status-indicators d-flex flex-row align-items-center gap-2">
                <span *ngIf="hasCompletedOrders(item.orders)" 
                      class="status-badge completed">
                  <i class="mdi mdi-check-circle me-1"></i>Done
                </span>
                <span *ngIf="hasHotOrders(item.orders)" 
                      class="status-badge urgent">
                  <i class="mdi mdi-fire me-1"></i>Hot
                </span>
              </div>
            </div>
          </div>
        </div>

        <!-- Card Body -->
        <div class="card-body" [ngClass]="'layout-' + cardLayout" style="overflow: hidden; word-wrap: break-word;">
          
          <!-- Traditional Layout -->
          <div *ngIf="cardLayout === 'traditional'" class="traditional-layout">
            <div class="order-details">
              <h4 class="order-number mb-2">{{ item.orders[0]?.['ORDNUM'] || 'Multiple' }}-{{ item.orders[0]?.['ORDNUM'] ? (item.orders[0]?.['ORDLINE'] || '1') : item.orders.length + ' Orders' }}</h4>
              <div class="detail-summary">
                <p class="part-number mb-1 fw-bold">{{ item.partNumber }}</p>
                <p class="customer mb-1 text-muted">{{ item.orders[0]?.['COMPANY'] || item.customerName || 'Multiple Customers' }}</p>
                <p class="ship-date small text-muted mb-1">Ship: {{ formatDate(item.dueDate) }}</p>
                <!-- Owner Display -->
                <p class="owner-info small mb-2" *ngIf="getOwnerName(item)">
                  <i class="mdi mdi-account-circle me-1"></i>
                  <span class="fw-semibold">{{ getOwnerName(item) }}</span>
                </p>
                <div class="status-badges">
                  <span *ngIf="hasCompletedOrders(item.orders)" class="badge bg-success me-1">
                    <i class="mdi mdi-check"></i> Completed
                  </span>
                  <span *ngIf="hasHotOrders(item.orders)" class="badge bg-danger me-1">
                    <i class="mdi mdi-fire"></i> Hot
                  </span>
                </div>
              </div>
            </div>
          </div>

          <!-- Production Card Layout -->
          <div *ngIf="cardLayout === 'production'" class="production-layout">
            <!-- Header with Part Number -->
            <div class="prod-header text-center mb-2 pb-2 border-bottom-separator">
              <h2 class="part-number-title text-primary fw-bold mb-1">{{ item.partNumber }}</h2>
              <p class="part-description text-light small mb-0">{{ getPartDescription(item) }}</p>
            </div>
            
            <!-- Compact Three-Column Layout -->
            <div class="row g-2 mb-2">
              <!-- Left Column: Quantity Box -->
              <div class="col-4">
                <div class="prod-quantity-box-compact text-center">
                  <div class="quantity-display-compact">
                    <div class="quantity-number-compact">{{ formatQuantity(item.totalQuantity) }}</div>
                    <div class="quantity-units-compact">UNITS</div>
                  </div>
                </div>
              </div>
              
              <!-- Middle Column: Customer -->
              <div class="col-4">
                <div class="prod-customer-box-compact text-center">
                  <img *ngIf="getCustomerLogo(getPrimaryCustomer(item))"
                       [src]="getCustomerLogo(getPrimaryCustomer(item))" 
                       [alt]="getPrimaryCustomer(item)"
                       class="customer-logo-compact mb-1">
                  <div class="customer-icon-compact mb-1" *ngIf="!getCustomerLogo(getPrimaryCustomer(item))">
                    <i class="mdi mdi-account"></i>
                  </div>
                  <div class="customer-name-compact text-truncate">{{ getPrimaryCustomer(item) }}</div>
                  <div class="customer-label-compact">CUSTOMER</div>
                </div>
              </div>
              
              <!-- Right Column: Orders Count -->
              <div class="col-4">
                <div class="prod-info-box-compact text-center">
                  <div class="info-icon-compact">
                    <i class="mdi mdi-format-list-numbered"></i>
                  </div>
                  <div class="info-value-compact">{{ item.orders.length }}</div>
                  <div class="info-label-compact">ORDER{{ item.orders.length !== 1 ? 'S' : '' }}</div>
                </div>
              </div>
            </div>
            
            <!-- Work Orders - Compact List -->
            <div class="prod-details-compact" *ngIf="getWorkOrderNumbers(item).length > 0 || getOwnerName(item)">
              <!-- Owner Info -->
              <div class="detail-row-compact d-flex align-items-start mb-1" *ngIf="getOwnerName(item)">
                <div class="detail-icon-compact me-2">
                  <i class="mdi mdi-account-circle"></i>
                </div>
                <div class="flex-grow-1">
                  <small class="text-muted d-block">OWNER</small>
                  <strong class="d-block">{{ getOwnerName(item) }}</strong>
                </div>
              </div>
              
              <!-- Work Orders -->
              <div class="detail-row-compact d-flex align-items-start mb-1" *ngIf="getWorkOrderNumbers(item).length > 0">
                <div class="detail-icon-compact me-2">
                  <i class="mdi mdi-wrench"></i>
                </div>
                <div class="flex-grow-1">
                  <small class="text-muted d-block">WORK ORDER{{ getWorkOrderNumbers(item).length > 1 ? 'S' : '' }}</small>
                  <strong class="d-block" *ngFor="let wo of getWorkOrderNumbers(item).slice(0, 2)">{{ wo }}</strong>
                  <small class="text-muted" *ngIf="getWorkOrderNumbers(item).length > 2">+{{ getWorkOrderNumbers(item).length - 2 }} more</small>
                </div>
              </div>
            </div>
          </div>

          <!-- Part Number Layout -->
          <div *ngIf="cardLayout === 'salesorder'" class="salesorder-layout">
            <div class="so-header">
              <!-- <div class="so-label text-uppercase text-muted fw-bold mb-3">PART NUMBER</div> -->
              <h2 class="part-number-large fw-bold mb-1 text-primary">{{ item.partNumber }}</h2>
              <p class="part-description mb-0">{{ getPartDescription(item) }}</p>
            </div>
            
            <div class="so-content">
              <div class="row">
                <div class="col-4">
                  <div class="so-orders">
                    <div class="so-orders-label text-uppercase small text-muted fw-bold mb-2">
                      SALES ORDERS ({{ item.orders.length }} total)
                    </div>
                    <!-- Auto-scroll only if more than 5 orders -->
                    <div class="so-orders-list" [class.auto-scroll-container]="item.orders.length > 5">
                      <div class="scroll-content">
                        <div *ngFor="let order of item.orders" class="so-item small mb-0 text-body">
                          {{ order['SOD_NBR'] || order['ORDNUM'] || 'N/A' }}-{{ order['SOD_LINE'] || order['ORDLINE'] || '1' }}
                        </div>
                        <!-- Duplicate for seamless loop - only if scrolling -->
                        <div *ngIf="item.orders.length > 5">
                          <div *ngFor="let order of item.orders" class="so-item small mb-0 text-body">
                            {{ order['SOD_NBR'] || order['ORDNUM'] || 'N/A' }}-{{ order['SOD_LINE'] || order['ORDLINE'] || '1' }}
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                  <!-- <div class="so-customers mt-3">
                    <div class="customers-label text-uppercase small text-muted fw-bold mb-2">CUSTOMERS</div>
                    <div class="customers-list">
                      <div *ngFor="let customer of getUniqueCustomers(item).slice(0, 2)" class="customer-item small text-muted mb-0 d-flex align-items-center">
                        <img *ngIf="getCustomerLogo(customer)" 
                             [src]="getCustomerLogo(customer)" 
                             [alt]="customer + ' logo'"
                             class="customer-logo me-2"
                             style="width: 20px; height: 20px; object-fit: contain;">
                        <i *ngIf="!getCustomerLogo(customer)" class="mdi mdi-account me-1"></i>
                        {{ customer }}
                      </div>
                      <div *ngIf="getUniqueCustomers(item).length > 2" class="customer-item small text-muted d-flex align-items-center">
                        <i class="mdi mdi-account-multiple me-1"></i>
                        +{{ getUniqueCustomers(item).length - 2 }} more customers
                      </div>
                    </div>
                  </div> -->
                </div>
                <div class="col-4 text-center">
                  
                  <div class="so-work-orders" *ngIf="getWorkOrderNumbers(item).length > 0">
                    <div class="wo-label text-uppercase small text-muted fw-bold mb-2">
                      WORK ORDER{{ getWorkOrderNumbers(item).length > 1 ? 'S' : '' }} ({{ getWorkOrderNumbers(item).length }} total)
                    </div>
                    <!-- Auto-scroll only if more than 5 work orders -->
                    <div class="wo-list" [class.auto-scroll-container]="getWorkOrderNumbers(item).length > 5">
                      <div class="scroll-content">
                        <div *ngFor="let wo of getWorkOrderNumbers(item)" class="so-item small mb-0 text-body">
                          {{ wo }}
                        </div>
                        <!-- Duplicate for seamless loop - only if scrolling -->
                        <div *ngIf="getWorkOrderNumbers(item).length > 5">
                          <div *ngFor="let wo of getWorkOrderNumbers(item)" class="so-item small mb-0 text-body">
                            {{ wo }}
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
                <div class="col-4 text-end">
                  <div class="so-quantity text-end">
                    <div class="quantity-box text-center">
                      <div class="quantity-number">{{ formatQuantity(item.totalQuantity) }}</div>
                      <div class="quantity-label">UNITS</div>
                    </div>
                  </div>
                </div>
              </div>
              

            </div>
            
            <div class="so-status mt-2" *ngIf="hasHotOrders(item.orders)">
              <span *ngIf="hasHotOrders(item.orders)" class="badge bg-warning text-body me-1">
                <i class="mdi mdi-fire"></i> Due Today
              </span>
            </div>
          </div>

          <!-- Minimal Layout -->
          <div *ngIf="cardLayout === 'minimal'" class="minimal-layout">
            <div class="text-center">
              <div class="part-number-large mb-2">
                {{ truncateText(item.partNumber, 15) }}
              </div>
              <div class="quantity-large text-primary">
                {{ formatQuantity(item.totalQuantity) }}
              </div>
               <div class="small text-muted">{{ item.orders.length }} orders</div>
            </div>
          </div>

          <!-- Compact Layout -->
          <div *ngIf="cardLayout === 'compact'" class="compact-layout">
            <!-- Summary Stats -->
            <div class="row mb-3">
              <div class="col-6">
                <div class="stat-item text-center">
                  <div class="stat-value text-primary">{{ item.orders.length }}</div>
                  <div class="stat-label">Orders</div>
                </div>
              </div>
              <div class="col-6">
                <div class="stat-item text-center">
                  <div class="stat-value text-success">{{ formatQuantity(item.totalQuantity) }}</div>
                  <div class="stat-label">Quantity</div>
                </div>
              </div>
            </div>

            <!-- Customer Info -->
            <div class="customer-info text-center mb-2">
              <small class="text-muted">
                <i class="mdi mdi-office-building me-1"></i>
                {{ truncateText(item.customerName || 'Multiple Customers', 20) }}
              </small>
            </div>
          </div>

          <!-- Detailed Layout -->
          <div *ngIf="cardLayout === 'detailed'" class="detailed-layout">
            <!-- Summary Stats -->
            <div class="row mb-3">
              <div class="col-6">
                <div class="stat-item text-center">
                  <div class="stat-value text-primary">{{ item.orders.length }}</div>
                  <div class="stat-label">Orders</div>
                </div>
              </div>
              <div class="col-6">
                <div class="stat-item text-center">
                  <div class="stat-value text-success">{{ formatQuantity(item.totalQuantity) }}</div>
                  <div class="stat-label">Quantity</div>
                </div>
              </div>
            </div>

            <!-- Orders Preview -->
            <div class="orders-preview">
              <h6 class="text-muted small mb-2">
                <i class="mdi mdi-format-list-numbered"></i>
                Recent Orders
              </h6>
              <div class="orders-list">
                <div *ngFor="let order of item.orders.slice(0, 2); let orderIndex = index" 
                     class="order-preview mb-2">
                  <div class="d-flex justify-content-between align-items-start">
                    <div class="order-info flex-grow-1">
                      <div class="order-number small fw-bold">
                        {{ order['ORDNUM'] || 'N/A' }}
                      </div>
                      <div class="order-part small text-muted">
                        {{ truncateText(order['PARTNUM'], 20) }}
                      </div>
                      <div class="order-customer small text-muted">
                        {{ truncateText(order['COMPANY'], 20) }}
                      </div>
                    </div>
                    <div class="order-actions">
                      <span class="badge bg-secondary small">
                        {{ formatQuantity(order.QTYOPEN || 0) }}
                      </span>
                      <div class="order-status-indicators mt-1">
                        <i *ngIf="order.misc?.['userName'] === 'Shipping'" 
                           class="mdi mdi-check text-success" 
                           title="Completed"></i>
                        <i *ngIf="order.misc?.hot_order" 
                           class="mdi mdi-fire text-danger ms-1" 
                           title="Hot Order"></i>
                      </div>
                    </div>
                  </div>
                </div>

                <!-- Show more indicator -->
                <div *ngIf="item.orders.length > 2" class="text-center mt-2">
                  <small class="text-muted">
                    <i class="mdi mdi-dots-horizontal"></i>
                    {{ item.orders.length - 2 }} more orders
                  </small>
                </div>
              </div>
            </div>
          </div>

          <!-- Dashboard Layout -->
          <div *ngIf="cardLayout === 'dashboard'" class="dashboard-layout">
            <!-- Key Metrics Grid -->
            <div class="metrics-grid mb-3">
              <div class="metric-item">
                <div class="metric-icon">
                  <i class="mdi mdi-format-list-numbered text-primary"></i>
                </div>
                <div class="metric-content">
                  <div class="metric-value">{{ item.orders.length }}</div>
                  <div class="metric-label">Orders</div>
                </div>
              </div>
              <div class="metric-item">
                <div class="metric-icon">
                  <i class="mdi mdi-cube-outline text-success"></i>
                </div>
                <div class="metric-content">
                  <div class="metric-value">{{ formatQuantity(item.totalQuantity) }}</div>
                  <div class="metric-label">Units</div>
                </div>
              </div>
            </div>

            <!-- Status Indicators -->
            <div class="status-grid">
              <div class="status-item" [class.active]="hasCompletedOrders(item.orders)">
                <i class="mdi mdi-check-circle"></i>
                <span>{{ hasCompletedOrders(item.orders) ? 'Completed' : 'Pending' }}</span>
              </div>
              <div class="status-item" [class.active]="hasHotOrders(item.orders)">
                <i class="mdi mdi-fire"></i>
                <span>{{ hasHotOrders(item.orders) ? 'Hot' : 'Normal' }}</span>
              </div>
            </div>

            <!-- Progress Bar -->
            <div class="progress-section mt-3">
              <div class="small text-muted mb-1">Completion Status</div>
              <div class="progress" style="height: 8px;">
                <div class="progress-bar bg-success" 
                     [style.width.%]="getCompletionPercentage(item.orders)">
                </div>
              </div>
              <div class="small text-muted mt-1">
                {{ getCompletionPercentage(item.orders) }}% Complete
              </div>
            </div>
          </div>
          
        </div>
      </div>
    </div>
  </div>

  <!-- Empty State -->
  <!-- <div *ngIf="displayedItems.length === 0" class="empty-state text-center py-5">
    <i class="mdi mdi-inbox mdi-72px text-muted mb-3"></i>
    <h4 class="text-muted">No Priority Items</h4>
    <p class="text-muted">No items are currently available for display.</p>
    <button class="btn btn-primary" (click)="onRefreshData()">
      <i class="mdi mdi-refresh"></i>
      Refresh Data
    </button>
  </div> -->

  <!-- Status Bar -->
  <!-- <div class="row mt-4" *ngIf="displayedItems.length > 0">
    <div class="col-12">
      <div class="card">
        <div class="card-body py-2">
          <div class="d-flex justify-content-between align-items-center">
            <div class="status-info">
              <small class="text-muted">
                <i class="mdi mdi-information"></i>
                Current Time: {{ currentTime }}
              </small>
            </div>
            <div class="view-stats">
              <small class="text-muted">
                Displaying {{ displayMode.toUpperCase() }} view
              </small>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div> -->
</div>