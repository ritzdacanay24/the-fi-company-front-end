<!-- Full Screen Shipping Priority Display -->
<div class="shipping-priority-container">

  <!-- Use async pipe to subscribe to the reactive data stream -->
  <ng-container *ngIf="displayData$ | async as displayData">

    <!-- Header Section -->
    <div class="priority-header">
      <div class="header-left">
        <h1 class="display-4 fw-bold text-white">
          <i class="mdi mdi-truck-fast text-primary me-3 text-white"></i>
          Production Priority Queue
        </h1>
        <p class="lead mb-0">Real-time production priority display</p>
      </div>

      <!-- Company Logo -->
      <div class="company-logo-section">
        <img src="../../../assets/images/the-fi.png" 
             alt="Business Logo" 
             class="company-logo">
      </div>

      <div class="header-right text-end">
        <div class="current-time">
          <h3 class="fw-bold mb-1">{{ currentTime }}</h3>
          <p class="mb-0 text-muted">
            <small class="text-white">
              <i class="mdi mdi-clock-outline me-1"></i>
              Updated: {{ displayData.lastUpdated }}
            </small>
          </p>
        </div>
      </div>
    </div>

    <!-- Loading Indicator (Non-blocking) -->
    <div *ngIf="displayData.isLoading" class="loading-indicator">
      <div class="d-flex align-items-center justify-content-center">
        <div class="spinner-border text-light me-2 loading-spinner" role="status">
          <span class="visually-hidden">Loading...</span>
        </div>
        <small>Refreshing data...</small>
      </div>
    </div>

    <!-- Error State -->
    <div *ngIf="displayData.hasError && !displayData.isLoading" class="error-display">
      <div class="alert alert-danger text-center">
        <i class="mdi mdi-alert-circle display-1 text-danger"></i>
        <h2 class="mt-3">{{ displayData.errorMessage }}</h2>
        <button class="btn btn-outline-danger btn-lg mt-3" (click)="refreshData()">
          <i class="mdi mdi-refresh me-2"></i>
          Retry
        </button>
      </div>
    </div>

    <!-- Main Content -->
    <div *ngIf="!displayData.hasError" class="priority-content" 
         [class.loading]="displayData.isLoading"
         [class.with-bottom-queue]="showComingUpNext && displayData.nextGroupedItems.length > 0">

      <!-- No Priority Orders -->
      <div *ngIf="!displayData.isLoading && !displayData.currentPriorityOrder && displayData.topThreePriorityOrders.length === 0"
        class="no-priorities">
        <div class="text-center">
          <i class="mdi mdi-clipboard-check display-1 text-success"></i>
          <h2 class="mt-4 text-success">All Caught Up!</h2>
          <p class="lead">No orders in the priority queue</p>
          <small class="text-muted">
            ({{ displayData.allPriorityOrders.length }} total priorities found)
          </small>
        </div>
      </div>

      <!-- Single Priority Display Mode with Sidebar Queue -->
      <app-single-priority-view 
        *ngIf="displayMode === 'single'"
        [currentGroupedItem]="displayData.currentGroupedItem"
        [nextGroupedItems]="displayData.nextGroupedItems"
        [currentTime]="currentTime"
        [lastUpdated]="displayData.lastUpdated"
        (refreshRequested)="refreshData()">
      </app-single-priority-view>

      <!-- Multi-Card Priority Display Mode (Top 3, Top 6, Grid) -->
      <app-multi-card-view 
        *ngIf="displayMode !== 'single'"
        [groupedItems]="displayData.topThreeGroupedItems"
        [displayMode]="displayMode"
        [cardLayout]="cardLayout"
        [currentTime]="currentTime"
        [lastUpdated]="displayData.lastUpdated"
        [isRefreshing]="displayData.isLoading"
        [showRefreshOverlay]="showRefreshOverlay"
        (refreshRequested)="refreshData()">
      </app-multi-card-view>

      <!-- Coming Up Next Queue - Auto-scrolling horizontal display -->
      <div *ngIf="showComingUpNext && displayData.nextGroupedItems.length > 0" class="next-orders-section fixed-bottom-queue">
        <div class="section-header">
          <h3>
            <i class="mdi mdi-format-list-numbered me-2"></i>
            Coming Up Next
          </h3>
        </div>

        <div class="d-flex align-items-center gap-3">
          <!-- FIXED NEXT CARD - First item, always visible on the left -->
          <div *ngIf="displayData.nextGroupedItems.length > 0" class="next-card-fixed">
            <div class="next-order-card next-in-line">
              <div class="card-body p-1">
                <div class="d-flex align-items-center justify-content-between mb-1">
                  <span class="order-count small">{{ displayData.nextGroupedItems[0].orders.length }} order{{ displayData.nextGroupedItems[0].orders.length > 1 ? 's' : '' }}</span>
                  <span class="badge bg-warning badge-sm text-dark fw-bold">
                    ‚≠ê NEXT
                  </span>
                </div>
                <div class="d-flex align-items-center justify-content-between mb-1">
                  <p class="part-number mb-0 text-truncate fw-bold flex-grow-1" [title]="displayData.nextGroupedItems[0].partNumber">
                    {{ displayData.nextGroupedItems[0].partNumber }}
                  </p>
                  <img *ngIf="getCustomerLogo(getPrimaryCustomer(displayData.nextGroupedItems[0]))" 
                       [src]="getCustomerLogo(getPrimaryCustomer(displayData.nextGroupedItems[0]))" 
                       [alt]="getPrimaryCustomer(displayData.nextGroupedItems[0]) + ' logo'"
                       class="inline-logo ms-2">
                </div>
                <div class="status-indicators text-center">
                  <span class="badge bg-success badge-xs me-1" *ngIf="hasCompletedOrders(displayData.nextGroupedItems[0].orders)" title="Has Completed Orders">‚úÖ</span>
                  <span class="badge bg-danger badge-xs me-1" *ngIf="hasHotOrders(displayData.nextGroupedItems[0].orders)" title="Hot Orders">üî•</span>
                  <span class="badge bg-warning badge-xs" *ngIf="hasLowInventoryOrders(displayData.nextGroupedItems[0].orders)" title="Low Inventory">‚ö†Ô∏è</span>
                </div>
              </div>
            </div>
          </div>

          <!-- CAROUSEL - Remaining items (all items including first, for continuous scrolling) -->
          <div class="slick-carousel-wrapper flex-grow-1" *ngIf="displayData.nextGroupedItems.length > 0">
            <ngx-slick-carousel 
              class="carousel" 
              [config]="slickConfig"
              (init)="onCarouselInit($event)"
              (afterChange)="onSlideChange($event)"
              #slickModal="slick-carousel">
              <!-- Duplicate items for better infinite scrolling -->
              <ng-container *ngFor="let repetition of [1,2,3]">
                <div ngxSlickItem *ngFor="let groupedItem of displayData.nextGroupedItems; let i = index" class="slide">
                  <div class="next-order-card">
                    <div class="card-body p-1">
                      <div class="d-flex align-items-center justify-content-between mb-1">
                        <span class="order-count small">{{ groupedItem.orders.length }} order{{ groupedItem.orders.length > 1 ? 's' : '' }}</span>
                        <span class="badge badge-sm bg-primary">
                          #{{ displayData.topThreeGroupedItems.length + i + 1 }}
                        </span>
                      </div>
                      <div class="d-flex align-items-center justify-content-between mb-1">
                        <p class="part-number mb-0 text-truncate fw-bold flex-grow-1" [title]="groupedItem.partNumber">{{ groupedItem.partNumber }}</p>
                        <img *ngIf="getCustomerLogo(getPrimaryCustomer(groupedItem))" 
                             [src]="getCustomerLogo(getPrimaryCustomer(groupedItem))" 
                             [alt]="getPrimaryCustomer(groupedItem) + ' logo'"
                             class="inline-logo ms-2">
                      </div>
                      <div class="status-indicators text-center">
                        <span class="badge bg-success badge-xs me-1" *ngIf="hasCompletedOrders(groupedItem.orders)" title="Has Completed Orders">‚úÖ</span>
                        <span class="badge bg-danger badge-xs me-1" *ngIf="hasHotOrders(groupedItem.orders)" title="Hot Orders">üî•</span>
                        <span class="badge bg-warning badge-xs" *ngIf="hasLowInventoryOrders(groupedItem.orders)" title="Low Inventory">‚ö†Ô∏è</span>
                      </div>
                    </div>
                  </div>
                </div>
              </ng-container>
            </ngx-slick-carousel>
          </div>
        </div>
        </div>
      </div>

      <!-- Summary Statistics -->
      <!-- <div class="summary-section mb-3">
        <div class="row g-3">
          <div class="col-lg-3 col-md-6">
            <div class="summary-card">
              <div class="d-flex align-items-center">
                <div class="summary-icon me-3">
                  <i class="mdi mdi-clock-alert text-danger"></i>
                </div>
                <div class="summary-content">
                  <h5 class="mb-1">{{ displayData.statusCount.pastDue }}</h5>
                  <p class="mb-0 small">Past Due</p>
                </div>
              </div>
            </div>
          </div>
          <div class="col-lg-3 col-md-6">
            <div class="summary-card">
              <div class="d-flex align-items-center">
                <div class="summary-icon me-3">
                  <i class="mdi mdi-clock text-warning"></i>
                </div>
                <div class="summary-content">
                  <h5 class="mb-1">{{ displayData.statusCount.todayDue }}</h5>
                  <p class="mb-0 small">Due Today</p>
                </div>
              </div>
            </div>
          </div>
          <div class="col-lg-3 col-md-6">
            <div class="summary-card">
              <div class="d-flex align-items-center">
                <div class="summary-icon me-3">
                  <i class="mdi mdi-clock-outline text-success"></i>
                </div>
                <div class="summary-content">
                  <h5 class="mb-1">{{ displayData.statusCount.futureDue }}</h5>
                  <p class="mb-0 small">Future Orders</p>
                </div>
              </div>
            </div>
          </div>
          <div class="col-lg-3 col-md-6">
            <div class="summary-card">
              <div class="d-flex align-items-center">
                <div class="summary-icon me-3">
                  <i class="mdi mdi-star text-primary"></i>
                </div>
                <div class="summary-content">
                  <h5 class="mb-1">{{ displayData.allPriorityOrders.length }}</h5>
                  <p class="mb-0 small">Priority Orders</p>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div> -->

  </ng-container>

</div>

  <!-- Floating Settings Button -->
  <button class="btn btn-primary floating-settings-btn shadow-lg" 
          (click)="openSettings()"
          title="Display Settings"
          [style]="{
            'position': 'fixed',
            'bottom': '20px',
            'right': '20px',
            'z-index': '1050',
            'width': '60px',
            'height': '60px',
            'border-radius': '50%',
            'display': 'flex',
            'align-items': 'center',
            'justify-content': 'center',
            'transition': 'all 0.3s ease',
            'animation': 'pulse 2s infinite'
          }"
          (mouseenter)="$any($event.target).style.transform = 'scale(1.1)'"
          (mouseleave)="$any($event.target).style.transform = 'scale(1)'">
    <i class="mdi mdi-cog fs-4" 
       [style]="{ 'transition': 'transform 0.3s ease' }"
       (mouseenter)="$any($event.target).style.transform = 'rotate(90deg)'"
       (mouseleave)="$any($event.target).style.transform = 'rotate(0deg)'"></i>
  </button>

<!-- Settings Offcanvas Template -->
<ng-template #settingsOffcanvas let-offcanvas>
  <app-priority-settings
    [displayMode]="displayMode"
    [refreshInterval]="refreshInterval"
    [refreshCountdown]="refreshCountdown"
    [cardLayout]="cardLayout"
    [showComingUpNext]="showComingUpNext"
    [autoScrollEnabled]="autoScrollEnabled"
    [scrollSpeed]="scrollSpeed"
    [showRefreshOverlay]="showRefreshOverlay"
    (displayModeChange)="onDisplayModeChange($event)"
    (refreshIntervalChange)="onRefreshIntervalChange($event)"
    (cardLayoutChange)="onCardLayoutChange($event)"
    (comingUpNextSettingsChange)="onComingUpNextSettingsChange($event)"
    (refreshRequested)="refreshData()"
    (settingsApplied)="onSettingsApplied($event); offcanvas.close()"
    (closed)="offcanvas.close()">
  </app-priority-settings>
</ng-template>