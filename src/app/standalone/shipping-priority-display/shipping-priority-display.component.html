<!-- Full Screen Shipping Priority Display -->
<div class="shipping-priority-container">

  <!-- Use async pipe to subscribe to the reactive data stream -->
  <ng-container *ngIf="displayData$ | async as displayData">

    <!-- Header Section -->
    <div class="priority-header">
      <div class="header-left">
        <h1 class="display-4 fw-bold text-white">
          <i class="mdi mdi-truck-fast text-primary me-3 text-white"></i>
          Shipping Priority Queue
        </h1>
        <p class="lead mb-0">Real-time shipping priority display</p>
      </div>

      <div class="header-right text-end">
        <div class="current-time">
          <h3 class="fw-bold mb-1">{{ currentTime }}</h3>
          <p class="mb-0 text-muted">
            <small class="text-white">
              <i class="mdi mdi-clock-outline me-1"></i>
              Updated: {{ displayData.lastUpdated }}
            </small>
          </p>
        </div>
      </div>
    </div>

    <!-- Loading Indicator (Non-blocking) -->
    <div *ngIf="displayData.isLoading" class="loading-indicator">
      <div class="d-flex align-items-center justify-content-center">
        <div class="spinner-border text-light me-2" style="width: 1.5rem; height: 1.5rem;" role="status">
          <span class="visually-hidden">Loading...</span>
        </div>
        <small>Refreshing data...</small>
      </div>
    </div>

    <!-- Error State -->
    <div *ngIf="displayData.hasError && !displayData.isLoading" class="error-display">
      <div class="alert alert-danger text-center">
        <i class="mdi mdi-alert-circle display-1 text-danger"></i>
        <h2 class="mt-3">{{ displayData.errorMessage }}</h2>
        <button class="btn btn-outline-danger btn-lg mt-3" (click)="refreshData()">
          <i class="mdi mdi-refresh me-2"></i>
          Retry
        </button>
      </div>
    </div>

    <!-- Main Content -->
    <div *ngIf="!displayData.hasError" class="priority-content" [class.loading]="displayData.isLoading">

      <!-- No Priority Orders -->
      <div *ngIf="!displayData.isLoading && !displayData.currentPriorityOrder && displayData.topThreePriorityOrders.length === 0"
        class="no-priorities">
        <div class="text-center">
          <i class="mdi mdi-clipboard-check display-1 text-success"></i>
          <h2 class="mt-4 text-success">All Caught Up!</h2>
          <p class="lead">No orders in the priority queue</p>
          <small class="text-muted">
            ({{ displayData.allPriorityOrders.length }} total priorities found)
          </small>
        </div>
      </div>

      <!-- Single Priority Display Mode with Sidebar Queue -->
      <div *ngIf="displayMode === 'single' && displayData.currentPriorityOrder" class="current-priority-section">
        <div class="row g-4">
          
          <!-- Main Current Priority (Left Column) -->
          <div class="col-lg-8">
            <div class="current-priority-card border shadow-sm bg-white">
              
              <!-- Clean Professional Header -->
              <div class="card-header bg-primary text-white py-3 border-0">
                <div class="d-flex align-items-center justify-content-between">
                  <div class="d-flex align-items-center">
                    <div class="me-3">
                      <i class="mdi mdi-truck-fast fs-1"></i>
                    </div>
                    <div>
                      <h3 class="mb-1 fw-bold text-white">NOW PROCESSING</h3>
                      <div class="d-flex align-items-center gap-3">
                        <span class="badge bg-light text-primary px-3 py-1 fw-bold">
                          PRIORITY #{{ displayData.currentPriorityOrder.shipping_priority }}
                        </span>
                        <small class="text-light opacity-75">
                          {{ formatDate(displayData.lastUpdated) }} • {{ currentTime }}
                        </small>
                      </div>
                    </div>
                  </div>
                  <div>
                    <span class="badge px-3 py-2" 
                         [class]="displayData.currentPriorityOrder.misc?.['userName'] !== 'Shipping' ? 'bg-warning text-dark' : 'bg-success text-white'">
                      <i class="mdi me-1" [class]="displayData.currentPriorityOrder.misc?.['userName'] !== 'Shipping' ? 'mdi-clock' : 'mdi-check-circle'"></i>
                      {{ displayData.currentPriorityOrder.misc?.['userName'] !== 'Shipping' ? 'IN PROGRESS' : 'COMPLETED' }}
                    </span>
                  </div>
                </div>
              </div>

              <!-- Warning Alert (if needed) -->
              <div class="alert alert-warning border-0 rounded-0 mb-0" 
                   *ngIf="displayData.currentPriorityOrder.SOD_PART === 'MISSING_DATA'">
                <div class="d-flex align-items-center justify-content-between">
                  <div class="d-flex align-items-center">
                    <i class="mdi mdi-alert-triangle me-2"></i>
                    <div>
                      <strong>DATA SYNCHRONIZATION ISSUE</strong>
                      <small class="d-block text-muted">Priority order exists but shipping data is unavailable</small>
                    </div>
                  </div>
                  <button class="btn btn-outline-warning btn-sm" (click)="refreshData()">
                    <i class="mdi mdi-refresh me-1"></i>RETRY
                  </button>
                </div>
              </div>

              <!-- Main Content -->
              <div class="card-body p-4">
                
                <!-- Order Number & Quantity -->
                <div class="row align-items-center mb-4 pb-3 border-bottom">
                  <div class="col-md-7">
                    <div class="small text-muted text-uppercase fw-bold mb-1">Sales Order Number</div>
                    <h1 class="display-6 fw-bold text-primary mb-0 font-monospace">
                      {{ displayData.currentPriorityOrder.SOD_NBR }}-{{ displayData.currentPriorityOrder.SOD_LINE }}
                    </h1>
                  </div>
                  <div class="col-md-5 text-center">
                    <div class="small text-muted text-uppercase fw-bold mb-1">Quantity to Ship</div>
                    <div class="display-5 fw-bold text-warning">
                      {{ formatQuantity(displayData.currentPriorityOrder.QTYOPEN || displayData.currentPriorityOrder.SOD_QTY_ORD || displayData.currentPriorityOrder.SOD_QTY_TO_SHIP) }}
                    </div>
                    <div class="small text-muted fw-bold">UNITS</div>
                  </div>
                </div>

                <!-- Information Table -->
                <table class="table table-borderless mb-0">
                  <tbody>
                    <tr>
                      <td class="py-2 text-muted text-uppercase fw-bold" style="width: 20%;">Part Number:</td>
                      <td class="py-2 font-monospace fw-bold"
                          [class]="displayData.currentPriorityOrder.SOD_PART === 'MISSING_DATA' ? 'text-danger' : 'text-dark'">
                        {{ displayData.currentPriorityOrder.SOD_PART === 'MISSING_DATA' ? 'DATA MISSING' : displayData.currentPriorityOrder.SOD_PART }}
                      </td>
                    </tr>
                    <tr>
                      <td class="py-2 text-muted text-uppercase fw-bold">Description:</td>
                      <td class="py-2 text-dark">
                        {{ truncateText(getPartDescription(displayData.currentPriorityOrder), 60) || 'Not Available' }}
                      </td>
                    </tr>
                    <tr>
                      <td class="py-2 text-muted text-uppercase fw-bold">Customer:</td>
                      <td class="py-2 fw-bold"
                          [class]="(displayData.currentPriorityOrder.SO_CUST === 'MISSING_DATA' || displayData.currentPriorityOrder.CUSTNAME === 'MISSING_DATA') ? 'text-danger' : 'text-success'">
                        {{ displayData.currentPriorityOrder.SO_CUST === 'MISSING_DATA' ? 'DATA MISSING' : (displayData.currentPriorityOrder.SO_CUST || displayData.currentPriorityOrder.CUSTNAME || 'NOT SPECIFIED') }}
                      </td>
                    </tr>
                  </tbody>
                </table>

                <!-- Critical Alerts -->
                <div class="mt-4" 
                     *ngIf="displayData.currentPriorityOrder.misc?.hot_order || (displayData.currentPriorityOrder.LD_QTY_OH && displayData.currentPriorityOrder.LD_QTY_OH < (displayData.currentPriorityOrder.QTYOPEN || 0))">
                  <div class="d-flex gap-2 flex-wrap">
                    <div class="alert alert-danger mb-0 py-2 px-3 d-flex align-items-center" 
                         *ngIf="displayData.currentPriorityOrder.misc?.hot_order">
                      <i class="mdi mdi-fire me-2"></i>
                      <strong>HOT ORDER - EXPEDITE IMMEDIATELY</strong>
                    </div>
                    <div class="alert alert-warning mb-0 py-2 px-3 d-flex align-items-center" 
                         *ngIf="displayData.currentPriorityOrder.LD_QTY_OH && displayData.currentPriorityOrder.LD_QTY_OH < (displayData.currentPriorityOrder.QTYOPEN || 0)">
                      <i class="mdi mdi-alert-triangle me-2"></i>
                      <strong>INSUFFICIENT INVENTORY</strong>
                    </div>
                  </div>
                </div>

              </div>
            </div>
          </div>

          <!-- Queue Sidebar (Right Column) -->
          <div class="col-lg-4">
            <div class="queue-sidebar">
              <div class="card border shadow-sm bg-white h-100">
                <div class="card-header bg-light border-bottom">
                  <h5 class="mb-0 fw-bold text-dark">
                    <i class="mdi mdi-format-list-numbered me-2"></i>
                    Coming Up Next
                  </h5>
                  <small class="text-muted">{{ displayData.nextPriorityOrders.length }} orders in queue</small>
                </div>
                <div class="card-body p-0" style="max-height: 600px; overflow-y: auto;">
                  
                  <!-- Queue Items -->
                  <div *ngFor="let order of displayData.nextPriorityOrders; let i = index" class="queue-item border-bottom">
                    <div class="p-3" [class.bg-light]="i % 2 === 0">
                      <div class="d-flex align-items-start justify-content-between mb-2">
                        <div class="flex-grow-1">
                          <div class="fw-bold text-dark">{{ order.SOD_NBR }}-{{ order.SOD_LINE }}</div>
                          <div class="small text-muted">Priority #{{ order.shipping_priority }}</div>
                        </div>
                        <div class="text-end">
                          <div class="fw-bold text-warning">{{ formatQuantity(order.QTYOPEN || order.SOD_QTY_ORD || order.SOD_QTY_TO_SHIP) }}</div>
                          <div class="small text-muted">units</div>
                        </div>
                      </div>
                      
                      <div class="small mb-1">
                        <strong class="text-primary">{{ order.SOD_PART }}</strong>
                      </div>
                      
                      <div class="small text-muted mb-2" [title]="getPartDescription(order)">
                        {{ truncateText(getPartDescription(order), 40) }}
                      </div>
                      
                      <div class="d-flex align-items-center justify-content-between">
                        <div class="small">
                          <i class="mdi mdi-account text-muted me-1"></i>
                          <span class="text-truncate">{{ truncateText(order.SO_CUST || order.CUSTNAME || 'N/A', 15) }}</span>
                        </div>
                        <div class="small text-muted">
                          {{ formatDate(order.SOD_DUE_DATE || order.SOD_SHIP_DATE) }}
                        </div>
                      </div>
                      
                      <!-- Status Indicators -->
                      <div class="mt-2" *ngIf="order.misc?.['userName'] === 'Shipping' || order.misc?.hot_order || (order.LD_QTY_OH && order.LD_QTY_OH < (order.QTYOPEN || 0))">
                        <div class="d-flex gap-1">
                          <span class="badge bg-success badge-sm" *ngIf="order.misc?.['userName'] === 'Shipping'">✅ DONE</span>
                          <span class="badge bg-danger badge-sm" *ngIf="order.misc?.hot_order">🔥 HOT</span>
                          <span class="badge bg-warning text-dark badge-sm" *ngIf="order.LD_QTY_OH && order.LD_QTY_OH < (order.QTYOPEN || 0)">⚠️ LOW INV</span>
                        </div>
                      </div>
                    </div>
                  </div>
                  
                  <!-- Empty State -->
                  <div *ngIf="displayData.nextPriorityOrders.length === 0" class="p-4 text-center text-muted">
                    <i class="mdi mdi-check-circle display-4 text-success"></i>
                    <div class="mt-2">Queue is empty!</div>
                  </div>
                  
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Top 3 Priority Display Mode -->
      <div *ngIf="displayMode !== 'single'" class="top3-priority-section position-relative">
        
        <!-- Global Loading Overlay for entire section -->
        <div *ngIf="displayData.isLoading" 
             class="position-absolute w-100 h-100 d-flex align-items-center justify-content-center" 
             style="background: rgba(248, 249, 250, 0.8); z-index: 20; top: 0; left: 0; min-height: 300px; backdrop-filter: blur(2px);">
          <div class="text-center">
            <div class="spinner-border text-primary mb-2" role="status">
              <span class="visually-hidden">Loading...</span>
            </div>
            <div class="text-muted small">Refreshing priority orders...</div>
          </div>
        </div>
        
        <!-- Loading State for Initial Load -->
        <div *ngIf="!displayData.isLoading && displayData.topThreePriorityOrders.length === 0" class="loading-state text-center py-5">
          <div class="text-center">
            <i class="mdi mdi-clipboard-check display-4 text-muted"></i>
            <h4 class="mt-3 text-muted">No Priority Orders</h4>
            <p class="text-muted">All orders are currently being processed</p>
          </div>
        </div>
        
        <!-- Top 3 Cards - Keep visible during refresh -->
        <div class="row g-4">
          <div class="col-lg-4 col-md-6" *ngFor="let order of displayData.topThreePriorityOrders; let i = index">
            <div class="priority-card-enterprise position-relative" [class]="getPriorityRankClass(i)">
              
              <!-- Professional Header with Gradient -->
              <div class="card-header-enterprise">
                <div class="priority-rank-indicator">
                  <span class="rank-number">{{ i + 1 }}</span>
                </div>
                <div class="header-content">
                  <h4 class="rank-title text-white">{{ getPriorityRankText(i) }}</h4>
                  <span class="priority-badge" [class]="getPriorityBadgeClass(order.shipping_priority)">
                    <i class="mdi mdi-star me-1"></i>Priority {{ order.shipping_priority }}
                  </span>
                </div>
                <div class="status-indicator">
                  <span class="status-dot" [class]="order.misc?.['userName'] === 'Shipping' ? 'completed' : 'pending'"></span>
                </div>
              </div>

              <!-- Card Body with Enhanced Layout -->
              <div class="card-body-enterprise">
                <!-- Order Header -->
                <div class="order-header-section">
                  <div class="order-number-display-warehouse">
                    <span class="order-label-warehouse">Sales Order</span>
                    <h1 class="order-number-warehouse">{{ order.SOD_NBR }}-{{ order.SOD_LINE }}</h1>
                  </div>
                </div>
                
                <!-- Primary Information Grid -->
                <div class="info-grid">
                  <div class="info-section part-section">
                    <div class="info-label">
                      <i class="mdi mdi-package-variant me-1"></i>Part Number
                    </div>
                    <div class="part-number-display" [title]="order.SOD_PART">
                      {{ order.SOD_PART }}
                    </div>
                    <div class="part-description" [title]="getPartDescription(order)">
                      {{ truncateText(getPartDescription(order), 40) }}
                    </div>
                  </div>
                  
                  <div class="info-section quantity-section">
                    <div class="info-label">
                      <i class="mdi mdi-cube-outline me-1"></i>Quantity
                    </div>
                    <div class="quantity-display-enterprise">
                      <span class="quantity-number">{{ formatQuantity(order.QTYOPEN || order.SOD_QTY_ORD || order.SOD_QTY_TO_SHIP) }}</span>
                      <span class="quantity-unit">units</span>
                    </div>
                  </div>
                </div>

                <!-- Secondary Information -->
                <div class="secondary-info-grid">
                  <div class="info-item">
                    <div class="info-icon">
                      <i class="mdi mdi-account-outline"></i>
                    </div>
                    <div class="info-content">
                      <div class="info-label-small">Customer</div>
                      <div class="info-value" [title]="order.SO_CUST || order.CUSTNAME || 'N/A'">
                        {{ truncateText(order.SO_CUST || order.CUSTNAME || 'N/A', 20) }}
                      </div>
                    </div>
                  </div>
                </div>
                
                <!-- Status Badge Section -->
                <div class="status-badge-section">
                  <span [class]="getStatusBadgeClass(order.STATUS)" class="status-badge-enterprise">
                    <i class="mdi mdi-information-outline me-1"></i>{{ order.STATUS }}
                  </span>
                </div>

                <!-- Critical Alerts -->
                <div class="alerts-section"
                  *ngIf="order.misc?.hot_order || (order.LD_QTY_OH && order.LD_QTY_OH < (order.QTYOPEN || 0)) || order.misc?.['userName'] === 'Shipping'">
                  <div class="alert-badges">
                    <span class="alert-badge completed" *ngIf="order.misc?.['userName'] === 'Shipping'" title="Completed - Shipped">
                      <i class="mdi mdi-check-circle-outline"></i>
                      <span>Completed</span>
                    </span>
                    <span class="alert-badge hot" *ngIf="order.misc?.hot_order" title="Hot Order - Expedite">
                      <i class="mdi mdi-fire"></i>
                      <span>Hot Order</span>
                    </span>
                    <span class="alert-badge warning" *ngIf="order.LD_QTY_OH && order.LD_QTY_OH < (order.QTYOPEN || 0)" title="Insufficient Inventory">
                      <i class="mdi mdi-alert-circle-outline"></i>
                      <span>Low Inventory</span>
                    </span>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Next Orders Queue - Hidden in single mode (now using sidebar) -->
      <div *ngIf="displayMode !== 'single' && displayData.nextPriorityOrders.length > 0" class="next-orders-section">
        <div class="section-header">
          <h3>
            <i class="mdi mdi-format-list-numbered me-2"></i>
            Coming Up Next
          </h3>
        </div>

        <div class="next-orders-scroll-container">
          <div class="next-orders-horizontal" *ngFor="let order of displayData.nextPriorityOrders; let i = index">
            <div class="next-order-card">
              <div class="card-body p-3">
                <div class="d-flex align-items-center justify-content-between mb-2">
                  <span class="order-number small">{{ order.SOD_NBR }}-{{ order.SOD_LINE }}</span>
                  <span [class]="getPriorityBadgeClass(order.shipping_priority)" class="badge-sm">
                    #{{ order.shipping_priority }}
                  </span>
                </div>
                <p class="part-number mb-1 text-truncate" [title]="order.SOD_PART">{{ order.SOD_PART }}</p>
                <p class="customer small text-muted mb-1 text-truncate"
                  [title]="order.SO_CUST || order.CUSTNAME || 'N/A'">
                  {{ order.SO_CUST || order.CUSTNAME || 'N/A' }}
                </p>
                <div class="d-flex align-items-center justify-content-between">
                  <small class="text-muted">{{ formatQuantity(order.QTYOPEN || order.SOD_QTY_ORD ||
                    order.SOD_QTY_TO_SHIP) }} open</small>
                  <div class="status-indicators">
                    <span class="badge bg-success badge-xs" *ngIf="order.misc?.['userName'] === 'Shipping'" title="Completed">✅</span>
                    <span class="badge bg-danger badge-xs" *ngIf="order.misc?.hot_order" title="Hot Order">🔥</span>
                    <span class="badge bg-warning badge-xs"
                      *ngIf="order.LD_QTY_OH && order.LD_QTY_OH < (order.QTYOPEN || 0)" title="Low Inventory">⚠️</span>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Summary Statistics -->
      <!-- <div class="summary-section mb-3">
        <div class="row g-3">
          <div class="col-lg-3 col-md-6">
            <div class="summary-card">
              <div class="d-flex align-items-center">
                <div class="summary-icon me-3">
                  <i class="mdi mdi-clock-alert text-danger"></i>
                </div>
                <div class="summary-content">
                  <h5 class="mb-1">{{ displayData.statusCount.pastDue }}</h5>
                  <p class="mb-0 small">Past Due</p>
                </div>
              </div>
            </div>
          </div>
          <div class="col-lg-3 col-md-6">
            <div class="summary-card">
              <div class="d-flex align-items-center">
                <div class="summary-icon me-3">
                  <i class="mdi mdi-clock text-warning"></i>
                </div>
                <div class="summary-content">
                  <h5 class="mb-1">{{ displayData.statusCount.todayDue }}</h5>
                  <p class="mb-0 small">Due Today</p>
                </div>
              </div>
            </div>
          </div>
          <div class="col-lg-3 col-md-6">
            <div class="summary-card">
              <div class="d-flex align-items-center">
                <div class="summary-icon me-3">
                  <i class="mdi mdi-clock-outline text-success"></i>
                </div>
                <div class="summary-content">
                  <h5 class="mb-1">{{ displayData.statusCount.futureDue }}</h5>
                  <p class="mb-0 small">Future Orders</p>
                </div>
              </div>
            </div>
          </div>
          <div class="col-lg-3 col-md-6">
            <div class="summary-card">
              <div class="d-flex align-items-center">
                <div class="summary-icon me-3">
                  <i class="mdi mdi-star text-primary"></i>
                </div>
                <div class="summary-content">
                  <h5 class="mb-1">{{ displayData.allPriorityOrders.length }}</h5>
                  <p class="mb-0 small">Priority Orders</p>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div> -->
    </div>

    <!-- Controls Section -->
    <div class="controls-section">
      <div class="d-flex align-items-center justify-content-center gap-3">
        <!-- Display Mode Toggle -->
        <button class="btn btn-outline-light" (click)="toggleDisplayMode()">
          <i class="mdi mdi-view-{{ displayMode === 'single' ? 'grid' : 'sequential' }} me-2"></i>
          {{ displayMode === 'single' ? 'Show Top 3' : 'Single View' }}
        </button>
        <button class="btn btn-outline-light" (click)="refreshData()">
          <i class="mdi mdi-refresh me-2"></i>
          Refresh Data
        </button>
        <button class="btn btn-outline-light" (click)="goToDashboard()">
          <i class="mdi mdi-arrow-left me-2"></i>
          Back to Dashboard
        </button>
        <small class="text-muted">Press <kbd>Space</kbd> to toggle display mode</small>
      </div>
    </div>

  </ng-container>

</div>