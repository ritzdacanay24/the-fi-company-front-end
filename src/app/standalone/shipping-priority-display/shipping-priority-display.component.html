<!-- Full Screen Shipping Priority Display -->
<div class="shipping-priority-container">

  <!-- Use async pipe to subscribe to the reactive data stream -->
  <ng-container *ngIf="displayData$ | async as displayData">

    <!-- Header Section -->
    <div class="priority-header">
      <div class="header-left">
        <h1 class="display-4 fw-bold">
          <i class="mdi mdi-truck-fast text-primary me-3"></i>
          Shipping Priority Queue
        </h1>
        <p class="lead mb-0">Real-time shipping priority display</p>
      </div>

      <div class="header-right text-end">
        <div class="current-time">
          <h3 class="fw-bold mb-1">{{ currentTime }}</h3>
          <p class="mb-0 text-muted">
            <small>
              <i class="mdi mdi-clock-outline me-1"></i>
              Updated: {{ displayData.lastUpdated }}
            </small>
          </p>
        </div>
      </div>
    </div>

    <!-- Loading Indicator (Non-blocking) -->
    <div *ngIf="displayData.isLoading" class="loading-indicator">
      <div class="d-flex align-items-center justify-content-center">
        <div class="spinner-border text-light me-2" style="width: 1.5rem; height: 1.5rem;" role="status">
          <span class="visually-hidden">Loading...</span>
        </div>
        <small>Refreshing data...</small>
      </div>
    </div>

    <!-- Error State -->
    <div *ngIf="displayData.hasError && !displayData.isLoading" class="error-display">
      <div class="alert alert-danger text-center">
        <i class="mdi mdi-alert-circle display-1 text-danger"></i>
        <h2 class="mt-3">{{ displayData.errorMessage }}</h2>
        <button class="btn btn-outline-danger btn-lg mt-3" (click)="refreshData()">
          <i class="mdi mdi-refresh me-2"></i>
          Retry
        </button>
      </div>
    </div>

    <!-- Main Content -->
    <div *ngIf="!displayData.hasError" class="priority-content" [class.loading]="displayData.isLoading">

      <!-- No Priority Orders -->
      <div *ngIf="!displayData.currentPriorityOrder && displayData.topThreePriorityOrders.length === 0"
        class="no-priorities">
        <div class="text-center">
          <i class="mdi mdi-clipboard-check display-1 text-success"></i>
          <h2 class="mt-4 text-success">All Caught Up!</h2>
          <p class="lead">No orders in the priority queue</p>
          <small class="text-muted">
            ({{ displayData.allPriorityOrders.length }} total priorities found)
          </small>
        </div>
      </div>

      <!-- Single Priority Display Mode -->
      <div *ngIf="displayMode === 'single' && displayData.currentPriorityOrder" class="current-priority-section">
        <div class="row justify-content-center">
          <div class="col-lg-8 col-xl-6">
            <div class="current-priority-card">
              <div class="card-header">
                <div class="d-flex align-items-center justify-content-between">
                  <div>
                    <h3 class="fw-bold mb-1">
                      <i class="mdi mdi-star text-warning me-2"></i>
                      NOW PROCESSING
                    </h3>
                    <p class="mb-0 text-muted">Priority #{{ displayData.currentPriorityOrder.shipping_priority }}</p>
                  </div>
                  <div class="priority-badge">
                    <span [class]="getPriorityBadgeClass(displayData.currentPriorityOrder.shipping_priority)">
                      Priority {{ displayData.currentPriorityOrder.shipping_priority }}
                    </span>
                  </div>
                </div>
              </div>

              <div class="card-body">
                <!-- Missing Data Warning -->
                <div class="alert alert-warning mb-3 d-flex align-items-center justify-content-between"
                  *ngIf="displayData.currentPriorityOrder.SOD_PART === 'MISSING_DATA'">
                  <div>
                    <i class="mdi mdi-alert-triangle me-2"></i>
                    <strong>Data Sync Issue:</strong> This priority order exists but shipping data is not available.
                    Please check data synchronization.
                  </div>
                  <button class="btn btn-sm btn-outline-warning" (click)="refreshData()">
                    <i class="mdi mdi-refresh me-1"></i>
                    Retry
                  </button>
                </div>

                <!-- Essential Info Only -->
                <div class="text-center">
                  <h2 class="order-number mb-4">{{ displayData.currentPriorityOrder.SOD_NBR }}-{{ displayData.currentPriorityOrder.SOD_LINE }}</h2>
                  
                  <!-- Main Info Row -->
                  <div class="row g-4 mb-4">
                    <div class="col-lg-6">
                      <div class="essential-detail">
                        <h5 class="text-primary mb-2">Part Number</h5>
                        <p class="fw-bold fs-4 mb-1"
                          [class]="displayData.currentPriorityOrder.SOD_PART === 'MISSING_DATA' ? 'text-danger' : ''"
                          [title]="displayData.currentPriorityOrder.SOD_PART">
                          {{ displayData.currentPriorityOrder.SOD_PART === 'MISSING_DATA' ? 'Data Missing' : displayData.currentPriorityOrder.SOD_PART }}
                        </p>
                        <p class="text-muted mb-0"
                          [title]="getPartDescription(displayData.currentPriorityOrder)">
                          {{ truncateText(getPartDescription(displayData.currentPriorityOrder), 50) }}
                        </p>
                      </div>
                    </div>
                    <div class="col-lg-6">
                      <div class="essential-detail">
                        <h5 class="text-warning mb-2">Quantity to Ship</h5>
                        <p class="fw-bold display-4 mb-0 text-warning">
                          {{ formatQuantity(displayData.currentPriorityOrder.QTYOPEN || displayData.currentPriorityOrder.SOD_QTY_ORD || displayData.currentPriorityOrder.SOD_QTY_TO_SHIP) }}
                        </p>
                      </div>
                    </div>
                  </div>

                  <!-- Secondary Info Row -->
                  <div class="row g-3">
                    <div class="col-md-4">
                      <div class="essential-detail">
                        <h6 class="text-info mb-1">Work Order</h6>
                        <p class="fw-bold mb-0"
                          [class]="getWorkOrderDisplay(displayData.currentPriorityOrder) === 'N/A' ? 'text-muted' : 'text-info'">
                          {{ getWorkOrderDisplay(displayData.currentPriorityOrder) }}
                        </p>
                      </div>
                    </div>
                    <div class="col-md-4">
                      <div class="essential-detail">
                        <h6 class="text-success mb-1">Customer</h6>
                        <p class="fw-bold mb-0"
                          [class]="(displayData.currentPriorityOrder.SO_CUST === 'MISSING_DATA' || displayData.currentPriorityOrder.CUSTNAME === 'MISSING_DATA') ? 'text-danger' : ''">
                          {{ displayData.currentPriorityOrder.SO_CUST === 'MISSING_DATA' ? 'Data Missing' : (displayData.currentPriorityOrder.SO_CUST || displayData.currentPriorityOrder.CUSTNAME || 'N/A') }}
                        </p>
                      </div>
                    </div>
                    <div class="col-md-4">
                      <div class="essential-detail">
                        <h6 class="text-secondary mb-1">Due Date</h6>
                        <p class="fw-bold mb-0">
                          {{ formatDate(displayData.currentPriorityOrder.SOD_DUE_DATE || displayData.currentPriorityOrder.SOD_SHIP_DATE) }}
                        </p>
                      </div>
                    </div>
                  </div>
                </div>

                <!-- Critical Alerts Only -->
                <div class="row mt-4"
                  *ngIf="displayData.currentPriorityOrder.misc?.hot_order || (displayData.currentPriorityOrder.LD_QTY_OH && displayData.currentPriorityOrder.LD_QTY_OH < (displayData.currentPriorityOrder.QTYOPEN || 0))">
                  <div class="col-12">
                    <div class="alert-section">
                      <div class="d-flex gap-2 align-items-center justify-content-center">
                        <span class="badge bg-danger fs-6 px-3 py-2" *ngIf="displayData.currentPriorityOrder.misc?.hot_order">
                          <i class="mdi mdi-fire me-1"></i>HOT ORDER
                        </span>
                        <span class="badge bg-warning text-dark fs-6 px-3 py-2"
                          *ngIf="displayData.currentPriorityOrder.LD_QTY_OH && displayData.currentPriorityOrder.LD_QTY_OH < (displayData.currentPriorityOrder.QTYOPEN || 0)">
                          <i class="mdi mdi-alert me-1"></i>LOW INVENTORY
                        </span>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Top 3 Priority Display Mode -->
      <div *ngIf="displayMode !== 'single' && displayData.topThreePriorityOrders.length > 0"
        class="top3-priority-section">
        <div class="row g-3">
          <div class="col-lg-4 col-md-6" *ngFor="let order of displayData.topThreePriorityOrders; let i = index">
            <div class="priority-card" [class]="getPriorityRankClass(i)">
              <div class="card-header">
                <div class="d-flex align-items-center justify-content-between">
                  <h4 class="rank-title mb-0">{{ getPriorityRankText(i) }}</h4>
                  <span [class]="getPriorityBadgeClass(order.shipping_priority)" class="small">
                    Priority {{ order.shipping_priority }}
                  </span>
                </div>
              </div>

              <div class="card-body">
                <h5 class="order-number mb-3">{{ order.SOD_NBR }}-{{ order.SOD_LINE }}</h5>
                
                <!-- Primary Info -->
                <div class="mb-3">
                  <div class="part-info mb-2">
                    <p class="part-number mb-1" [title]="order.SOD_PART">
                      <strong class="text-primary">{{ order.SOD_PART }}</strong>
                    </p>
                    <p class="part-description small text-muted mb-0" [title]="getPartDescription(order)">
                      {{ truncateText(getPartDescription(order), 35) }}
                    </p>
                  </div>
                  
                  <div class="quantity-display text-center py-2">
                    <span class="fw-bold fs-3 text-warning">{{ formatQuantity(order.QTYOPEN || order.SOD_QTY_ORD || order.SOD_QTY_TO_SHIP) }}</span>
                    <small class="text-muted d-block">units to ship</small>
                  </div>
                </div>

                <!-- Secondary Info -->
                <div class="secondary-info">
                  <div class="row g-2 small">
                    <div class="col-6">
                      <i class="mdi mdi-account text-muted"></i>
                      <span class="text-truncate" [title]="order.SO_CUST || order.CUSTNAME || 'N/A'">
                        {{ truncateText(order.SO_CUST || order.CUSTNAME || 'N/A', 12) }}
                      </span>
                    </div>
                    <div class="col-6">
                      <i class="mdi mdi-wrench text-muted"></i>
                      <span class="text-truncate" [title]="getWorkOrderDisplay(order)">
                        {{ truncateText(getWorkOrderDisplay(order), 12) }}
                      </span>
                    </div>
                  </div>
                  
                  <div class="due-date text-center mt-2">
                    <small class="text-muted">
                      <i class="mdi mdi-calendar me-1"></i>Due: {{ formatDate(order.SOD_DUE_DATE || order.SOD_SHIP_DATE) }}
                    </small>
                  </div>
                  
                  <!-- Status Badge -->
                  <div class="text-center mt-2">
                    <span [class]="getStatusBadgeClass(order.STATUS)" class="badge">{{ order.STATUS }}</span>
                  </div>
                </div>

                <!-- Critical Alerts -->
                <div class="essential-badges mt-3 text-center"
                  *ngIf="order.misc?.hot_order || (order.LD_QTY_OH && order.LD_QTY_OH < (order.QTYOPEN || 0))">
                  <span class="badge bg-danger me-1" *ngIf="order.misc?.hot_order" title="Hot Order">
                    <i class="mdi mdi-fire"></i> HOT
                  </span>
                  <span class="badge bg-warning text-dark"
                    *ngIf="order.LD_QTY_OH && order.LD_QTY_OH < (order.QTYOPEN || 0)" title="Insufficient Inventory">
                    <i class="mdi mdi-alert"></i> LOW INV
                  </span>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Next Orders Queue -->
      <div *ngIf="displayData.nextPriorityOrders.length > 0" class="next-orders-section">
        <div class="section-header">
          <h3>
            <i class="mdi mdi-format-list-numbered me-2"></i>
            Coming Up Next
          </h3>
        </div>

        <div class="next-orders-scroll-container">
          <div class="next-orders-horizontal" *ngFor="let order of displayData.nextPriorityOrders; let i = index">
            <div class="next-order-card">
              <div class="card-body p-3">
                <div class="d-flex align-items-center justify-content-between mb-2">
                  <span class="order-number small">{{ order.SOD_NBR }}-{{ order.SOD_LINE }}</span>
                  <span [class]="getPriorityBadgeClass(order.shipping_priority)" class="badge-sm">
                    #{{ order.shipping_priority }}
                  </span>
                </div>
                <p class="part-number mb-1 text-truncate" [title]="order.SOD_PART">{{ order.SOD_PART }}</p>
                <p class="customer small text-muted mb-1 text-truncate"
                  [title]="order.SO_CUST || order.CUSTNAME || 'N/A'">
                  {{ order.SO_CUST || order.CUSTNAME || 'N/A' }}
                </p>
                <div class="d-flex align-items-center justify-content-between">
                  <small class="text-muted">{{ formatQuantity(order.QTYOPEN || order.SOD_QTY_ORD ||
                    order.SOD_QTY_TO_SHIP) }} open</small>
                  <div class="status-indicators">
                    <span class="badge bg-danger badge-xs" *ngIf="order.misc?.hot_order" title="Hot Order">🔥</span>
                    <span class="badge bg-warning badge-xs"
                      *ngIf="order.LD_QTY_OH && order.LD_QTY_OH < (order.QTYOPEN || 0)" title="Low Inventory">⚠️</span>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Summary Statistics -->
      <div class="summary-section mb-3">
        <div class="row g-3">
          <div class="col-lg-3 col-md-6">
            <div class="summary-card">
              <div class="d-flex align-items-center">
                <div class="summary-icon me-3">
                  <i class="mdi mdi-clock-alert text-danger"></i>
                </div>
                <div class="summary-content">
                  <h5 class="mb-1">{{ displayData.statusCount.pastDue }}</h5>
                  <p class="mb-0 small">Past Due</p>
                </div>
              </div>
            </div>
          </div>
          <div class="col-lg-3 col-md-6">
            <div class="summary-card">
              <div class="d-flex align-items-center">
                <div class="summary-icon me-3">
                  <i class="mdi mdi-clock text-warning"></i>
                </div>
                <div class="summary-content">
                  <h5 class="mb-1">{{ displayData.statusCount.todayDue }}</h5>
                  <p class="mb-0 small">Due Today</p>
                </div>
              </div>
            </div>
          </div>
          <div class="col-lg-3 col-md-6">
            <div class="summary-card">
              <div class="d-flex align-items-center">
                <div class="summary-icon me-3">
                  <i class="mdi mdi-clock-outline text-success"></i>
                </div>
                <div class="summary-content">
                  <h5 class="mb-1">{{ displayData.statusCount.futureDue }}</h5>
                  <p class="mb-0 small">Future Orders</p>
                </div>
              </div>
            </div>
          </div>
          <div class="col-lg-3 col-md-6">
            <div class="summary-card">
              <div class="d-flex align-items-center">
                <div class="summary-icon me-3">
                  <i class="mdi mdi-star text-primary"></i>
                </div>
                <div class="summary-content">
                  <h5 class="mb-1">{{ displayData.allPriorityOrders.length }}</h5>
                  <p class="mb-0 small">Priority Orders</p>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Controls Section -->
    <div class="controls-section">
      <div class="d-flex align-items-center justify-content-center gap-3">
        <!-- Display Mode Toggle -->
        <button class="btn btn-outline-light" (click)="toggleDisplayMode()">
          <i class="mdi mdi-view-{{ displayMode === 'single' ? 'grid' : 'sequential' }} me-2"></i>
          {{ displayMode === 'single' ? 'Show Top 3' : 'Single View' }}
        </button>
        <button class="btn btn-outline-light" (click)="refreshData()">
          <i class="mdi mdi-refresh me-2"></i>
          Refresh Data
        </button>
        <button class="btn btn-outline-light" (click)="goToDashboard()">
          <i class="mdi mdi-arrow-left me-2"></i>
          Back to Dashboard
        </button>
        <small class="text-muted">Press <kbd>Space</kbd> to toggle display mode</small>
      </div>
    </div>

  </ng-container>

</div>