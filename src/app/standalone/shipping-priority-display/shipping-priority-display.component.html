<!-- Full Screen Shipping Priority Display -->
<div class="shipping-priority-container">

  <!-- Use async pipe to subscribe to the reactive data stream -->
  <ng-container *ngIf="displayData$ | async as displayData">

    <!-- Header Section -->
    <div class="priority-header">
      <div class="header-left">
        <h1 class="display-4 fw-bold text-white">
          <i class="mdi mdi-truck-fast text-primary me-3 text-white"></i>
          Production Priority Queue
        </h1>
        <p class="lead mb-0">Real-time production priority display</p>
      </div>

      <!-- Company Logo -->
      <div class="company-logo-section">
        <img src="../../../assets/images/the-fi.png" 
             alt="Business Logo" 
             class="company-logo">
      </div>

      <div class="header-right text-end">
        <div class="current-time">
          <h3 class="fw-bold mb-1">{{ currentTime }}</h3>
          <p class="mb-0 text-muted">
            <small class="text-white">
              <i class="mdi mdi-clock-outline me-1"></i>
              Updated: {{ displayData.lastUpdated }}
            </small>
          </p>
        </div>
      </div>
    </div>

    <!-- Loading Indicator (Non-blocking) -->
    <div *ngIf="displayData.isLoading" class="loading-indicator">
      <div class="d-flex align-items-center justify-content-center">
        <div class="spinner-border text-light me-2" style="width: 1.5rem; height: 1.5rem;" role="status">
          <span class="visually-hidden">Loading...</span>
        </div>
        <small>Refreshing data...</small>
      </div>
    </div>

    <!-- Error State -->
    <div *ngIf="displayData.hasError && !displayData.isLoading" class="error-display">
      <div class="alert alert-danger text-center">
        <i class="mdi mdi-alert-circle display-1 text-danger"></i>
        <h2 class="mt-3">{{ displayData.errorMessage }}</h2>
        <button class="btn btn-outline-danger btn-lg mt-3" (click)="refreshData()">
          <i class="mdi mdi-refresh me-2"></i>
          Retry
        </button>
      </div>
    </div>

    <!-- Main Content -->
    <div *ngIf="!displayData.hasError" class="priority-content" 
         [class.loading]="displayData.isLoading">

      <!-- No Priority Orders -->
      <div *ngIf="!displayData.isLoading && !displayData.currentPriorityOrder && displayData.topThreePriorityOrders.length === 0"
        class="no-priorities">
        <div class="text-center">
          <i class="mdi mdi-clipboard-check display-1 text-success"></i>
          <h2 class="mt-4 text-success">All Caught Up!</h2>
          <p class="lead">No orders in the priority queue</p>
          <small class="text-muted">
            ({{ displayData.allPriorityOrders.length }} total priorities found)
          </small>
        </div>
      </div>

      <!-- Single Priority Display Mode with Sidebar Queue -->
      <app-single-priority-view 
        *ngIf="displayMode === 'single'"
        [currentGroupedItem]="displayData.currentGroupedItem"
        [nextGroupedItems]="displayData.nextGroupedItems"
        [currentTime]="currentTime"
        [lastUpdated]="displayData.lastUpdated"
        (refreshRequested)="refreshData()">
      </app-single-priority-view>

      <!-- Multi-Card Priority Display Mode (Top 3, Top 6, Grid) -->
      <app-multi-card-view 
        *ngIf="displayMode !== 'single'"
        [groupedItems]="displayData.topThreeGroupedItems"
        [displayMode]="displayMode"
        [cardLayout]="cardLayout"
        [currentTime]="currentTime"
        [lastUpdated]="displayData.lastUpdated"
        [isRefreshing]="displayData.isLoading"
        [showRefreshOverlay]="showRefreshOverlay"
        (refreshRequested)="refreshData()">
      </app-multi-card-view>

      <!-- Summary Statistics -->
      <!-- <div class="summary-section mb-3">
        <div class="row g-3">
          <div class="col-lg-3 col-md-6">
            <div class="summary-card">
              <div class="d-flex align-items-center">
                <div class="summary-icon me-3">
                  <i class="mdi mdi-clock-alert text-danger"></i>
                </div>
                <div class="summary-content">
                  <h5 class="mb-1">{{ displayData.statusCount.pastDue }}</h5>
                  <p class="mb-0 small">Past Due</p>
                </div>
              </div>
            </div>
          </div>
          <div class="col-lg-3 col-md-6">
            <div class="summary-card">
              <div class="d-flex align-items-center">
                <div class="summary-icon me-3">
                  <i class="mdi mdi-clock text-warning"></i>
                </div>
                <div class="summary-content">
                  <h5 class="mb-1">{{ displayData.statusCount.todayDue }}</h5>
                  <p class="mb-0 small">Due Today</p>
                </div>
              </div>
            </div>
          </div>
          <div class="col-lg-3 col-md-6">
            <div class="summary-card">
              <div class="d-flex align-items-center">
                <div class="summary-icon me-3">
                  <i class="mdi mdi-clock-outline text-success"></i>
                </div>
                <div class="summary-content">
                  <h5 class="mb-1">{{ displayData.statusCount.futureDue }}</h5>
                  <p class="mb-0 small">Future Orders</p>
                </div>
              </div>
            </div>
          </div>
          <div class="col-lg-3 col-md-6">
            <div class="summary-card">
              <div class="d-flex align-items-center">
                <div class="summary-icon me-3">
                  <i class="mdi mdi-star text-primary"></i>
                </div>
                <div class="summary-content">
                  <h5 class="mb-1">{{ displayData.allPriorityOrders.length }}</h5>
                  <p class="mb-0 small">Priority Orders</p>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div> -->
    </div>

  </ng-container>

</div>

  <!-- Floating Settings Button -->
  <button class="btn btn-primary floating-settings-btn shadow-lg" 
          (click)="openSettings()"
          title="Display Settings"
          [style]="{
            'position': 'fixed',
            'bottom': '20px',
            'right': '20px',
            'z-index': '1050',
            'width': '60px',
            'height': '60px',
            'border-radius': '50%',
            'display': 'flex',
            'align-items': 'center',
            'justify-content': 'center',
            'transition': 'all 0.3s ease',
            'animation': 'pulse 2s infinite'
          }"
          (mouseenter)="$any($event.target).style.transform = 'scale(1.1)'"
          (mouseleave)="$any($event.target).style.transform = 'scale(1)'">
    <i class="mdi mdi-cog fs-4" 
       [style]="{ 'transition': 'transform 0.3s ease' }"
       (mouseenter)="$any($event.target).style.transform = 'rotate(90deg)'"
       (mouseleave)="$any($event.target).style.transform = 'rotate(0deg)'"></i>
  </button>

<!-- Settings Offcanvas Template -->
<ng-template #settingsOffcanvas let-offcanvas>
  <app-priority-settings
    [displayMode]="displayMode"
    [refreshInterval]="refreshInterval"
    [refreshCountdown]="refreshCountdown"
    [cardLayout]="cardLayout"
    [showComingUpNext]="showComingUpNext"
    [autoScrollEnabled]="autoScrollEnabled"
    [scrollSpeed]="scrollSpeed"
    [showRefreshOverlay]="showRefreshOverlay"
    (displayModeChange)="onDisplayModeChange($event)"
    (refreshIntervalChange)="onRefreshIntervalChange($event)"
    (cardLayoutChange)="onCardLayoutChange($event)"
    (comingUpNextSettingsChange)="onComingUpNextSettingsChange($event)"
    (refreshRequested)="refreshData()"
    (settingsApplied)="onSettingsApplied($event); offcanvas.close()"
    (closed)="offcanvas.close()">
  </app-priority-settings>
</ng-template>