<div class="modal-header bg-primary bg-gradient border-bottom border-none position-relative overflow-hidden">
  <h5 class="modal-title text-white d-flex align-items-center">
    <span class="bg-white bg-opacity-10 rounded-circle d-flex align-items-center justify-content-center me-3"
      style="width: 2.5rem; height: 2.5rem;">
      <i class="mdi mdi-receipt fs-4 text-white"></i>
    </span>
    {{id ? 'Edit' : 'Add'}} Receipt
  </h5>
  <!-- Transparent decorative icon on the right -->
  <div class="position-absolute" style="top: -20px; right: -20px; opacity: 0.1;">
    <i class="mdi mdi-receipt" style="font-size: 8rem; transform: rotate(15deg);"></i>
  </div>
  
  <div class="d-flex align-items-center gap-3 ms-auto">
    <div class="form-check form-switch form-switch-md">
      <input class="form-check-input" type="checkbox" id="flexSwitchCheckDefault" [(ngModel)]="autoExtract">
      <label class="form-check-label text-white small" for="flexSwitchCheckDefault">Auto Extract</label>
    </div>
    <button type="button" class="btn-close btn-close-white position-relative" style="z-index: 1;" (click)="dismiss()" aria-label="Close"></button>
  </div>
</div>

<div class="modal-body">
  <form [formGroup]="form">
    <!-- Image Preview Section -->
    <div class="text-center mb-4" *ngIf="url || link">
      <div class="card border-2 border-dashed border-primary rounded p-3" style="max-width: 200px; margin: 0 auto;">
        <img class="img-fluid rounded" style="max-height: 150px; width: auto;" 
             [errorImage]="'assets/images/no-image.PNG'"cx s
             [defaultImage]="'assets/images/loading.PNG'" 
             [lazyLoad]="url || link">
        <div class="mt-2" *ngIf="link">
          <a [href]="link" target="_blank" class="btn btn-sm btn-outline-primary">
            <i class="mdi mdi-open-in-new me-1"></i>View Full Size
          </a>
        </div>
      </div>
      <div class="mt-3" *ngIf="link">
        <button type="button" class="btn btn-sm btn-outline-danger" (click)="removeImage()">
          <i class="mdi mdi-delete me-1"></i>Remove Image
        </button>
      </div>
    </div>

    <!-- Upload Section -->
    <div class="text-center mb-4" *ngIf="!url && !link">
      <div class="card border-2 border-dashed border-secondary rounded p-4">
        <i class="mdi mdi-cloud-upload text-muted mb-2" style="font-size: 2rem;"></i>
        <h6 class="text-muted">Upload Receipt</h6>
        <p class="text-muted small mb-0">Choose from library or take a photo</p>
      </div>
    </div>

    <!-- Alert Messages -->
    <div class="alert alert-danger border-0" role="alert" *ngIf="receiptMessage">
      <i class="mdi mdi-alert me-2"></i>
      {{receiptMessage}}
    </div>

    <div *ngIf="isLoading" class="text-center py-4">
      <div class="spinner-border text-primary mb-3" role="status">
        <span class="visually-hidden">Loading...</span>
      </div>
      <h6 class="text-muted">Processing... Please wait</h6>
    </div>

    <!-- Upload Buttons -->
    <div class="row mb-4">
      <div class="col-12">
        <div class="d-flex gap-2 justify-content-center">
          <label class="btn btn-outline-primary flex-fill" for="folder" style="max-width: 200px;">
            <input type="file" class="d-none" accept="image/*" id="folder"
              (change)="handleFileInput($any($event.target).files)">
            <i class="mdi mdi-folder me-2"></i>From Library
          </label>
          <label class="btn btn-primary flex-fill" for="front" style="max-width: 200px;">
            <input capture="environment" type="file" accept="image/*" class="d-none" id="front"
              (change)="handleFileInput($any($event.target).files)">
            <i class="mdi mdi-camera me-2"></i>Take Photo
          </label>
        </div>
      </div>
    </div>

    <!-- Processing Info -->
    <div class="card bg-light mb-4" *ngIf="predictInfo">
      <div class="card-header bg-transparent border-0 pb-0">
        <h6 class="card-title mb-0">
          <i class="mdi mdi-information me-2"></i>Processing Information
        </h6>
      </div>
      <div class="card-body pt-2">
        <div class="row text-center">
          <div class="col-4">
            <small class="text-muted">Original Size</small>
            <div class="fw-semibold">{{originalFileSize}}</div>
          </div>
          <div class="col-4">
            <small class="text-muted">Compressed Size</small>
            <div class="fw-semibold">{{sizeOfFile}}</div>
          </div>
          <div class="col-4">
            <small class="text-muted">Processing Time</small>
            <div class="fw-semibold">{{predictInfo?.inference?.processing_time}}</div>
          </div>
        </div>
      </div>
    </div>

    <!-- Form Fields -->
    <div class="row">
      <div class="col-md-6 mb-3">
        <label class="form-label required d-flex align-items-center justify-content-between">
          <span><i class="mdi mdi-currency-usd me-1"></i>Total Amount</span>
          <span *ngIf="predictInfo" class="badge" 
                [class]="predictInfo?.inference?.prediction?.total_incl?.confidence > 0.75 ? 'bg-success' : 'bg-warning'">
            {{(predictInfo?.inference?.prediction?.total_incl?.confidence * 100) || 0}}%
          </span>
        </label>
        <input type="tel" class="form-control" placeholder="Enter total amount" formControlName="cost">
      </div>

      <div class="col-md-6 mb-3">
        <label class="form-label required d-flex align-items-center justify-content-between">
          <span><i class="mdi mdi-bookmark me-1"></i>Category</span>
          <span *ngIf="predictInfo" class="badge"
                [class]="predictInfo?.inference?.prediction?.category?.confidence > 0.75 ? 'bg-success' : 'bg-warning'">
            {{(predictInfo?.inference?.prediction?.category?.confidence * 100) || 0}}%
          </span>
        </label>
        <ng-select [items]="receiptOptions" formControlName="name" placeholder="Select category" [addTag]="true">
        </ng-select>
      </div>
    </div>

    <!-- Copied Receipt Indicator -->
    <div class="mb-3" *ngIf="form.get('copiedFromTicketId')?.value">
      <div class="alert alert-info border-0 rounded-3">
        <div class="d-flex align-items-center">
          <div class="bg-info bg-opacity-10 rounded-circle d-flex align-items-center justify-content-center me-3"
               style="width: 2.5rem; height: 2.5rem;">
            <i class="ri-file-copy-line text-info"></i>
          </div>
          <div>
            <h6 class="alert-heading mb-1">Copied Receipt</h6>
            <p class="mb-0 small">
              This receipt was copied from ticket 
              <span class="badge bg-info ms-1">#{{form.get('copiedFromTicketId')?.value}}</span>
            </p>
          </div>
        </div>
      </div>
    </div>

    <!-- <div class="mb-3">
      <label class="form-label">
        <i class="mdi mdi-office-building me-1"></i>Jobs
      </label>
      <ng-select [items]="data$ | async" [multiple]="true" [typeahead]="dataInput$"
        formControlName="jobs" [clearable]="true" placeholder="Select FSID"
        (change)="onMaterialGroupChange($event)">
        <ng-template ng-label-tmp let-item="item" let-clear="clear">
          <span class="badge bg-primary me-1" (click)="clear(item)">
            {{item.id}} <i class="mdi mdi-close ms-1"></i>
          </span>
        </ng-template>
        <ng-template ng-option-tmp let-item="item">
          <div class="py-1">
            <div class="fw-semibold">Property: {{item.property}} | {{item.request_date}}</div>
            <div class="small text-muted">Customer: {{item.customer}} | Service: {{item.service_type}}</div>
            <div class="small text-primary">#{{item.id}}</div>
          </div>
        </ng-template>
      </ng-select>
    </div> -->

    <div class="mb-3">
      <label class="form-label d-flex align-items-center justify-content-between">
        <span><i class="mdi mdi-store me-1"></i>Vendor Name</span>
        <span *ngIf="predictInfo" class="badge"
              [class]="predictInfo?.inference?.prediction?.supplier?.confidence > 0.75 ? 'bg-success' : 'bg-warning'">
          {{(predictInfo?.inference?.prediction?.supplier?.confidence * 100) || 0}}%
        </span>
      </label>
      <input type="search" class="form-control" placeholder="Ex) Lowes, Shell, Enterprise"
        formControlName="vendor_name">
    </div>

    <div class="row">
      <div class="col-md-6">
        <label class="form-label required d-flex align-items-center justify-content-between">
          <span><i class="mdi mdi-calendar me-1"></i>Receipt Date</span>
          <span *ngIf="predictInfo" class="badge"
                [class]="predictInfo?.inference?.prediction?.date?.confidence > 0.75 ? 'bg-success' : 'bg-warning'">
            {{(predictInfo?.inference?.prediction?.date?.confidence * 100) || 0}}%
          </span>
        </label>
        <input type="date" class="form-control" placeholder="Date" formControlName="date">
      </div>
      <div class="col-md-6">
        <label class="form-label required d-flex align-items-center justify-content-between">
          <span><i class="mdi mdi-clock me-1"></i>Receipt Time</span>
          <span *ngIf="predictInfo" class="badge"
                [class]="predictInfo?.inference?.prediction?.time?.confidence > 0.75 ? 'bg-success' : 'bg-warning'">
            {{(predictInfo?.inference?.prediction?.time?.confidence * 100) || 0}}%
          </span>
        </label>
        <input step="600" type="time" class="form-control" placeholder="time" formControlName="time">
      </div>
    </div>
  </form>
</div>

<div class="modal-footer bg-light border-top d-flex justify-content-between">
  <small class="text-muted">
    <i class="mdi mdi-shield-check me-1"></i>
    Auto-extract powered by intelligent processing
  </small>
  <div>
    <button (click)="deleteTripExpense()" type="button" class="btn btn-outline-danger me-2" *ngIf="id">
      <i class="mdi mdi-delete me-1"></i> Delete
    </button>
    <button (click)="onSubmit()" type="button" class="btn btn-primary">
      <i class="mdi mdi-content-save me-1"></i>Save
    </button>
  </div>
</div>