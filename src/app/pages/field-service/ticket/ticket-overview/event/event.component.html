<div id="printDiv" class="d-none d-print-block">
  <div>
    <h4>Event Details <span class="float-end">Ticket#: {{workOrderId}}</span></h4>
    <table class="table table-sm mb-0" *ngFor="let g of groupArrays;let i = index; let last = last;"
      style="page-break-after: avoid;">
      <thead>
        <tr>
          <th colspan="5">{{g.date == 'null' || !g.date ? 'No start date' : g.date }}</th>
        </tr>
      </thead>
      <tbody *ngFor="let row of g.games;let ii = index; let last1 = last;">
        <tr style="page-break-inside : avoid">
          <td>
            <p style="font-weight:bolder" class="ps-3 sticky-top">{{ii + 1}}. {{row.event_name || 'No event name'}} </p>
            <div class="ps-5">
              <p *ngIf="row.projectStart" class="mb-0">Start: <span>{{compare(row.projectStart,
                  row.projectFinish).start}} {{zoneAbbr(row.projectStartTz)}} </span></p>
              <p *ngIf="row.projectFinish" class="mb-0">End: <span>{{compare(row.projectStart,
                  row.projectFinish).finish}} {{zoneAbbr(row.projectFinishTz)}} </span></p>
              <p *ngIf="!row.projectStart" class="mb-0">Start: <span class="text-danger">No start time set</span></p>
              <p *ngIf="!row.projectFinish" class="mb-0">End: <span class="text-danger">No end time set</span></p>
              <p *ngIf="row.description" style="white-space:normal;" class="mb-0">
                Description: {{row.description}}
              </p>
            </div>
          </td>
          <td style="width:150px;text-align:right">
            {{sumLaborAndBreakTimesAndConvert({
            start:row.projectStart,
            finish:row.projectFinish,
            start_tz:row.projectStartTz,
            finish_tz:row.projectFinishTz,
            brStart:row.brStart,
            brEnd:row.brEnd
            }) || '-'}}
          </td>
        </tr>
        <tr *ngIf="last1" style="background-color:#E0E0E0">
          <th style="text-align:right" colspan="5">Sub Total: {{timeConvert(g.groupTotal)}}</th>
        </tr>
      </tbody>
      <tfoot *ngIf="last">
        <tr>
          <th style="text-align:right" colspan="5">Total: {{timeConvert(_travelAndWorkTotalHrs,'short')}}</th>
        </tr>
      </tfoot>
    </table>
  </div>
</div>

<div class="row justify-content-center">
  <!-- Main Content -->
  <div class="col-lg-8 col-xl-9">
    <div class="card border-0">
      <div class="card-header bg-primary bg-gradient text-white position-relative overflow-hidden p-4"
           style="border-radius: 16px 16px 0 0;">
        <!-- Background Pattern -->
        <div class="position-absolute" style="top: -20px; right: -20px; opacity: 0.1;">
          <i class="mdi mdi-format-list-checks" style="font-size: 8rem; transform: rotate(15deg);"></i>
        </div>
        
        <div class="d-flex align-items-center justify-content-between position-relative">
          <div class="d-flex align-items-center">
            <span class="bg-white bg-opacity-10 rounded-circle d-flex align-items-center justify-content-center me-3"
                  style="width: 2.5rem; height: 2.5rem;">
              <i class="mdi mdi-format-list-checks fs-4 text-white"></i>
            </span>
            <div>
              <h4 class="mb-1 fw-bold text-white">
                Events {{firstDay | date:"MM/dd/YYYY"}} to {{lastDay | date:"MM/dd/YYYY"}}
              </h4>
              <p class="text-white-50 mb-0">Timeline view and event management</p>
            </div>
          </div>
          
          <div class="d-flex align-items-center gap-2">
            <button class="btn btn-light btn-sm" (click)="this.isExpanded = !this.isExpanded;expandTimeLine()" *ngIf="activeTab === 'timeline'">
              <i class="mdi mdi-arrow-expand-all me-1"></i>
              {{isExpanded? 'Minimize' : 'Expand'}} Timeline
            </button>
            <button class="btn btn-light btn-sm" (click)="showReceipts()" *ngIf="activeTab === 'timeline'">
              <i class="mdi mdi-receipt me-1"></i>
              {{isShowingReceipts ? 'Hide' : 'Show'}} Receipts
            </button>
            <!-- Dropdown for Timeline/Event Details, default to Event Details -->
            <div ngbDropdown class="d-inline-block" placement="bottom-right" container="body">
              <button type="button" class="btn btn-light btn-sm d-flex align-items-center" id="eventViewDropdown" ngbDropdownToggle>
                <i class="mdi mdi-calendar-todo-outline me-1"></i>
                View
                <span class="ms-1">
                  <ng-container *ngIf="activeTab === 'timeline'">
                    <i class="mdi mdi-calendar-range"></i>
                  </ng-container>
                  <ng-container *ngIf="activeTab === 'details'">
                    <i class="mdi mdi-format-list-checks"></i>
                  </ng-container>
                </span>
                <i class="mdi mdi-menu-down ms-1"></i>
              </button>
              <div ngbDropdownMenu aria-labelledby="eventViewDropdown" container="body">
                <button ngbDropdownItem (click)="activeTab = 'details'">
                  <i class="mdi mdi-format-list-checks me-2 text-primary"></i>Event Details
                </button>
                <button ngbDropdownItem (click)="activeTab = 'timeline'">
                  <i class="mdi mdi-calendar-range me-2 text-primary"></i>Timeline Calendar
                </button>
              </div>
            </div>
            <!-- Actions Dropdown -->
            <div ngbDropdown class="d-none d-sm-block" placement="bottom-right" container="body">
              <button type="button" class="btn btn-light btn-sm" id="dropdownBasic1" ngbDropdownToggle>
                <i class="mdi mdi-dots-horizontal me-1"></i>Actions
              </button>
              <div ngbDropdownMenu aria-labelledby="dropdownBasic1" container="body">
                <button ngbDropdownItem class="py-2" (click)="printEventsOnly()">
                  <i class="mdi mdi-printer me-2 text-primary"></i>Print Event Details
                </button>
                <button ngbDropdownItem class="py-2" (click)="print()">
                  <i class="mdi mdi-printer me-2 text-warning"></i>Print Ticket Summary
                </button>
                <button ngbDropdownItem class="py-2" (click)="print(true)">
                  <i class="mdi mdi-printer me-2 text-warning"></i>Print Ticket Summary Details
                </button>
              </div>
            </div>
            <button class="btn btn-success btn-sm" (click)="addWorkDetail()" [disabled]="loading">
              <i class="mdi mdi-plus me-1"></i>Add Event
            </button>
            <button class="btn btn-warning btn-sm" (click)="openCopyFromTicketModal()">
              <i class="mdi mdi-content-copy me-1"></i>Copy From Another Ticket
            </button>
          </div>
        </div>

      </div>

      <div class="card-body p-0">
        <ng-container [ngSwitch]="activeTab">
          <div *ngSwitchCase="'timeline'">
            <div class="p-0" style="height: calc(100vh - 400px);">
              <mbsc-eventcalendar [view]="view" [refDate]="refDate" [options]="settings"
                (onPageLoading)="onPageLoading($event)" [data]="myEvents" [extendDefaultEvent]="myDefaultEvent"
                class="md-timeline-templatec" [dragToMove]="true" [dragToResize]="true" [dragTimeStep]="5"
                [dragToCreate]="true" [themeVariant]="themeVariant">
              </mbsc-eventcalendar>
              <ng-template #eventTemplate let-data>
                <div class="md-timeline-template-event" [ngStyle]="{borderColor: data.color, background: data.color}">
                  <div class="md-timeline-template-event-cont mbsc-schedule-event-inner">
                    <span class="md-timeline-template-time h6" [ngStyle]="{color: data.color}">{{data.start}} </span>
                    <span class="md-timeline-template-title h6">{{data.original.title}}</span>
                    <p class="md-timeline-template-time ">{{data.original.time}}</p>
                  </div>
                </div>
              </ng-template>
            </div>
          </div>
          <div *ngSwitchDefault>
            <div class="p-0">
              <!-- ...existing Event Details table code... -->
              <div *ngIf="loading" class="text-center p-5">
                <div class="spinner-border text-primary mb-3" role="status">
                  <span class="visually-hidden">Loading...</span>
                </div>
                <p class="text-muted">Loading data. Please wait...</p>
              </div>
              <div *ngIf="!data?.length && !loading" class="text-center p-5">
                <i class="mdi mdi-calendar-blank-outline text-muted mb-3" style="font-size: 3rem;"></i>
                <p class="text-muted">No events found.</p>
              </div>
              <div *ngIf="data?.length > 0">
                <div class="table-responsive">
                  <table class="table table-hover align-middle mb-0">
                    <thead class="table-dark sticky-top" style="top:-1px">
                      <tr>
                        <th class="text-start text-nowrap py-3">
                          <i class="mdi mdi-eye-outline me-1"></i>
                        </th>
                        <th class="text-start text-nowrap py-3">
                          <i class="mdi mdi-bookmark-outline me-1"></i>Type
                        </th>
                        <th class="text-start text-nowrap py-3">
                          <i class="mdi mdi-file-document-outline me-1"></i>Description
                        </th>
                        <th class="text-end text-nowrap py-3">
                          <i class="mdi mdi-clock-outline me-1"></i>Start/Finish
                        </th>
                        <th class="text-end text-nowrap py-3">
                          <i class="mdi mdi-timer-outline me-1"></i>Time
                        </th>
                        <th class="text-end text-nowrap py-3">
                          <i class="mdi mdi-calculator-variant-outline me-1"></i>QTR Hours
                        </th>
                      </tr>
                    </thead>
                    <tbody *ngFor="let g of groupArrays">
                      <tr class="table-light sticky-top border-bottom border-2 border-primary border-opacity-25 align-middle" style="top:45px">
                        <td colspan="6" class="py-3 fw-bold text-primary position-relative">
                          <i class="mdi mdi-calendar-range me-2"></i>
                          {{g.date == 'null' || !g.date ? 'No start date' : g.date }}
                          <span *ngIf="g.minMissing && g.minMissing.length > 0" class="badge bg-danger ms-2">
                            <i class="mdi mdi-timer-sand-empty me-1"></i>Missing {{g.minutes}} mins
                          </span>
                          <button class="btn btn-success btn-sm position-absolute end-0 top-50 translate-middle-y me-3" 
                                  (click)="addWorkDetail(g.dateRaw, g)"
                                  title="Add new work detail for this date">
                            <i class="mdi mdi-plus me-1"></i>Add Event
                          </button>
                        </td>
                      </tr>
                      <tr *ngFor="let row of g.games; let i = index"
                          class="fw-normal event-row align-middle"
                          [ngClass]="{
                            'fw-bolder fst-italic':!row.include_calculation
                          }"
                          [style.borderLeft]="row.copiedFromTicketId ? '4px solid #0dcaf0' : ''"
                          style="transition: background 0.15s;">
                        <td class="text-center" (click)="openWorkInfo(row.id)">
                          <button class="btn btn-outline-primary btn-sm" title="Edit Event">
                            <i class="mdi mdi-pencil-outline"></i>
                          </button>
                        </td>
                        <td class="text-start ps-3">
                          <div class="d-flex align-items-start">
                            <span class="fw-bold text-primary me-2 d-flex align-items-center">{{i+1}}.</span>
                            <div>
                              <div class="fw-semibold d-flex align-items-center gap-2">
                                {{row.event_name}}
                                <i *ngIf="row.hasError" class="mdi mdi-alert-circle-outline text-danger" title="Event has errors"></i>
                                <i *ngIf="!row.hasError && row.hasWarning" class="mdi mdi-alert-outline text-warning" title="Event has warnings"></i>
                              </div>
                              <div class="d-flex flex-wrap gap-1 mt-1">
                                <span *ngIf="row.copiedFromTicketId" class="badge bg-info d-flex align-items-center">
                                  <i class="mdi mdi-content-copy me-1"></i>Copied from #{{row.copiedFromTicketId}}
                                </span>
                                <span *ngIf="!row.include_calculation" class="badge bg-primary d-flex align-items-center">
                                  <i class="mdi mdi-block-helper me-1"></i>Non-billable
                                </span>
                              </div>
                              <div *ngIf="row.flight_hrs_delay" class="small text-muted mt-1 d-flex align-items-center">
                                <i class="mdi mdi-airplane-clock me-1"></i>Flight Hr delay: {{row.flight_hrs_delay}}
                              </div>
                              <div *ngIf="row.receipts?.length" class="mt-2">
                                <div class="small fw-semibold text-success mb-1 d-flex align-items-center">
                                  <i class="mdi mdi-receipt me-1"></i>Receipts:
                                </div>
                                <div *ngFor="let item of row.receipts; let receiptIndex = index" class="small">
                                  <a href="javascript:void(0)" class="text-success text-decoration-none ms-3 d-flex align-items-center" 
                                     (click)="viewReceipt(item);$event.stopPropagation()">
                                    <i class="mdi mdi-paperclip me-1"></i>[{{receiptIndex+1}}] {{item.name}} - {{item.time}}
                                  </a>
                                </div>
                              </div>
                            </div>
                          </div>
                        </td>
                        <td class="text-muted">
                          <span [title]="row.description">{{row.description || 'No description'}}</span>
                        </td>
                        <td class="text-end text-nowrap">
                          <div class="small">
                            <div class="mb-1">
                              <span class="badge bg-success bg-opacity-10 text-success">
                                <i class="mdi mdi-play me-1"></i>
                                {{compare(row.projectStart, row.projectFinish).start}}
                              </span>
                              <small class="text-muted ms-1">{{zoneAbbr(row.projectStartTz)}}</small>
                            </div>
                            <div>
                              <span class="badge bg-danger bg-opacity-10 text-danger">
                                <i class="mdi mdi-stop me-1"></i>
                                {{compare(row.projectStart, row.projectFinish).finish}}
                              </span>
                              <small class="text-muted ms-1">{{zoneAbbr(row.projectFinishTz)}}</small>
                            </div>
                          </div>
                        </td>
                        <td class="text-end text-nowrap">
                          <span class="fw-semibold">{{timeConvert(calculateTotal(row))}}</span>
                        </td>
                        <td class="text-end text-nowrap">
                          <span class="fw-semibold">{{calculateTotal(row)/60 | number : '1.2-2'}}</span>
                        </td>
                      </tr>
                      <tr class="table-primary border-bottom border-2 border-primary">
                        <td colspan="4" class="text-end fw-bold py-2">
                          <i class="mdi mdi-calculator-variant-outline me-2"></i>Sub Total
                        </td>
                        <td class="text-end fw-bold py-2">{{timeConvert(g.groupTotal,'short')}}</td>
                        <td class="text-end fw-bold py-2">{{g.groupTotal/60 | number : '1.2-2'}}</td>
                      </tr>
                    </tbody>
                    <tfoot class="table-dark">
                      <tr>
                        <td colspan="4" class="text-end fw-bold py-3">
                          <i class="mdi mdi-calculator-variant-outline me-2"></i>TOTAL
                        </td>
                        <td class="text-end fw-bold py-3">{{timeConvert(_travelAndWorkTotalHrs,'short')}}</td>
                        <td class="text-end fw-bold py-3">{{_travelAndWorkTotalHrs/60 | number : '1.2-2'}}</td>
                      </tr>
                    </tfoot>
                  </table>
                </div>
              </div>
              <div *ngIf="data.length && !loading" class="text-center p-3 bg-light border-top">
                <small class="text-muted">
                  <i class="mdi mdi-check-bold me-1"></i>End of data
                </small>
              </div>
            </div>
          </div>
        </ng-container>
        <!-- Remove the old nav outlet since view is now handled by ngSwitch above -->
        <!-- <div [ngbNavOutlet]="nav"></div> -->
      </div>

      <div class="card-footer bg-light border-top">
        <div class="d-flex align-items-center justify-content-between">
          <div class="d-flex align-items-center">
            <i class="mdi mdi-timer-outline text-success me-2"></i>
            <span class="fw-semibold">Total Time:</span>
            <span class="text-success fw-bold ms-2">{{timeConvert(_travelAndWorkTotalHrs,'short')}}</span>
          </div>
          <small class="text-muted">
            <i class="mdi mdi-information-outline me-1"></i>
            {{activeTab === 'timeline' ? 'Drag and drop to modify events' : 'Click on any row to view details'}}
          </small>
        </div>
      </div>
    </div>
  </div>

  <!-- Right Sidebar - Event Summary -->
  <div class="col-lg-4 col-xl-3">
    <!-- Make sidebar sticky -->
    <div class="position-sticky" style="top: 5rem; max-height: calc(100vh - 4rem); overflow-y: auto;">
      
      <!-- Time Summary Card -->
      <div class="card border-0 mb-4">
        <div class="card-header bg-primary bg-opacity-10 border-bottom">
          <h6 class="card-title mb-0 text-dark">
            <i class="mdi mdi-timer-outline me-2"></i>Time Summary
          </h6>
        </div>
        <div class="card-body">
          <div class="row g-3 text-center">
            <div class="col-6">
              <div class="p-3 bg-success bg-opacity-10 rounded">
                <div class="fs-4 fw-bold text-success">{{timeConvert(_travelAndWorkTotalHrs, 'short')}}</div>
                <small class="text-muted">Total Hours</small>
              </div>
            </div>
            <div class="col-6">
              <div class="p-3 bg-info bg-opacity-10 rounded">
                <div class="fs-4 fw-bold text-info">{{(_travelAndWorkTotalHrs/60) | number:'1.2-2'}}</div>
                <small class="text-muted">QTR Hours</small>
              </div>
            </div>
          </div>
          
          <div class="mt-3 pt-3 border-top">
            <div class="d-flex justify-content-between align-items-center mb-2">
              <small class="text-muted">By Event Type:</small>
            </div>
            <div class="small" *ngFor="let eventType of getEventTypeSummary()">
              <div class="d-flex justify-content-between align-items-center mb-1">
                <span class="text-muted">{{eventType.name}}</span>
                <span class="badge bg-secondary">{{eventType.hours}}</span>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Time Discrepancies Alert -->
      <div class="card border-0 mb-4" *ngIf="getTimeDiscrepancies().length > 0">
        <div class="card-header bg-warning bg-opacity-10 border-bottom">
          <h6 class="card-title mb-0 text-warning">
            <i class="mdi mdi-alert-circle-outline me-2"></i>Time Issues Found ({{getTimeDiscrepancies().length}})
          </h6>
        </div>
        <div class="card-body">
          <div class="alert alert-warning border-0 mb-3 small">
            <i class="mdi mdi-alert-outline me-1"></i>
            The following issues need attention:
          </div>
          
          <div class="small">
            <div *ngFor="let issue of getTimeDiscrepancies()" class="mb-3 p-2 bg-warning bg-opacity-10 rounded border border-warning border-opacity-25">
              <div class="fw-semibold text-warning mb-1 d-flex align-items-center justify-content-between">
                <span>
                  <i class="mdi mdi-calendar-outline me-1"></i>{{issue.date}}
                </span>
                <span class="badge bg-warning bg-opacity-50 text-dark small">{{issue.type}}</span>
              </div>
              <div class="text-muted mb-2">{{issue.description}}</div>
              
              <!-- Missing Time Details -->
              <div *ngIf="issue.missingTime" class="small mb-2">
                <span class="badge bg-danger">
                  <i class="mdi mdi-timer-sand-empty me-1"></i>Missing: {{issue.missingTime}}
                </span>
              </div>
              
              <!-- Overlap Details -->
              <div *ngIf="issue.overlaps?.length" class="small mb-2">
                <span class="badge bg-warning">
                  <i class="mdi mdi-vector-link me-1"></i>{{issue.overlaps.length}} Overlap(s)
                </span>
                <div class="mt-2">
                  <div *ngFor="let overlap of issue.overlaps" class="bg-white p-2 rounded border border-warning border-opacity-50 mb-1">
                    <div class="fw-semibold text-warning small">
                      <i class="mdi mdi-alarm-light-outline me-1"></i>Overlap Period
                    </div>
                    <div class="small text-muted">
                      {{overlap.from | date:'short'}} - {{overlap.to | date:'short'}}
                    </div>
                    <div class="small text-muted">
                      Duration: {{getOverlapDuration(overlap.from, overlap.to)}}
                    </div>
                  </div>
                </div>
              </div>
              
              <!-- Quick Fix Actions -->
              <div class="d-flex gap-1 mt-2">
                <button *ngIf="issue.type === 'gap'" 
                        class="btn btn-outline-warning btn-sm" 
                        (click)="quickFixGap(issue)"
                        title="Fill time gap">
                  <i class="mdi mdi-plus me-1"></i>Fill Gap
                </button>
                <button *ngIf="issue.type === 'overlap'" 
                        class="btn btn-outline-danger btn-sm" 
                        (click)="quickFixOverlap(issue)"
                        title="Resolve overlap">
                  <i class="mdi mdi-content-cut me-1"></i>Fix Overlap
                </button>
                <button class="btn btn-outline-info btn-sm" 
                        (click)="navigateToIssue(issue)"
                        title="Go to issue">
                  <i class="mdi mdi-eye-outline me-1"></i>View
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Overlapping Events Detail Card -->
      <div class="card border-0 mb-4" *ngIf="getOverlappingEventDetails().length > 0">
        <div class="card-header bg-danger bg-opacity-10 border-bottom">
          <h6 class="card-title mb-0 text-danger">
            <i class="mdi mdi-vector-link me-2"></i>Overlapping Events ({{getOverlappingEventDetails().length}})
          </h6>
        </div>
        <div class="card-body">
          <div class="small">
            <div *ngFor="let conflict of getOverlappingEventDetails()" class="mb-3 p-2 bg-danger bg-opacity-5 rounded border border-danger border-opacity-25">
              <div class="fw-semibold text-danger mb-2 d-flex align-items-center">
                <i class="mdi mdi-alert-outline me-1"></i>
                Conflict on {{conflict.date | date:'MMM dd, yyyy'}}
              </div>
              
              <!-- Conflicting Events -->
              <div class="mb-2">
                <div *ngFor="let event of conflict.events; let i = index" class="bg-white p-2 rounded mb-1 border border-danger border-opacity-25">
                  <div class="d-flex align-items-center justify-content-between">
                    <div>
                      <div class="fw-semibold small text-danger">{{event.event_name}}</div>
                      <div class="small text-muted">
                        {{event.projectStart | date:'short'}} - {{event.projectFinish | date:'short'}}
                      </div>
                    </div>
                    <button class="btn btn-outline-danger btn-sm" 
                            (click)="openWorkInfo(event.id)"
                            title="Edit this event">
                      <i class="mdi mdi-pencil-outline"></i>
                    </button>
                  </div>
                </div>
              </div>
              
              <!-- Overlap Duration -->
              <div class="small mb-2">
                <span class="badge bg-danger">
                  <i class="mdi mdi-timer-sand-empty me-1"></i>
                  Overlap: {{conflict.overlapDuration}}
                </span>
              </div>
              
              <!-- Quick Actions -->
              <div class="d-flex gap-1">
                <button class="btn btn-outline-warning btn-sm" 
                        (click)="autoResolveOverlap(conflict)"
                        title="Automatically adjust times">
                  <i class="mdi mdi-auto-fix me-1"></i>Auto Fix
                </button>
                <button class="btn btn-outline-info btn-sm" 
                        (click)="showOverlapDetails(conflict)"
                        title="Show detailed overlap information">
                  <i class="mdi mdi-information-outline me-1"></i>Details
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Daily Breakdown -->
      <div class="card border-0 mb-4" *ngIf="groupArrays?.length">
        <div class="card-header bg-info bg-opacity-10 border-bottom">
          <h6 class="card-title mb-0 text-light">
            <i class="mdi mdi-calendar-range me-2"></i>Daily Breakdown
          </h6>
        </div>
        <div class="card-body">
          <div class="small">
            <div *ngFor="let day of groupArrays" class="mb-3 p-2 bg-light rounded">
              <div class="d-flex justify-content-between align-items-center mb-2">
                <span class="fw-semibold">{{day.date | date:'MMM dd, yyyy'}}</span>
                <span class="badge bg-primary">{{timeConvert(day.groupTotal, 'short')}}</span>
              </div>
              
              <div class="progress mb-2" style="height: 6px;">
                <div class="progress-bar" 
                     [style.width.%]="getProgressPercentage(day.groupTotal)"
                     [class.bg-success]="day.groupTotal >= 480"
                     [class.bg-warning]="day.groupTotal < 480 && day.groupTotal >= 240"
                     [class.bg-danger]="day.groupTotal < 240">
                </div>
              </div>
              
              <div class="d-flex justify-content-between text-muted">
                <small>{{day.games?.length || 0}} events</small>
                <div class="d-flex gap-2">
                  <small *ngIf="day.minutes > 0" class="text-danger">
                    <i class="mdi mdi-alert-circle-outline me-1"></i>{{day.minutes}}min gaps
                  </small>
                  <small *ngIf="getDayOverlapCount(day) > 0" class="text-warning">
                    <i class="mdi mdi-vector-link me-1"></i>{{getDayOverlapCount(day)}} overlaps
                  </small>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Event Statistics -->
      <div class="card border-0 mb-4">
        <div class="card-header bg-secondary bg-opacity-10 border-bottom">
          <h6 class="card-title mb-0 text-dark">
            <i class="mdi mdi-chart-bar me-2"></i>Event Statistics
          </h6>
        </div>
        <div class="card-body">
          <div class="small">
            <div class="d-flex justify-content-between align-items-center mb-2">
              <span class="text-muted">Total Events:</span>
              <span class="fw-bold">{{getTotalEvents()}}</span>
            </div>
            
            <div class="d-flex justify-content-between align-items-center mb-2">
              <span class="text-muted">Billable Events:</span>
              <span class="fw-bold text-success">{{getBillableEvents()}}</span>
            </div>
            
            <div class="d-flex justify-content-between align-items-center mb-2">
              <span class="text-muted">Non-billable:</span>
              <span class="fw-bold text-warning">{{getNonBillableEvents()}}</span>
            </div>
            
            <div class="d-flex justify-content-between align-items-center mb-2">
              <span class="text-muted">Missing Times:</span>
              <span class="fw-bold text-danger">{{getMissingTimeEvents()}}</span>
            </div>
            
            <div class="d-flex justify-content-between align-items-center mb-2">
              <span class="text-muted">Copied Events:</span>
              <span class="fw-bold text-info">{{getCopiedEvents()}}</span>
            </div>
            
            <div class="d-flex justify-content-between align-items-center mb-2">
              <span class="text-muted">Overlapping Events:</span>
              <span class="fw-bold text-warning">{{getOverlappingEventsCount()}}</span>
            </div>
            
            <div class="d-flex justify-content-between align-items-center">
              <span class="text-muted">Average per Day:</span>
              <span class="fw-bold">{{getAverageHoursPerDay() | number:'1.1-1'}}h</span>
            </div>
          </div>
        </div>
      </div>

      <!-- Recent Activity -->
      <div class="card border-0 mb-4" *ngIf="data?.length">
        <div class="card-header bg-success bg-opacity-10 border-bottom">
          <h6 class="card-title mb-0 text-dark">
            <i class="mdi mdi-history me-2"></i>Recent Activity
          </h6>
        </div>
        <div class="card-body">
          <div class="small">
            <div *ngFor="let event of getRecentEvents(); let i = index" class="d-flex align-items-center mb-2">
              <div class="bg-primary bg-opacity-10 rounded-circle d-flex align-items-center justify-content-center me-2"
                   style="width: 24px; height: 24px;">
                <i class="mdi mdi-clock-outline text-success" style="font-size: 12px;"></i>
              </div>
              <div class="flex-grow-1">
                <div class="fw-semibold text-truncate">{{event.event_name}}</div>
                <div class="text-muted small">
                  {{event.projectStart | date:'short'}} â€¢ 
                  {{timeConvert(calculateTotal(event), 'short')}}
                </div>
              </div>
            </div>
            
            <div *ngIf="!data?.length" class="text-center text-muted py-3">
              <i class="mdi mdi-inbox-outline mb-2" style="font-size: 2rem;"></i>
              <div>No events recorded yet</div>
            </div>
          </div>
        </div>
      </div>

      <!-- Quick Actions -->
      <div class="card border-0">
        <div class="card-header bg-light border-bottom">
          <h6 class="card-title mb-0 text-dark">
            <i class="mdi mdi-tools me-2"></i>Quick Actions
          </h6>
        </div>
        <div class="card-body">
          <div class="d-grid gap-2">
            <button class="btn btn-outline-success btn-sm" (click)="addWorkDetail()" [disabled]="loading">
              <i class="mdi mdi-plus me-2"></i>Add New Event
            </button>
            <button class="btn btn-outline-info btn-sm" (click)="fixTimeGaps()" 
                    [disabled]="!hasTimeGaps()" 
                    *ngIf="hasTimeGaps()">
              <i class="mdi mdi-timer-outline me-2"></i>Fix Time Gaps
            </button>
            <button class="btn btn-outline-warning btn-sm" (click)="resolveOverlaps()" 
                    [disabled]="!hasOverlaps()" 
                    *ngIf="hasOverlaps()">
              <i class="mdi mdi-shuffle-variant me-2"></i>Resolve All Overlaps
            </button>
            <button class="btn btn-outline-danger btn-sm" (click)="showAllTimeIssues()" 
                    *ngIf="getTimeDiscrepancies().length > 0">
              <i class="mdi mdi-alarm-light-outline me-2"></i>Review All Issues
            </button>
            <button class="btn btn-outline-primary btn-sm" (click)="printEventsOnly()">
              <i class="mdi mdi-printer me-2"></i>Print Events
            </button>
          </div>
          
          <div class="mt-3 pt-3 border-top">
            <small class="text-muted">
              <i class="mdi mdi-shield-check-outline me-1"></i>
              All events are automatically tracked and calculated.
            </small>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Copy From Ticket Modal -->
<ng-template #copyFromTicketModal let-modal>
  <div class="modal-header bg-primary bg-gradient text-white position-relative overflow-hidden p-4"
       style="border-radius: 16px 16px 0 0;">
    <!-- Background Pattern -->
    <div class="position-absolute" style="top: -20px; right: -20px; opacity: 0.1;">
      <i class="mdi mdi-content-copy" style="font-size: 8rem; transform: rotate(15deg);"></i>
    </div>
    
    <div class="d-flex align-items-center position-relative">
      <span class="bg-white bg-opacity-10 rounded-circle d-flex align-items-center justify-content-center me-3"
            style="width: 2.5rem; height: 2.5rem;">
        <i class="mdi mdi-content-copy fs-4 text-white"></i>
      </span>
      <div>
        <h4 class="mb-1 fw-bold text-white">
          Copy Records From Another Ticket
        </h4>
        <p class="text-white-50 mb-0">Select and copy event records from existing tickets</p>
      </div>
    </div>
    <button type="button" class="btn-close position-relative" style="z-index: 1;" aria-hidden="true" (click)="modal.dismiss()"></button>
  </div>

  <div class="modal-body">
    <!-- Add styles for dropdown positioning -->
    <style>
      /* Fix ng-select dropdown positioning when appendToBody is used */
      .ng-dropdown-panel.ng-select-bottom {
        position: fixed !important;
        z-index: 2000 !important; /* Higher than modal z-index */
      }
      
      .ng-dropdown-panel.ng-select-top {
        position: fixed !important;
        z-index: 2000 !important;
      }
      
      /* Ensure dropdown options are properly styled */
      .ng-dropdown-panel .ng-option {
        padding: 8px 12px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }
      
      /* Fix dropdown width to match input */
      .ng-dropdown-panel {
        min-width: 100% !important;
        max-width: 500px;
      }
      
      /* Handle scrollable dropdown */
      .ng-dropdown-panel .ng-dropdown-panel-items {
        max-height: 200px;
        overflow-y: auto;
      }
    </style>

    <div class="alert alert-info mb-4 rounded-0 border-0" style="font-size: 0.95rem;">
      <i class="mdi mdi-information-outline me-2"></i>
      Select a source ticket and choose which records to copy to the current ticket. Copied records will be marked with their source ticket ID.
    </div>

    <!-- Step 1: Ticket Selection -->
    <div class="mb-4">
      <h6 class="text-primary mb-3 border-bottom border-primary border-opacity-25 pb-2">
        <i class="mdi mdi-magnify me-2"></i>
        Step 1: Select Source Ticket
      </h6>
      <div class="mb-3">
        <label class="form-label required">
          <i class="mdi mdi-ticket me-1"></i>
          Source Ticket
        </label>
        <app-job-search
          (notifyParent)="notifyParent($event)"
          
          [value]="selectedSourceTicketId"
          [showLabel]="false"
          [autoFocus]="true">
        </app-job-search>
        <div class="form-text text-muted mt-1">
          <i class="mdi mdi-lightbulb-on-outline me-1"></i>
          Search and select the ticket you want to copy records from.
        </div>
      </div>
    </div>

    <!-- Step 2: Record Selection -->
    <div *ngIf="sourceTicketRecords?.length" class="mb-4">
      <h6 class="text-primary mb-3 border-bottom border-primary border-opacity-25 pb-2">
        <i class="mdi mdi-checkbox-multiple-marked-outline me-2"></i>
        Step 2: Select Records to Copy
      </h6>
      <div class="table-responsive border border-primary border-opacity-25 rounded" style="max-height:300px;overflow:auto;">
        <table class="table table-sm table-hover align-middle mb-0">
          <thead class="table-light sticky-top">
            <tr>
              <th class="py-2">
                <input type="checkbox" [(ngModel)]="selectAllRecords" (change)="toggleSelectAllRecords()" [ngModelOptions]="{standalone: true}" class="form-check-input">
              </th>
              <th class="py-2">Type</th>
              <th class="py-2">Description</th>
              <th class="py-2">Start</th>
              <th class="py-2">Finish</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let rec of sourceTicketRecords; let i = index" [class.table-active]="rec._selected">
              <td>
                <input type="checkbox" [(ngModel)]="rec._selected" [ngModelOptions]="{standalone: true}" class="form-check-input">
              </td>
              <td>
                <span class="fw-semibold">{{rec.event_name}}</span>
              </td>
              <td>
                <span class="text-muted">{{rec.description || 'No description'}}</span>
              </td>
              <td class="text-nowrap">{{rec.projectStart | date:'short'}}</td>
              <td class="text-nowrap">{{rec.projectFinish | date:'short'}}</td>
            </tr>
          </tbody>
        </table>
      </div>
      <div class="form-text text-muted mt-2">
        <i class="mdi mdi-information-outline me-1"></i>
        Select the records you want to copy. They will be added to the current ticket with a reference to the source.
      </div>
    </div>

    <div *ngIf="selectedSourceTicketId && !sourceTicketRecords?.length" class="alert alert-warning border-0">
      <i class="mdi mdi-alert-outline me-2"></i>
      No records found for this ticket.
    </div>

    <!-- Copy Results -->
    <div *ngIf="copySuccessCount > 0 || copyErrors.length > 0" class="mt-4">
      <div *ngIf="copySuccessCount > 0" class="alert alert-success border-0">
        <i class="mdi mdi-checkbox-marked-circle-outline me-2"></i>
        Successfully copied {{copySuccessCount}} record(s).
      </div>
      <div *ngIf="copyErrors.length > 0" class="alert alert-danger border-0">
        <div class="fw-bold mb-2">
          <i class="mdi mdi-alert-circle-outline me-2"></i>
          Failed to copy {{copyErrors.length}} record(s):
        </div>
        <ul class="mb-0 small">
          <li *ngFor="let error of copyErrors">{{error}}</li>
        </ul>
      </div>
    </div>
  </div>

  <div class="modal-footer bg-light border-top d-flex justify-content-between">
    <small class="text-muted">
      <i class="mdi mdi-shield-check-outline me-1"></i>
      Copied records will be marked with their source ticket ID
    </small>
    <div>
      <button type="button" class="btn btn-outline-secondary me-2" (click)="modal.dismiss()">
        <i class="mdi mdi-close me-1"></i>Cancel
      </button>
      <button type="button" class="btn btn-primary" (click)="copySelectedRecords(modal)" [disabled]="!hasSelectedRecords()">
        <i class="mdi mdi-content-copy me-1"></i>Copy Selected
      </button>
    </div>
  </div>
</ng-template>

<!-- Add this style block after the opening body tag -->
<style>
  .event-row:hover {
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    border-radius: 8px;
    background-color: var(--bs-light) !important;
  }
  
  .table-striped > tbody > tr:nth-of-type(odd) > td {
    background-color: rgba(0,0,0,0.02);
  }
  
  .badge {
    font-size: 0.7rem;
  }
  
  /* Enhanced sticky sidebar styling */
  .position-sticky {
    z-index: 1020;
  }

  /* Custom scrollbar for sidebar */
  .position-sticky::-webkit-scrollbar {
    width: 6px;
  }

  .position-sticky::-webkit-scrollbar-track {
    background: #f1f1f1;
    border-radius: 3px;
  }

  .position-sticky::-webkit-scrollbar-thumb {
    background: #c1c1c1;
    border-radius: 3px;
  }

  .position-sticky::-webkit-scrollbar-thumb:hover {
    background: #a8a8a8;
  }

  /* Overlap highlight styles */
  .overlap-highlight {
    border-left: 4px solid #ffc107 !important;
    background-color: rgba(255, 193, 7, 0.1) !important;
  }

  .conflict-event {
    border: 2px solid #dc3545 !important;
    background-color: rgba(220, 53, 69, 0.05) !important;
  }

  /* Smooth animations for cards */
  .card {
    transition: all 0.2s ease-in-out;
  }

  .card:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.1) !important;
  }
</style>

<!-- 
  NOTE: If dropdowns/popups are still clipped, ensure your modal CSS does not set overflow:hidden/auto on .modal-dialog or .modal-content.
  You may need to add a global style override:
  .modal-content { overflow: visible !important; }
-->