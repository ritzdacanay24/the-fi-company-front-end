<div class="container-fluid" *ngIf="loading">
  <div class="row justify-content-center">
    <div class="col-12 col-lg-11 col-xl-10 col-xxl-7">
      <div class="card shadow-sm border-0">
        <div class="card-body text-center p-5" style="min-height:300px">
          <div class="mb-4">
            <div class="spinner-border text-primary" role="status" style="width: 4rem; height: 4rem;"></div>
          </div>
          <h4 class="text-muted mb-3">Loading checklist instance...</h4>
          <div class="progress mx-auto" style="width: 200px; height: 4px;">
            <div class="progress-bar progress-bar-striped progress-bar-animated" style="width: 100%"></div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="container-fluid" *ngIf="!loading && !instance">
  <div class="row justify-content-center">
    <div class="col-12 col-lg-11 col-xl-10 col-xxl-7">
      <div class="card shadow-sm border-0">
        <div class="card-body text-center p-5" style="min-height:300px">
          <div class="mb-4">
            <i class="mdi mdi-alert-circle-outline text-warning" style="font-size: 4rem;"></i>
          </div>
          <h4 class="text-muted mb-3">Checklist Instance Not Found</h4>
          <p class="text-muted mb-4">The checklist instance you're looking for doesn't exist or has been removed.</p>
          <button class="btn btn-primary" (click)="goBack()">
            <i class="mdi mdi-format-list-bulleted me-2"></i>Back to Checklists
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="container-fluid" [hidden]="loading || !instance || !template">
  <div class="row justify-content-center">
    <div class="col-12 col-lg-11 col-xl-10 col-xxl-8">
      
      <!-- Page Header with Context -->
      <div class="mb-4">
        <div class="d-flex align-items-center mb-3">
          <button 
            type="button" 
            class="btn btn-outline-secondary me-3"
            (click)="goBack()"
            title="Back to Checklists">
            <i class="mdi mdi-arrow-left me-2"></i>Back
          </button>
          <div class="bg-primary bg-gradient rounded-circle me-3 d-flex align-items-center justify-content-center" style="width: 60px; height: 60px;">
            <i class="mdi mdi-clipboard-check text-white fs-4"></i>
          </div>
          <div>
            <h2 class="mb-1 text-primary">{{template?.name || 'Checklist Instance'}}</h2>
            <p class="text-muted mb-0">Progress: {{getCompletedItemsCount()}} of {{getTotalItemsCount()}} items completed</p>
          </div>
        </div>
        
        <div class="alert alert-success border-success border-opacity-25 bg-success bg-opacity-10" role="alert" 
             *ngIf="instance?.status === 'completed' || instance?.status === 'submitted'">
          <div class="d-flex align-items-start">
            <i class="mdi mdi-check-circle text-success me-3 mt-1 fs-5"></i>
            <div>
              <h6 class="alert-heading text-success mb-2">Checklist Completed</h6>
              <p class="mb-2">
                Checklist {{instance?.status}} on: {{instance?.updated_at | date:'medium'}}
              </p>
            </div>
          </div>
        </div>
      </div>

      <div class="card shadow-sm border-0">
        <div class="card-body p-4">
          
          <!-- Photo Taking Mode -->
          <div *ngIf="!isReviewMode">
            <div *ngFor="let progress of getCurrentItemsToShow(); let i = index; let first = first">
              
              <!-- Separator between parent and sub-items -->
              <div *ngIf="i > 0 && progress.item.level === 1 && first" class="my-4">
                <div class="border-top pt-3">
                  <h6 class="text-muted text-uppercase small mb-3">
                    <i class="mdi mdi-subdirectory-arrow-right me-2"></i>Related Sub-items
                  </h6>
                </div>
              </div>
              
              <!-- Task Description - Inline -->
              <div class="mb-4" *ngIf="progress.item"
                   [class.ms-4]="progress.item.level === 1"
                   [class.mt-4]="i > 0 && progress.item.level === 1">
                <div class="p-3 rounded border-start border-primary border-4 bg-light bg-opacity-50"
                     [class.border-secondary]="progress.item.level === 1">
                  <div class="d-flex justify-content-between align-items-start mb-2">
                    <h5 class="mb-1"
                        [class.text-primary]="progress.item.level === 0 || !progress.item.level"
                        [class.text-secondary]="progress.item.level === 1">
                      <i class="mdi mdi-subdirectory-arrow-right me-2" *ngIf="progress.item.level === 1"></i>
                      <i class="mdi mdi-clipboard-text me-2" *ngIf="progress.item.level === 0 || !progress.item.level"></i>
                      <span *ngIf="progress.item.level === 1" class="badge bg-secondary me-2">Sub-item</span>
                      {{progress.item.title}}
                    </h5>
                    <span class="badge bg-primary" *ngIf="progress.item.level === 0 || !progress.item.level">
                      {{getItemLabel(progress)}} of {{getTotalItemsCount()}}
                    </span>
                  </div>
                  <p class="text-muted mb-0" *ngIf="progress.item.description">
                    {{progress.item.description}}
                  </p>
                </div>
              </div>

              <!-- Side-by-Side Layout for Photos and Sample -->
              <div class="row g-4 mb-4">
                
                <!-- Photo Requirements Info Bar (spans both columns) -->
                <div class="col-12" *ngIf="progress.item.photo_requirements">
                  <div class="border rounded p-2 bg-info bg-opacity-10 border-info border-opacity-25">
                    <div class="row g-2 small text-info-emphasis">
                      <div class="col-auto" *ngIf="progress.item.photo_requirements.min_photos || progress.item.min_photos">
                        <i class="mdi mdi-image-multiple me-1"></i>
                        <strong>{{progress.item.photo_requirements.min_photos || progress.item.min_photos || 0}}</strong> photo required
                      </div>
                      <div class="col-auto" *ngIf="progress.item.photo_requirements.angle">
                        <i class="mdi mdi-angle-acute me-1"></i>
                        <strong>Angle:</strong> {{progress.item.photo_requirements.angle}}
                      </div>
                      <div class="col-auto" *ngIf="progress.item.photo_requirements.focus">
                        <i class="mdi mdi-target me-1"></i>
                        <strong>Focus:</strong> {{progress.item.photo_requirements.focus}}
                      </div>
                      <div class="col-auto" *ngIf="progress.item.photo_requirements.distance">
                        <i class="mdi mdi-ruler me-1"></i>
                        <strong>Distance:</strong> {{progress.item.photo_requirements.distance}}
                      </div>
                      <div class="col-auto" *ngIf="progress.item.photo_requirements.lighting">
                        <i class="mdi mdi-lightbulb me-1"></i>
                        <strong>Lighting:</strong> {{progress.item.photo_requirements.lighting}}
                      </div>
                    </div>
                  </div>
                </div>

                <!-- Photo Section - Inline -->
                <div class="col-md-6">
                  <div class="h-100">
                    <h6 class="text-primary mb-3 d-flex align-items-center">
                      <i class="mdi mdi-camera me-2"></i>Take Photo
                      <span class="badge bg-secondary ms-auto" *ngIf="progress.photos && progress.photos.length > 0">Photo uploaded</span>
                      <span class="badge bg-outline-secondary ms-auto" *ngIf="!progress.photos || progress.photos.length === 0">No photo</span>
                    </h6>
                    
                    <!-- Photo Upload Area -->
                    <div class="border border-2 border-dashed rounded p-4 text-center" 
                         style="min-height: 280px; display: flex; flex-direction: column; justify-content: center;"
                         *ngIf="!progress.photos || progress.photos.length === 0">
                      <i class="mdi mdi-camera-plus text-muted fs-1 mb-2"></i>
                      <p class="text-muted mb-3">Take or upload a photo following the requirements above</p>
                      <input type="file" 
                             #fileInput 
                             (change)="onFileSelected($event, progress.item.id)" 
                             accept="image/*" 
                             class="d-none">
                      <button class="btn btn-outline-primary" 
                              (click)="fileInput.click()">
                        <i class="mdi mdi-camera me-2"></i>Add Photo
                      </button>
                    </div>

                    <!-- Current Photo -->
                    <div *ngIf="progress.photos && progress.photos.length > 0">
                      <input type="file" 
                             #replaceFileInput 
                             (change)="onFileSelected($event, progress.item.id)" 
                             accept="image/*" 
                             class="d-none">
                      <div class="position-relative border rounded" 
                           style="min-height: 280px; display: flex; align-items: center; justify-content: center;">
                        <img [src]="getPhotoUrl(progress.photos[0])" 
                             class="img-fluid rounded shadow-sm" 
                             style="max-height: 250px; max-width: 100%; object-fit: contain;">
                        <button class="btn btn-sm btn-danger position-absolute top-0 end-0 m-2" 
                                (click)="deletePhoto(progress.photos[0], progress.item.id)"
                                title="Delete Photo">
                          <i class="mdi mdi-close"></i>
                        </button>
                      </div>
                      <div class="mt-2 text-center">
                        <button class="btn btn-outline-secondary btn-sm" 
                                (click)="replaceFileInput.click()">
                          <i class="mdi mdi-camera-refresh me-1"></i>Replace Photo
                        </button>
                      </div>
                    </div>
                  </div>
                </div>

                <!-- Sample Reference Section - Inline -->
                <div class="col-md-6">
                  <div class="h-100">
                    <h6 class="text-primary mb-3">
                      <i class="mdi mdi-image-multiple me-2"></i>Sample Reference
                    </h6>
                    
                    <!-- Sample Image Display -->
                    <div class="border rounded p-3" 
                         style="min-height: 280px; display: flex; flex-direction: column; justify-content: center;"
                         *ngIf="progress.item.sample_image_url; else noSampleImage">
                      <div class="text-center">
                        <img [src]="getPhotoUrl(progress.item.sample_image_url)" 
                             class="img-fluid rounded shadow-sm" 
                             style="max-height: 200px; object-fit: contain;"
                             [alt]="'Sample reference for ' + progress.item.title"
                             (error)="onSampleImageError($event)">
                        <div class="mt-2">
                          <small class="text-muted">Reference image for this checklist item</small>
                        </div>
                      </div>
                    </div>
                    
                    <!-- No Sample Image Template -->
                    <ng-template #noSampleImage>
                      <div class="border rounded p-4 h-100 d-flex align-items-center justify-content-center" 
                           style="min-height: 280px;">
                        <div class="text-center text-muted">
                          <i class="mdi mdi-image-off fs-1 mb-2"></i>
                          <p class="mb-0">No reference images available</p>
                        </div>
                      </div>
                    </ng-template>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Review Mode - Unified List -->
          <div *ngIf="isReviewMode">
            <!-- Review Mode Header -->
            <div class="d-flex justify-content-between align-items-center mb-4 p-3 bg-light bg-opacity-50 rounded">
              <div class="d-flex align-items-center">
                <i class="mdi mdi-eye text-primary me-2 fs-5"></i>
                <h6 class="mb-0 text-primary">Review Mode</h6>
              </div>
              <div class="text-muted small">
                {{getCompletedItemsCount()}} / {{getTotalItemsCount()}} items completed
              </div>
            </div>

            <!-- Simple Checklist Items List -->
            <div class="border rounded">
              <div class="border-bottom p-4" 
                   *ngFor="let progress of itemProgress; let i = index"
                   [class.bg-success-subtle]="progress.completed"
                   [class.ms-4]="progress.item.level === 1"
                   [class.border-start]="progress.item.level === 1"
                   [class.border-primary]="progress.item.level === 1"
                   [class.border-3]="progress.item.level === 1">
                
                <!-- Item Header -->
                <div class="d-flex justify-content-between align-items-start mb-3">
                  <div class="d-flex align-items-center">
                    <div class="me-3">
                      <i class="mdi mdi-check-circle text-success fs-4" *ngIf="progress.completed"></i>
                      <i class="mdi mdi-circle-outline text-muted fs-4" *ngIf="!progress.completed"></i>
                    </div>
                    <div>
                      <h6 class="mb-1 fw-semibold">
                        <i class="mdi mdi-subdirectory-arrow-right me-2" *ngIf="progress.item.level === 1"></i>
                        <span *ngIf="progress.item.level === 1" class="badge bg-secondary me-2">Sub-item</span>
                        {{getItemLabel(progress)}}: {{progress.item?.title}}
                      </h6>
                      <p class="text-muted small mb-0" *ngIf="progress.item?.description">
                        {{progress.item.description}}
                      </p>
                    </div>
                  </div>
                  <div class="d-flex align-items-center gap-2">
                    <span class="badge bg-success" *ngIf="progress.completed">Complete</span>
                    <span class="badge bg-secondary" *ngIf="!progress.completed">Pending</span>
                    <button class="btn btn-outline-primary btn-sm" 
                            (click)="navigateToPhotoMode(i)">
                      <i class="mdi mdi-camera me-1"></i>Take Photo
                    </button>
                  </div>
                </div>

                <!-- Photos Display -->
                <div *ngIf="progress.photos && progress.photos.length > 0">
                  <div class="mb-2">
                    <img [src]="getPhotoUrl(progress.photos[0])" 
                         class="rounded shadow-sm" 
                         style="width: 120px; height: 120px; object-fit: cover;">
                    <button class="btn btn-sm btn-danger position-absolute top-0 end-0 m-1" 
                            (click)="deletePhoto(progress.photos[0], progress.item.id)"
                            title="Delete Photo"
                            style="--bs-btn-padding-y: 0.1rem; --bs-btn-padding-x: 0.3rem;">
                      <i class="mdi mdi-close" style="font-size: 0.75rem;"></i>
                    </button>
                  </div>
                </div>

                <!-- No Photos Message -->
                <div class="text-center py-3 text-muted" *ngIf="!progress.photos || progress.photos.length === 0">
                  <i class="mdi mdi-camera-off fs-3 text-muted opacity-50"></i>
                  <p class="mb-0">No photo taken for this item</p>
                </div>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Card Footer with Controls -->
        <div class="card-footer bg-light border-top d-flex justify-content-between align-items-center p-3">
          
          <!-- Photo Mode: Navigation Controls -->
          <div *ngIf="!isReviewMode">
            <button class="btn btn-outline-secondary me-2" 
                    (click)="previousItem()" 
                    [disabled]="isFirstItem()">
              <i class="mdi mdi-chevron-left me-1"></i>Previous
            </button>
            <button class="btn btn-outline-secondary" 
                    (click)="nextItem()" 
                    [disabled]="isLastItem()">
              Next<i class="mdi mdi-chevron-right ms-1"></i>
            </button>
          </div>

          <!-- Review Mode: Mode Toggle -->
          <div *ngIf="isReviewMode">
            <div class="btn-group" role="group">
              <input type="radio" 
                     class="btn-check" 
                     name="viewMode" 
                     id="photoMode" 
                     [checked]="!isReviewMode"
                     (change)="isReviewMode = false">
              <label class="btn btn-outline-primary" for="photoMode">
                <i class="mdi mdi-camera me-1"></i>Take Photos
              </label>

              <input type="radio" 
                     class="btn-check" 
                     name="viewMode" 
                     id="reviewMode" 
                     [checked]="isReviewMode"
                     (change)="isReviewMode = true">
              <label class="btn btn-outline-primary" for="reviewMode">
                <i class="mdi mdi-eye me-1"></i>Review
              </label>
            </div>
          </div>

          <!-- Primary Submit Button (Always Visible) -->
          <button type="submit" 
                  class="btn btn-success" 
                  [disabled]="saving || instance?.status === 'completed' || instance?.status === 'submitted'" 
                  (click)="submitChecklist()">
            @if (saving) {
              <span class="spinner-border spinner-border-sm me-2" role="status"></span>
              Submitting...
            } @else {
              <i class="mdi mdi-check-circle-outline me-1"></i>
              {{ instance?.status === 'completed' || instance?.status === 'submitted' ? 'Completed' : 'Submit Checklist' }}
            }
          </button>
        </div>
      </div>
      
    </div>
  </div>
</div>
