<div class="container-fluid" *ngIf="loading">
  <div class="row justify-content-center">
    <div class="col-12 col-lg-11 col-xl-10 col-xxl-7">
      <div class="card shadow-sm border-0">
        <div class="card-body text-center p-5" style="min-height:300px">
          <div class="mb-4">
            <div class="spinner-border text-primary" role="status" style="width: 4rem; height: 4rem;"></div>
          </div>
          <h4 class="text-muted mb-3">Loading checklist instance...</h4>
          <div class="progress mx-auto" style="width: 200px; height: 4px;">
            <div class="progress-bar progress-bar-striped progress-bar-animated" style="width: 100%"></div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="container-fluid" *ngIf="!loading && !instance">
  <div class="row justify-content-center">
    <div class="col-12 col-lg-11 col-xl-10 col-xxl-7">
      <div class="card shadow-sm border-0">
        <div class="card-body text-center p-5" style="min-height:300px">
          <div class="mb-4">
            <i class="mdi mdi-alert-circle-outline text-warning" style="font-size: 4rem;"></i>
          </div>
          <h4 class="text-muted mb-3">Checklist Instance Not Found</h4>
          <p class="text-muted mb-4">The checklist instance you're looking for doesn't exist or has been removed.</p>
          <button class="btn btn-primary" (click)="goBack()">
            <i class="mdi mdi-format-list-bulleted me-2"></i>Back to Checklists
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="container-fluid" [hidden]="loading || !instance || !template">
  <div class="row justify-content-center">
    <div class="col-12 col-lg-11 col-xl-10 col-xxl-8">
      
      <!-- Page Header with Context -->
      <div class="mb-4">
        <div class="d-flex align-items-center mb-3">
          <button 
            type="button" 
            class="btn btn-outline-secondary me-3"
            (click)="goBack()"
            title="Back to Checklists">
            <i class="mdi mdi-arrow-left me-2"></i>Back
          </button>
          <div class="bg-primary bg-gradient rounded-circle me-3 d-flex align-items-center justify-content-center" style="width: 60px; height: 60px;">
            <i class="mdi mdi-clipboard-check text-white fs-4"></i>
          </div>
          <div class="flex-grow-1">
            <h2 class="mb-1 text-primary">{{template?.name || 'Checklist Instance'}}</h2>
            <p class="text-muted mb-0">Progress: {{getCompletedItemsCount()}} of {{getTotalItemsCount()}} items completed</p>
          </div>
          <button 
            type="button" 
            class="btn btn-outline-primary"
            (click)="openFullChecklistModal()"
            title="View Full Checklist Table">
            <i class="mdi mdi-table me-2"></i>Full View
          </button>
        </div>
        
        <div class="alert alert-success border-success border-opacity-25 bg-success bg-opacity-10" role="alert" 
             *ngIf="instance?.status === 'completed' || instance?.status === 'submitted'">
          <div class="d-flex align-items-start">
            <i class="mdi mdi-check-circle text-success me-3 mt-1 fs-5"></i>
            <div>
              <h6 class="alert-heading text-success mb-2">Checklist Completed</h6>
              <p class="mb-2">
                Checklist {{instance?.status}} on: {{instance?.updated_at | date:'medium'}}
              </p>
            </div>
          </div>
        </div>

        <!-- Work Order Information Card -->
        <div class="card shadow-sm border-0 mb-4" *ngIf="instance">
          <div class="card-body p-4">
            <h5 class="card-title mb-3">
              <i class="mdi mdi-information-outline me-2"></i>
              Work Order Information
            </h5>
            <div class="row g-3">
              <div class="col-md-3 col-sm-6" *ngIf="instance.work_order_number">
                <div class="d-flex flex-column">
                  <small class="text-muted text-uppercase fw-semibold mb-1">Work Order</small>
                  <span class="text-primary fw-bold">{{ instance.work_order_number }}</span>
                </div>
              </div>
              <div class="col-md-3 col-sm-6" *ngIf="instance.part_number">
                <div class="d-flex flex-column">
                  <small class="text-muted text-uppercase fw-semibold mb-1">Part Number</small>
                  <span class="text-dark">{{ instance.part_number }}</span>
                </div>
              </div>
              <div class="col-md-3 col-sm-6" *ngIf="instance.serial_number">
                <div class="d-flex flex-column">
                  <small class="text-muted text-uppercase fw-semibold mb-1">Serial Number</small>
                  <span class="text-dark">{{ instance.serial_number }}</span>
                </div>
              </div>
              <div class="col-md-3 col-sm-6" *ngIf="instance.operator_name">
                <div class="d-flex flex-column">
                  <small class="text-muted text-uppercase fw-semibold mb-1">Operator</small>
                  <span class="text-dark">{{ instance.operator_name }}</span>
                </div>
              </div>
            </div>
            <div class="row g-3 mt-2" *ngIf="template?.version || template?.description">
              <div class="col-md-3 col-sm-6" *ngIf="template?.version">
                <div class="d-flex flex-column">
                  <small class="text-muted text-uppercase fw-semibold mb-1">Template Version</small>
                  <span class="text-muted">{{ template.version }}</span>
                </div>
              </div>
              <div class="col-md-9 col-sm-6" *ngIf="template?.description">
                <div class="d-flex flex-column">
                  <small class="text-muted text-uppercase fw-semibold mb-1">Description</small>
                  <span class="text-muted small">{{ template.description }}</span>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="card shadow-sm border-0" style="margin-bottom: 80px;">
        <div class="card-body p-4">
          
          <!-- Photo Taking Mode -->
          <div *ngIf="!isReviewMode">
            <div *ngFor="let progress of getCurrentItemsToShow(); let i = index; let first = first">
              
              <!-- Separator between parent and sub-items -->
              <div *ngIf="i > 0 && progress.item.level === 1 && first" class="my-4">
                <div class="border-top pt-3">
                  <h6 class="text-muted text-uppercase small mb-3">
                    <i class="mdi mdi-subdirectory-arrow-right me-2"></i>Related Sub-items
                  </h6>
                </div>
              </div>
              
              <!-- Task Description - Inline -->
              <div class="mb-4" *ngIf="progress.item"
                   [class.ms-4]="progress.item.level === 1"
                   [class.mt-4]="i > 0 && progress.item.level === 1">
                <div class="p-3 rounded border-start border-primary border-4 bg-light bg-opacity-50"
                     [class.border-secondary]="progress.item.level === 1">
                  <div class="d-flex justify-content-between align-items-start mb-2">
                    <h5 class="mb-1"
                        [class.text-primary]="progress.item.level === 0 || !progress.item.level"
                        [class.text-secondary]="progress.item.level === 1">
                      <i class="mdi mdi-subdirectory-arrow-right me-2" *ngIf="progress.item.level === 1"></i>
                      <i class="mdi mdi-clipboard-text me-2" *ngIf="progress.item.level === 0 || !progress.item.level"></i>
                      <span *ngIf="progress.item.level === 1" class="badge bg-secondary me-2">Sub-item</span>
                      {{progress.item.title}}
                    </h5>
                    <span class="badge bg-primary" *ngIf="progress.item.level === 0 || !progress.item.level">
                      {{getItemLabel(progress)}} of {{getTotalItemsCount()}}
                    </span>
                  </div>
                  <div class="text-muted mb-0" *ngIf="progress.item.description" [innerHTML]="progress.item.description"></div>
                </div>
              </div>

              <!-- Reference Images Section (Below Description, excluding primary) - Small Avatar Style -->
              <div class="mb-4" *ngIf="progress.item.sample_images && progress.item.sample_images.length > 1">
                <h6 class="text-info mb-3">
                  <i class="mdi mdi-image-multiple me-2"></i>Reference Images
                  <span class="badge bg-info ms-2">
                    {{progress.item.sample_images.length - 1}} additional image{{(progress.item.sample_images.length - 1) > 1 ? 's' : ''}}
                  </span>
                </h6>
                
                <!-- Multiple Reference Images as Small Thumbnails (excluding primary) -->
                <div class="d-flex flex-wrap gap-2">
                  <div *ngFor="let sampleImage of progress.item.sample_images; let idx = index">
                    <!-- Skip the primary image (index 0) -->
                    <div *ngIf="idx > 0" 
                         class="reference-thumbnail-container position-relative"
                         [title]="sampleImage.label || 'Reference image ' + idx">
                      <img [src]="getPhotoUrl(sampleImage.url)" 
                           class="reference-thumbnail rounded border border-2 border-info cursor-pointer" 
                           style="width: 80px; height: 80px; object-fit: cover;"
                           [alt]="sampleImage.label || 'Reference image ' + idx"
                           (error)="onSampleImageError($event)"
                           (click)="previewImage(getPhotoUrl(sampleImage.url))">
                      <span *ngIf="sampleImage.type" 
                            class="position-absolute bottom-0 start-0 badge badge-sm m-1" 
                            style="font-size: 0.65rem;"
                            [class.bg-primary]="sampleImage.type === 'photo'"
                            [class.bg-info]="sampleImage.type === 'drawing'"
                            [class.bg-success]="sampleImage.type === 'bom'"
                            [class.bg-warning]="sampleImage.type === 'schematic'"
                            [class.bg-secondary]="sampleImage.type === 'reference' || sampleImage.type === 'diagram'">
                        {{sampleImage.type}}
                      </span>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Side-by-Side Layout for Photos and Sample -->
              <div class="row g-4 mb-4">
                
                <!-- Photo Requirements Info Bar (spans both columns) - Only show when pictures required -->
                <div class="col-12" *ngIf="progress.item.photo_requirements && progress.item.photo_requirements.picture_required">
                  <div class="border rounded p-2 bg-info bg-opacity-10 border-info border-opacity-25">
                    <div class="row g-2 small text-info-emphasis">
                      <div class="col-auto" *ngIf="progress.item.photo_requirements.min_photos || progress.item.min_photos">
                        <i class="mdi mdi-image-multiple me-1"></i>
                        <strong>{{progress.item.photo_requirements.min_photos || progress.item.min_photos || 0}}</strong> photo required
                      </div>
                      <div class="col-auto" *ngIf="progress.item.photo_requirements.angle">
                        <i class="mdi mdi-angle-acute me-1"></i>
                        <strong>Angle:</strong> {{progress.item.photo_requirements.angle}}
                      </div>
                      <div class="col-auto" *ngIf="progress.item.photo_requirements.focus">
                        <i class="mdi mdi-target me-1"></i>
                        <strong>Focus:</strong> {{progress.item.photo_requirements.focus}}
                      </div>
                      <div class="col-auto" *ngIf="progress.item.photo_requirements.distance">
                        <i class="mdi mdi-ruler me-1"></i>
                        <strong>Distance:</strong> {{progress.item.photo_requirements.distance}}
                      </div>
                      <div class="col-auto" *ngIf="progress.item.photo_requirements.lighting">
                        <i class="mdi mdi-lightbulb me-1"></i>
                        <strong>Lighting:</strong> {{progress.item.photo_requirements.lighting}}
                      </div>
                    </div>
                  </div>
                </div>

                <!-- Optional Photo Verification (when photos not required) -->
                <div class="col-12" *ngIf="progress.item.photo_requirements && !progress.item.photo_requirements.picture_required && (!progress.photos || progress.photos.length === 0)">
                  <div class="alert mb-0 d-flex align-items-center justify-content-between"
                       [ngClass]="progress.completed ? 'alert-success' : 'alert-info'">
                    <div>
                      <i class="mdi me-2" [ngClass]="progress.completed ? 'mdi-check-circle' : 'mdi-information-outline'"></i>
                      <strong>Photos are optional for this item.</strong> 
                      <span *ngIf="!progress.completed">You can verify completion without taking photos.</span>
                      <span *ngIf="progress.completed">This item has been verified without photos.</span>
                    </div>
                    <button class="btn btn-sm" 
                            [ngClass]="progress.completed ? 'btn-outline-warning' : 'btn-success'"
                            (click)="toggleVerification()">
                      <i class="mdi me-1" [ngClass]="progress.completed ? 'mdi-close-circle' : 'mdi-check-circle'"></i>
                      {{ progress.completed ? 'Unmark Verified' : 'Mark as Verified' }}
                    </button>
                  </div>
                </div>

                <!-- Photo Section - Inline (Only show when pictures required OR photos already exist) -->
                <div class="col-md-6" *ngIf="progress.item.photo_requirements?.picture_required || (progress.photos && progress.photos.length > 0)">
                  <div class="h-100">
                    <h6 class="text-primary mb-3 d-flex align-items-center">
                      <i class="mdi mdi-camera me-2"></i>Take Photo
                      <span class="badge bg-secondary ms-auto" *ngIf="progress.photos && progress.photos.length > 0">Photo uploaded</span>
                      <span class="badge bg-outline-secondary ms-auto" *ngIf="!progress.photos || progress.photos.length === 0">No photo</span>
                    </h6>
                    
                    <!-- Photo Upload Area -->
                    <div class="border border-2 border-dashed rounded p-4 text-center" 
                         style="min-height: 280px; display: flex; flex-direction: column; justify-content: center;"
                         *ngIf="!progress.photos || progress.photos.length === 0">
                      <i class="mdi mdi-camera-plus text-muted fs-1 mb-2"></i>
                      <p class="text-muted mb-3">Take or upload a photo following the requirements above</p>
                      <input type="file" 
                             #fileInput 
                             (change)="onFileSelected($event, progress.item.id)" 
                             accept="image/*" 
                             class="d-none">
                      <button class="btn btn-outline-primary" 
                              (click)="fileInput.click()">
                        <i class="mdi mdi-camera me-2"></i>Add Photo
                      </button>
                    </div>

                    <!-- Current Photo -->
                    <div *ngIf="progress.photos && progress.photos.length > 0">
                      <input type="file" 
                             #replaceFileInput 
                             (change)="onFileSelected($event, progress.item.id)" 
                             accept="image/*" 
                             class="d-none">
                      <div class="position-relative border rounded" 
                           style="min-height: 280px; display: flex; align-items: center; justify-content: center;">
                        <img [src]="getPhotoUrl(progress.photos[0])" 
                             class="img-fluid rounded shadow-sm" 
                             style="max-height: 250px; max-width: 100%; object-fit: contain;">
                        <button class="btn btn-sm btn-danger position-absolute top-0 end-0 m-2" 
                                (click)="deletePhoto(progress.photos[0], progress.item.id)"
                                title="Delete Photo">
                          <i class="mdi mdi-close"></i>
                        </button>
                      </div>
                      <div class="mt-2 text-center">
                        <button class="btn btn-outline-secondary btn-sm" 
                                (click)="replaceFileInput.click()">
                          <i class="mdi mdi-camera-refresh me-1"></i>Replace Photo
                        </button>
                      </div>
                    </div>
                  </div>
                </div>

                <!-- Sample Reference Section - Primary Image Only (Only show when pictures required OR photos already exist) -->
                <div class="col-md-6" *ngIf="progress.item.photo_requirements?.picture_required || (progress.photos && progress.photos.length > 0)">
                  <div class="h-100">
                    <h6 class="text-primary mb-3">
                      <i class="mdi mdi-image-multiple me-2"></i>Sample Reference
                    </h6>
                    
                    <!-- Primary Sample Image Display -->
                    <div class="border rounded p-3" 
                         style="min-height: 280px; display: flex; flex-direction: column; justify-content: center;"
                         *ngIf="progress.item.sample_images && progress.item.sample_images.length > 0; else noSampleImage">
                      <div class="text-center">
                        <img [src]="getPhotoUrl(progress.item.sample_images[0].url)" 
                             class="img-fluid rounded shadow-sm cursor-pointer" 
                             style="max-height: 200px; object-fit: contain;"
                             [alt]="progress.item.sample_images[0].label || 'Sample reference for ' + progress.item.title"
                             (error)="onSampleImageError($event)"
                             (click)="previewImage(getPhotoUrl(progress.item.sample_images[0].url))">
                        <div class="mt-2" *ngIf="progress.item.sample_images[0].label || progress.item.sample_images[0].description">
                          <small class="text-muted d-block" *ngIf="progress.item.sample_images[0].label">
                            <strong>{{progress.item.sample_images[0].label}}</strong>
                          </small>
                          <small class="text-muted" *ngIf="progress.item.sample_images[0].description">
                            {{progress.item.sample_images[0].description}}
                          </small>
                        </div>
                      </div>
                    </div>
                    
                    <!-- No Sample Image Template -->
                    <ng-template #noSampleImage>
                      <div class="border rounded p-4 h-100 d-flex align-items-center justify-content-center" 
                           style="min-height: 280px;">
                        <div class="text-center text-muted">
                          <i class="mdi mdi-image-off fs-1 mb-2"></i>
                          <p class="mb-0">No reference images available</p>
                        </div>
                      </div>
                    </ng-template>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Review Mode - Unified List -->
          <div *ngIf="isReviewMode">
            <!-- Review Mode Header -->
            <div class="d-flex justify-content-between align-items-center mb-4 p-3 bg-light bg-opacity-50 rounded">
              <div class="d-flex align-items-center">
                <i class="mdi mdi-eye text-primary me-2 fs-5"></i>
                <h6 class="mb-0 text-primary">Review Mode</h6>
              </div>
              <div class="text-muted small">
                {{getCompletedItemsCount()}} / {{getTotalItemsCount()}} items completed
              </div>
            </div>

            <!-- Simple Checklist Items List -->
            <div class="border rounded">
              <div class="border-bottom p-4" 
                   *ngFor="let progress of itemProgress; let i = index"
                   [class.bg-success-subtle]="progress.completed"
                   [class.ms-4]="progress.item.level === 1"
                   [class.border-start]="progress.item.level === 1"
                   [class.border-primary]="progress.item.level === 1"
                   [class.border-3]="progress.item.level === 1">
                
                <!-- Item Header -->
                <div class="d-flex justify-content-between align-items-start mb-3">
                  <div class="d-flex align-items-center">
                    <div class="me-3">
                      <i class="mdi mdi-check-circle text-success fs-4" *ngIf="progress.completed"></i>
                      <i class="mdi mdi-circle-outline text-muted fs-4" *ngIf="!progress.completed"></i>
                    </div>
                    <div>
                      <h6 class="mb-1 fw-semibold">
                        <i class="mdi mdi-subdirectory-arrow-right me-2" *ngIf="progress.item.level === 1"></i>
                        <span *ngIf="progress.item.level === 1" class="badge bg-secondary me-2">Sub-item</span>
                        {{getItemLabel(progress)}}: {{progress.item?.title}}
                      </h6>
                      <div class="text-muted small mb-0" *ngIf="progress.item?.description" [innerHTML]="progress.item.description"></div>
                    </div>
                  </div>
                  <div class="d-flex align-items-center gap-2">
                    <span class="badge bg-success" *ngIf="progress.completed">Complete</span>
                    <span class="badge bg-secondary" *ngIf="!progress.completed">Pending</span>
                    <button class="btn btn-outline-primary btn-sm" 
                            (click)="navigateToPhotoMode(i)">
                      <i class="mdi mdi-camera me-1"></i>Take Photo
                    </button>
                  </div>
                </div>

                <!-- Photos Display -->
                <div *ngIf="progress.photos && progress.photos.length > 0">
                  <div class="mb-2">
                    <img [src]="getPhotoUrl(progress.photos[0])" 
                         class="rounded shadow-sm" 
                         style="width: 120px; height: 120px; object-fit: cover;">
                    <button class="btn btn-sm btn-danger position-absolute top-0 end-0 m-1" 
                            (click)="deletePhoto(progress.photos[0], progress.item.id)"
                            title="Delete Photo"
                            style="--bs-btn-padding-y: 0.1rem; --bs-btn-padding-x: 0.3rem;">
                      <i class="mdi mdi-close" style="font-size: 0.75rem;"></i>
                    </button>
                  </div>
                </div>

                <!-- No Photos Message -->
                <div class="text-center py-3 text-muted" *ngIf="!progress.photos || progress.photos.length === 0">
                  <i class="mdi mdi-camera-off fs-3 text-muted opacity-50"></i>
                  <p class="mb-0">No photo taken for this item</p>
                </div>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Card Footer with Controls - Fixed at Bottom -->
        <div class="card-footer bg-white border-top d-flex justify-content-between align-items-center p-3 shadow-lg"
             style="position: fixed; bottom: 0; left: auto; right: 0; z-index: 1030; max-width: calc(100% - 240px); margin-left: 240px;">
          
          <!-- Photo Mode: Navigation Controls -->
          <div *ngIf="!isReviewMode">
            <button class="btn btn-outline-secondary me-2" 
                    (click)="previousItem()" 
                    [disabled]="isFirstItem()">
              <i class="mdi mdi-chevron-left me-1"></i>Previous
            </button>
            <button class="btn btn-outline-secondary" 
                    (click)="nextItem()" 
                    [disabled]="isLastItem()">
              Next<i class="mdi mdi-chevron-right ms-1"></i>
            </button>
          </div>

          <!-- Review Mode: Mode Toggle -->
          <div *ngIf="isReviewMode">
            <div class="btn-group" role="group">
              <input type="radio" 
                     class="btn-check" 
                     name="viewMode" 
                     id="photoMode" 
                     [checked]="!isReviewMode"
                     (change)="isReviewMode = false">
              <label class="btn btn-outline-primary" for="photoMode">
                <i class="mdi mdi-camera me-1"></i>Take Photos
              </label>

              <input type="radio" 
                     class="btn-check" 
                     name="viewMode" 
                     id="reviewMode" 
                     [checked]="isReviewMode"
                     (change)="isReviewMode = true">
              <label class="btn btn-outline-primary" for="reviewMode">
                <i class="mdi mdi-eye me-1"></i>Review
              </label>
            </div>
          </div>

          <!-- Primary Submit Button (Always Visible) -->
          <button type="submit" 
                  class="btn btn-success" 
                  [disabled]="saving || instance?.status === 'completed' || instance?.status === 'submitted'" 
                  (click)="submitChecklist()">
            @if (saving) {
              <span class="spinner-border spinner-border-sm me-2" role="status"></span>
              Submitting...
            } @else {
              <i class="mdi mdi-check-circle-outline me-1"></i>
              {{ instance?.status === 'completed' || instance?.status === 'submitted' ? 'Completed' : 'Submit Checklist' }}
            }
          </button>
        </div>
      </div>
      
    </div>
  </div>
</div>

<!-- Image Preview Modal -->
<div class="modal fade show" 
     *ngIf="showImagePreview" 
     style="display: block; background: rgba(0,0,0,0.8);"
     (click)="closeImagePreview()">
  <div class="modal-dialog modal-xl modal-dialog-centered">
    <div class="modal-content bg-transparent border-0">
      <div class="modal-header border-0 pb-0">
        <button 
          type="button" 
          class="btn-close btn-close-white ms-auto"
          (click)="closeImagePreview()"
          aria-label="Close">
        </button>
      </div>
      <div class="modal-body text-center p-4" (click)="$event.stopPropagation()">
        <img 
          [src]="previewImageUrl" 
          class="img-fluid rounded shadow-lg" 
          style="max-height: 80vh; max-width: 100%; object-fit: contain;"
          alt="Preview image">
      </div>
      <div class="modal-footer border-0 justify-content-center pt-0">
        <button 
          type="button" 
          class="btn btn-light btn-sm"
          (click)="openImageInNewTab()">
          <i class="mdi mdi-open-in-new me-1"></i>Open in New Tab
        </button>
        <button 
          type="button" 
          class="btn btn-secondary btn-sm"
          (click)="closeImagePreview()">
          <i class="mdi mdi-close me-1"></i>Close
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Full Checklist Overview Modal -->
<div class="modal fade show" 
     *ngIf="showFullChecklistModal" 
     style="display: block; background: rgba(0,0,0,0.5);"
     (click)="closeFullChecklistModal()">
  <div class="modal-dialog modal-fullscreen modal-dialog-scrollable">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <div class="modal-header bg-primary text-white">
        <h5 class="modal-title">
          <i class="mdi mdi-clipboard-list-outline me-2"></i>
          Full Checklist Overview - {{ template?.name }}
        </h5>
        <button 
          type="button" 
          class="btn-close btn-close-white"
          (click)="closeFullChecklistModal()"
          aria-label="Close">
        </button>
      </div>
      <div class="modal-body p-4" style="overflow-x: auto;">
        <div class="table-responsive">
          <table class="table table-bordered table-hover align-middle">
            <thead class="table-light sticky-top">
              <tr>
                <th style="width: 50px;" class="text-center">#</th>
                <th style="width: 300px;">Task</th>
                <th style="width: 250px;">Description</th>
                <th style="width: 120px;" class="text-center">Status</th>
                <th style="width: 200px;">Photos</th>
                <th style="width: 250px;">Notes</th>
                <th style="width: 100px;" class="text-center">Actions</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let progress of itemProgress; let i = index"
                  [class.table-primary]="currentStep === i + 1">
                <td class="text-center fw-bold">{{ i + 1 }}</td>
                <td>
                  <div class="fw-semibold">{{ progress.item.title }}</div>
                  <span class="badge bg-danger badge-sm mt-1" *ngIf="progress.item.is_required">Required</span>
                </td>
                <td>
                  <div class="small text-muted" style="max-height: 60px; overflow-y: auto;">
                    <div [innerHTML]="progress.item.description || 'N/A'"></div>
                  </div>
                </td>
                <td class="text-center">
                  <span class="badge" [ngClass]="getStatusBadgeClass(progress)">
                    {{ getStatusText(progress) }}
                  </span>
                  <div class="small text-muted mt-1" *ngIf="progress.photos.length > 0">
                    {{ progress.photos.length }} photo(s)
                  </div>
                </td>
                <td>
                  <div class="d-flex flex-wrap gap-2" *ngIf="progress.photos.length > 0">
                    <div *ngFor="let photo of progress.photos; let photoIdx = index" class="position-relative">
                      <img 
                        [src]="getPhotoUrl(photo)" 
                        class="img-thumbnail cursor-pointer"
                        style="width: 60px; height: 60px; object-fit: cover;"
                        alt="Photo"
                        (click)="previewImage(getPhotoUrl(photo))"
                        [title]="'Photo ' + (photoIdx + 1)">
                    </div>
                  </div>
                  <span class="text-muted small fst-italic" *ngIf="progress.photos.length === 0">No photos taken</span>
                </td>
                <td>
                  <div class="small" style="max-height: 60px; overflow-y: auto;" 
                       [title]="progress.notes || ''">
                    {{ progress.notes || '-' }}
                  </div>
                </td>
                <td class="text-center">
                  <button 
                    type="button" 
                    class="btn btn-sm btn-outline-primary"
                    (click)="navigateToItemFromModal(i)"
                    title="Go to this item">
                    <i class="mdi mdi-arrow-right"></i>
                    Go
                  </button>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
      <div class="modal-footer">
        <div class="me-auto">
          <strong>Progress:</strong> {{ getCompletedItemsCount() }} of {{ getTotalItemsCount() }} items completed 
          ({{ ((getCompletedItemsCount() / getTotalItemsCount()) * 100).toFixed(0) }}%)
        </div>
        <button 
          type="button" 
          class="btn btn-secondary"
          (click)="closeFullChecklistModal()">
          <i class="mdi mdi-close me-2"></i>Close
        </button>
      </div>
    </div>
  </div>
</div>
