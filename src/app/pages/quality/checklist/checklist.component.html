<div class="container-fluid">
  <div class="row justify-content-center">
    <div class="col-12">
      
      <!-- Breadcrumb -->
      <nav aria-label="breadcrumb" class="mb-3">
        <ol class="breadcrumb mb-0">
          <li class="breadcrumb-item">
            <a href="#" class="text-decoration-none" (click)="$event.preventDefault()">
              <i class="mdi mdi-home-outline me-1"></i>Quality
            </a>
          </li>
          <li class="breadcrumb-item active" aria-current="page">
            Photo Checklists
          </li>
        </ol>
      </nav>
      
      <!-- Page Header with Context -->
      <div class="mb-4">
        <div class="d-flex align-items-center justify-content-between mb-3">
          <div class="d-flex align-items-center">
            <div class="bg-primary bg-gradient rounded-circle me-3 d-flex align-items-center justify-content-center" style="width: 60px; height: 60px;">
              <i class="mdi mdi-clipboard-check text-white fs-4"></i>
            </div>
            <div>
              <h2 class="mb-1 text-primary">Photo Checklists</h2>
              <p class="text-muted mb-0">Manage photo documentation for quality control</p>
            </div>
          </div>
          <div class="d-flex gap-2">
            <button class="btn btn-outline-success" [routerLink]="['./execution']" [relativeTo]="route">
              <i class="mdi mdi-clipboard-list me-2"></i>
              Open Instances
            </button>
            <button class="btn btn-outline-info" [routerLink]="['../checklist-audit']" [relativeTo]="route">
              <i class="mdi mdi-file-chart me-2"></i>
              Audit Reports
            </button>
            <button class="btn btn-primary" [routerLink]="['../template-manager']" [relativeTo]="route">
              <i class="mdi mdi-cog me-2"></i>
              Manage Templates
            </button>
          </div>
        </div>
        
        <div class="alert alert-primary border-primary border-opacity-25 bg-primary bg-opacity-10" role="alert">
          <div class="d-flex align-items-start">
            <i class="mdi mdi-information text-primary me-3 mt-1 fs-5"></i>
            <div>
              <h6 class="alert-heading text-primary mb-2">Photo Checklist Overview</h6>
              <p class="mb-0">
                Photo checklists provide <strong>structured documentation</strong> for quality control processes. 
                Each template defines required photos and inspection points for consistent quality verification.
              </p>
            </div>
          </div>
        </div>
      </div>

      <div class="card shadow-sm border-0">
        <!-- Card Header with View Selector -->
        <div class="card-header">
          <div class="d-flex align-items-center justify-content-between">
            <div class="d-flex align-items-center">
              <h5 class="card-title mb-0">
                <i class="mdi mdi-clipboard-check me-2 text-primary"></i>
                Photo Checklist Management
              </h5>
            </div>
            <div class="d-flex align-items-center gap-3">
              <div class="d-flex align-items-center">
                <label class="form-label mb-0 me-2 fw-semibold">View:</label>
                <select class="form-select form-select-sm" 
                        [(ngModel)]="activeTab" 
                        (ngModelChange)="switchTab($event)"
                        style="min-width: 180px;">
                  <option value="templates">
                    ðŸ“‹ Available Templates
                  </option>
                  <option value="instances">
                    âœ… Active Checklists
                  </option>
                </select>
              </div>
              <button class="btn btn-outline-secondary btn-sm" 
                      *ngIf="activeTab === 'templates'" 
                      title="Refresh templates">
                <i class="mdi mdi-refresh"></i>
              </button>
            </div>
          </div>
        </div>

        
        <!-- Tab Content -->
        <div class="card-body p-0">
          <div class="tab-content">
            
            <!-- Templates Tab -->
            <div *ngIf="activeTab === 'templates'" class="tab-pane-content">
              
              <!-- Loading State -->
              <div class="text-center p-5" *ngIf="loading">
                <div class="spinner-border text-primary" role="status"></div>
                <p class="mt-3 text-muted">Loading templates...</p>
              </div>

              <!-- Search and Filters -->
              <div class="card shadow-none border-top-0 mb-0" *ngIf="!loading">
                <div class="card-body">
                  <div class="row g-3">
                    <div class="col-md-4">
                      <label class="form-label">Search Templates</label>
                      <div class="input-group">
                        <span class="input-group-text">
                          <i class="mdi mdi-magnify"></i>
                        </span>
                        <input type="text" class="form-control" [(ngModel)]="templateSearch" 
                               placeholder="Search by name, description, part number..."
                               (ngModelChange)="onTemplateSearch()">
                        <button class="btn btn-outline-secondary" type="button" 
                                *ngIf="templateSearch" (click)="clearTemplateSearch()">
                          <i class="mdi mdi-close"></i>
                        </button>
                      </div>
                    </div>
                    <div class="col-md-3">
                      <label class="form-label">Category</label>
                      <select class="form-select" [(ngModel)]="templateFilters.category" (change)="onTemplateSearch()">
                        <option value="">All Categories</option>
                        <option value="assembly">Assembly</option>
                        <option value="inspection">Inspection</option>
                        <option value="testing">Testing</option>
                        <option value="packaging">Packaging</option>
                        <option value="shipping">Shipping</option>
                      </select>
                    </div>
                    <div class="col-md-3">
                      <label class="form-label">Product Type</label>
                      <input type="text" class="form-control" [(ngModel)]="templateFilters.productType" 
                             placeholder="Filter by product type..." (ngModelChange)="onTemplateSearch()">
                    </div>
                    <div class="col-md-2">
                      <label class="form-label">Status</label>
                      <select class="form-select" [(ngModel)]="templateFilters.activeOnly" (change)="onTemplateSearch()">
                        <option [ngValue]="null">All Templates</option>
                        <option [ngValue]="true">Active Only</option>
                        <option [ngValue]="false">Inactive Only</option>
                      </select>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Templates Content -->
              <div class="p-3" *ngIf="!loading">
                <!-- Results Summary -->
                <div class="d-flex justify-content-between align-items-center mb-3" *ngIf="templateSearch || hasActiveFilters()">
                  <small class="text-muted">
                    Showing {{getFilteredTemplates().length}} of {{templates.length}} templates
                    <span *ngIf="templateSearch"> for "{{templateSearch}}"</span>
                  </small>
                  <button class="btn btn-sm btn-outline-secondary" (click)="clearAllTemplateFilters()" 
                          *ngIf="templateSearch || hasActiveFilters()">
                    <i class="mdi mdi-filter-remove me-1"></i>
                    Clear Filters
                  </button>
                </div>

                <div class="table-responsive">
                  <table class="table table-hover mb-0">
                    <thead class="table-light">
                      <tr>
                        <th>Template Name</th>
                        <th>Category</th>
                        <th>Description</th>
                        <th>Part Number</th>
                        <th>Product Type</th>
                        <th>Items</th>
                        <th>Active Instances</th>
                        <th>Version</th>
                        <th>Actions</th>
                      </tr>
                    </thead>
                    <tbody>
                      <tr *ngFor="let template of getFilteredTemplates(); trackBy: trackByTemplateId" 
                          class="align-middle"
                          [class.table-primary]="selectedTemplate?.id === template.id">
                        <td>
                          <div class="fw-semibold" [innerHTML]="highlightSearchTerm(template.name, templateSearch)"></div>
                        </td>
                        <td>
                          <span class="badge bg-primary">{{template.category | titlecase}}</span>
                        </td>
                        <td>
                          <span class="text-muted" [innerHTML]="highlightSearchTerm(template.description || 'No description available', templateSearch)"></span>
                        </td>
                        <td>
                          <code *ngIf="template.part_number" [innerHTML]="highlightSearchTerm(template.part_number, templateSearch)"></code>
                          <span class="text-muted" *ngIf="!template.part_number">-</span>
                        </td>
                        <td>
                          <span *ngIf="template.product_type" [innerHTML]="highlightSearchTerm(template.product_type, templateSearch)"></span>
                          <span class="text-muted" *ngIf="!template.product_type">-</span>
                        </td>
                        <td>
                          <div class="text-center">
                            <div class="fw-semibold">{{template.item_count || 0}}</div>
                            <small class="text-muted">items</small>
                          </div>
                        </td>
                        <td>
                          <div class="text-center">
                            <div class="fw-semibold">{{template.active_instances || 0}}</div>
                            <small class="text-muted">active</small>
                          </div>
                        </td>
                        <td>
                          <span class="badge bg-secondary">v{{template.version}}</span>
                        </td>
                        <td>
                          <div class="d-flex gap-1">
                            <button class="btn btn-sm btn-outline-primary" 
                                    (click)="openPreviewModal(template)"
                                    title="Preview Template">
                              <i class="mdi mdi-eye"></i>
                            </button>
                            <button class="btn btn-sm btn-primary" 
                                    (click)="openCreateInstanceModal(template)"
                                    title="Start Checklist">
                              <i class="mdi mdi-plus"></i>
                            </button>
                          </div>
                        </td>
                      </tr>
                    </tbody>
                  </table>
                </div>

                <!-- Empty State -->
                <ng-container *ngIf="getFilteredTemplates().length === 0">
                  <div class="d-flex flex-column align-items-center justify-content-center p-5" *ngIf="templates.length > 0">
                    <div class="text-center" style="max-width: 500px;">
                      <div class="mb-4">
                        <div class="bg-primary bg-opacity-10 rounded-circle d-flex align-items-center justify-content-center mx-auto" style="width: 120px; height: 120px;">
                          <i class="mdi mdi-magnify text-primary" style="font-size: 3rem;"></i>
                        </div>
                      </div>
                      <h4 class="text-body-emphasis mb-3">No Templates Found</h4>
                      <p class="text-muted mb-4">Try adjusting your search criteria or filters</p>
                      <button class="btn btn-outline-primary" (click)="clearAllTemplateFilters()">
                        <i class="mdi mdi-filter-remove me-2"></i>
                        Clear All Filters
                      </button>
                    </div>
                  </div>

                  <!-- No Templates State -->
                  <div class="d-flex flex-column align-items-center justify-content-center p-5" *ngIf="templates.length === 0">
                    <div class="text-center" style="max-width: 500px;">
                      <div class="mb-4">
                        <div class="bg-primary bg-opacity-10 rounded-circle d-flex align-items-center justify-content-center mx-auto" style="width: 120px; height: 120px;">
                          <i class="mdi mdi-clipboard-list-outline text-primary" style="font-size: 3rem;"></i>
                        </div>
                      </div>
                      <h4 class="text-body-emphasis mb-3">No Active Templates</h4>
                      <p class="text-muted mb-4">Create templates to start photo documentation workflows</p>
                      <button class="btn btn-primary" [routerLink]="['../template-manager']" [relativeTo]="route">
                        <i class="mdi mdi-plus me-2"></i>Create Template
                      </button>
                    </div>
                  </div>
                </ng-container>
              </div>
            </div>

            <!-- Instances Tab -->
            <div *ngIf="activeTab === 'instances'" class="tab-pane-content">
              
              <!-- Filters -->
              <div class="card shadow-none border-top-0 mb-0">
                <div class="card-body">
                  <div class="row g-3">
                    <div class="col-md-3">
                      <label class="form-label">Status</label>
                      <select class="form-select" [(ngModel)]="filters.status">
                        <option value="">All Statuses</option>
                        <option value="draft">Draft</option>
                        <option value="in_progress">In Progress</option>
                        <option value="review">Under Review</option>
                        <option value="completed">Completed</option>
                        <option value="submitted">Submitted</option>
                      </select>
                    </div>
                    <div class="col-md-3">
                      <label class="form-label">Template</label>
                      <select class="form-select" [(ngModel)]="filters.template">
                        <option value="">All Templates</option>
                        <option *ngFor="let template of templates" [value]="template.id">
                          {{template.name}}
                        </option>
                      </select>
                    </div>
                    <div class="col-md-3">
                      <label class="form-label">Part Number</label>
                      <input type="text" class="form-control" [(ngModel)]="filters.partNumber" 
                             placeholder="Search part number...">
                    </div>
                    <div class="col-md-3">
                      <label class="form-label">Operator</label>
                      <input type="text" class="form-control" [(ngModel)]="filters.operator" 
                             placeholder="Search operator...">
                    </div>
                  </div>
                </div>
              </div>

              <!-- Instances Content -->
              <div class="p-3">
                <div class="table-responsive">
                  <table class="table table-hover mb-0">
                    <thead class="table-light">
                      <tr>
                        <th>Work Order</th>
                        <th>Template</th>
                        <th>Part Number</th>
                        <th>Serial Number</th>
                        <th>Operator</th>
                        <th>Progress</th>
                        <th>Status</th>
                        <th>Created</th>
                        <th>Actions</th>
                      </tr>
                    </thead>
                    <tbody>
                      <tr *ngFor="let instance of getFilteredInstances(); trackBy: trackByInstanceId" 
                          class="align-middle">
                        <td>
                          <strong>{{instance.work_order_number}}</strong>
                        </td>
                        <td>
                          <div>{{instance.template_name}}</div>
                          <small class="text-muted">{{instance.template_description}}</small>
                        </td>
                        <td>
                          <code>{{instance.part_number}}</code>
                        </td>
                        <td>
                          <code>{{instance.serial_number}}</code>
                        </td>
                        <td>
                          {{instance.operator_name}}
                        </td>
                        <td>
                          <div class="d-flex align-items-center">
                            <div class="progress flex-grow-1 me-2" style="height: 6px;">
                              <div class="progress-bar" 
                                   [class]="getProgressBarClass(instance.progress_percentage)"
                                   [style.width.%]="instance.progress_percentage"></div>
                            </div>
                            <small class="text-muted">{{instance.progress_percentage}}%</small>
                          </div>
                          <small class="text-muted">
                            {{instance.completed_required || 0}}/{{instance.required_items || 0}} required
                          </small>
                        </td>
                        <td>
                          <span class="badge" [class]="getStatusBadgeClass(instance.status)">
                            {{instance.status | titlecase}}
                          </span>
                        </td>
                        <td>
                          <small class="text-muted">
                            {{instance.created_at | date:'MMM d, y'}}
                          </small>
                        </td>
                        <td>
                          <button class="btn btn-sm btn-outline-primary" 
                                  (click)="openChecklistInstance(instance)">
                            <i class="mdi mdi-open-in-new me-1"></i>
                            Open
                          </button>
                        </td>
                      </tr>
                    </tbody>
                  </table>
                </div>

                <!-- Empty State -->
                <ng-container *ngIf="getFilteredInstances().length === 0">
                  <div class="d-flex flex-column align-items-center justify-content-center p-5">
                    <div class="text-center" style="max-width: 500px;">
                      <div class="mb-4">
                        <div class="bg-primary bg-opacity-10 rounded-circle d-flex align-items-center justify-content-center mx-auto" style="width: 120px; height: 120px;">
                          <i class="mdi mdi-clipboard-check-outline text-primary" style="font-size: 3rem;"></i>
                        </div>
                      </div>
                      <h4 class="text-body-emphasis mb-3">No Checklist Instances</h4>
                      <p class="text-muted mb-4">Start a new checklist from the Templates tab</p>
                    </div>
                  </div>
                </ng-container>
              </div>
            </div>
          </div>
        </div>
        
        <div class="card-footer bg-light text-muted d-flex align-items-center">
          <i class="mdi mdi-information me-2"></i>
          <span *ngIf="activeTab === 'templates'">Click "Preview" to view template details or "Start" to create a new checklist instance</span>
          <span *ngIf="activeTab === 'instances'">Click "Open" to view/edit checklist instances and manage photo documentation</span>
          <div class="ms-auto">
            <small *ngIf="activeTab === 'templates'">Total: {{templates?.length || 0}} templates</small>
            <small *ngIf="activeTab === 'instances'">Total: {{getFilteredInstances()?.length || 0}} instances</small>
          </div>
        </div>
      </div>
      
    </div>
  </div>
</div>

<!-- Create Instance Modal -->
<div *ngIf="showCreateInstanceModal" class="modal-backdrop fade show" style="display: block;"></div>
<div *ngIf="showCreateInstanceModal" class="modal fade show d-block" tabindex="-1" role="dialog">
  <div class="modal-dialog modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header bg-primary bg-gradient text-white position-relative overflow-hidden p-4" style="border-radius: 16px 16px 0 0;">
        <!-- Background Pattern -->
        <div class="position-absolute" style="top: -20px; right: -20px; opacity: 0.1;">
          <i class="mdi mdi-clipboard-plus-outline" style="font-size: 8rem; transform: rotate(15deg);"></i>
        </div>
        
        <div class="d-flex align-items-center justify-content-between position-relative w-100">
          <div class="d-flex align-items-center">
            <span class="bg-white bg-opacity-10 rounded-circle d-flex align-items-center justify-content-center me-3"
                  style="width: 2.5rem; height: 2.5rem;">
              <i class="mdi mdi-clipboard-plus-outline fs-4 text-white"></i>
            </span>
            <div>
              <h4 class="mb-1 fw-bold text-white">
                Start New Checklist
              </h4>
              <p class="text-white-50 mb-0" *ngIf="selectedTemplate">Template: {{selectedTemplate.name}} | Category: {{selectedTemplate.category | titlecase}}</p>
            </div>
          </div>
          
          <div class="d-flex align-items-center gap-2">
            <span class="badge bg-white text-primary" *ngIf="selectedTemplate">{{selectedTemplate.item_count || 0}} Items</span>
          </div>
        </div>
      </div>
      <div class="modal-body py-3" *ngIf="selectedTemplate">
        <!-- Template Summary Info -->
        <div class="card border-0 shadow-none mb-3 bg-light">
          <div class="card-body py-2 px-3 text-center">
            <div class="row">
              <div class="col-md-3">
                <small class="text-muted">Template:</small>
                <div class="fw-semibold">{{selectedTemplate.name}}</div>
              </div>
              <div class="col-md-3">
                <small class="text-muted">Category:</small>
                <div class="fw-semibold">{{selectedTemplate.category | titlecase}}</div>
              </div>
              <div class="col-md-3">
                <small class="text-muted">Items Count:</small>
                <div class="fw-semibold">{{selectedTemplate.item_count || 0}}</div>
              </div>
              <div class="col-md-3">
                <small class="text-muted">Version:</small>
                <div class="fw-semibold">{{selectedTemplate.version}}</div>
              </div>
            </div>
            <div class="row mt-2" *ngIf="selectedTemplate.description">
              <div class="col-12">
                <small class="text-muted">{{selectedTemplate.description}}</small>
              </div>
            </div>
          </div>
        </div>

        <div class="mb-3">
          <div class="mb-3">
            <label for="workOrder" class="form-label fw-bold">Work Order Number *</label>
            <input type="text" class="form-control" id="workOrder" 
                   [(ngModel)]="newInstance.workOrder" 
                   name="workOrder" required placeholder="e.g., WO-2024-001"
                   [class.is-invalid]="!newInstance.workOrder && newInstance.workOrder !== ''">
            <div class="invalid-feedback" *ngIf="!newInstance.workOrder && newInstance.workOrder !== ''">
              Work order number is required
            </div>
          </div>

          <div class="mb-3">
            <label for="partNumber" class="form-label fw-bold">Part Number *</label>
            <input type="text" class="form-control" id="partNumber" 
                   [(ngModel)]="newInstance.partNumber" 
                   name="partNumber" required 
                   placeholder="e.g., VWL-03513-210"
                   [class.is-invalid]="!newInstance.partNumber && newInstance.partNumber !== ''">
            <div class="invalid-feedback" *ngIf="!newInstance.partNumber && newInstance.partNumber !== ''">
              Part number is required
            </div>
          </div>

          <div class="mb-3">
            <label for="serialNumber" class="form-label fw-bold">Serial Number *</label>
            <input type="text" class="form-control" id="serialNumber" 
                   [(ngModel)]="newInstance.serialNumber" 
                   name="serialNumber" required placeholder="e.g., SN123456789"
                   [class.is-invalid]="!newInstance.serialNumber && newInstance.serialNumber !== ''">
            <div class="invalid-feedback" *ngIf="!newInstance.serialNumber && newInstance.serialNumber !== ''">
              Serial number is required
            </div>
          </div>
        </div>
      </div>
      <div class="modal-footer bg-light d-flex justify-content-between align-items-center py-3">
        <div class="d-flex align-items-center">
          <small class="text-muted me-3" *ngIf="selectedTemplate">
            <i class="mdi mdi-clock-outline me-1"></i>
            Template Version: {{selectedTemplate.version}} | Items: {{selectedTemplate.item_count || 0}}
          </small>
        </div>
        <div class="d-flex align-items-center gap-2">
          <button type="button" class="btn btn-outline-secondary d-flex align-items-center" (click)="closeCreateInstanceModal()">
            <i class="mdi mdi-close me-1"></i>Cancel
          </button>
          <button type="button" class="btn btn-primary d-flex align-items-center" 
                  [disabled]="!isNewInstanceFormValid"
                  (click)="createChecklistInstance(selectedTemplate!, newInstance.workOrder, newInstance.partNumber, newInstance.serialNumber)">
            <i class="mdi mdi-plus me-1"></i>Start Checklist
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Template Preview Modal -->
<div *ngIf="showPreviewModal" class="modal-backdrop fade show" style="display: block;"></div>
<div *ngIf="showPreviewModal" class="modal fade show d-block" tabindex="-1" role="dialog">
  <div class="modal-dialog modal-xl" role="document">
    <div class="modal-content">
      <div class="modal-header bg-primary bg-gradient text-white position-relative overflow-hidden p-4" style="border-radius: 16px 16px 0 0;">
        <!-- Background Pattern -->
        <div class="position-absolute" style="top: -20px; right: -20px; opacity: 0.1;">
          <i class="mdi mdi-clipboard-text-outline" style="font-size: 8rem; transform: rotate(15deg);"></i>
        </div>
        
        <div class="d-flex align-items-center justify-content-between position-relative w-100">
          <div class="d-flex align-items-center">
            <span class="bg-white bg-opacity-10 rounded-circle d-flex align-items-center justify-content-center me-3"
                  style="width: 2.5rem; height: 2.5rem;">
              <i class="mdi mdi-clipboard-text-outline fs-4 text-white"></i>
            </span>
            <div>
              <h4 class="mb-1 fw-bold text-white">
                Template Preview ----- 
              </h4>
              <p class="text-white-50 mb-0" *ngIf="selectedTemplate">
                {{selectedTemplate.name}} - Version {{selectedTemplate.version}} | {{selectedTemplate.category | titlecase}}
              </p>
            </div>
          </div>
          
          <div class="d-flex align-items-center gap-2">
            <span class="badge bg-white text-primary" *ngIf="selectedTemplate">{{selectedTemplate.item_count || 0}} Items</span>
            <span class="badge bg-white text-primary" *ngIf="selectedTemplate && selectedTemplate.is_active">Active</span>
          </div>
        </div>
      </div>
      
      <div class="modal-body py-3" *ngIf="selectedTemplate">
        <!-- Template Summary Info -->
        <div class="card border-0 shadow-none mb-3 bg-light">
          <div class="card-body py-2 px-3 text-center">
            <div class="row">
              <div class="col-md-3">
                <small class="text-muted">Template Name:</small>
                <div class="fw-semibold">{{selectedTemplate.name}}</div>
              </div>
              <div class="col-md-3">
                <small class="text-muted">Category:</small>
                <div class="fw-semibold">{{selectedTemplate.category | titlecase}}</div>
              </div>
              <div class="col-md-3">
                <small class="text-muted">Total Items:</small>
                <div class="fw-semibold">{{selectedTemplate.item_count || 0}}</div>
              </div>
              <div class="col-md-3">
                <small class="text-muted">Active Instances:</small>
                <div class="fw-semibold">{{selectedTemplate.active_instances || 0}}</div>
              </div>
            </div>
            <div class="row mt-2">
              <div class="col-md-6" *ngIf="selectedTemplate.part_number">
                <small class="text-muted">Part Number:</small>
                <div class="fw-semibold">{{selectedTemplate.part_number}}</div>
              </div>
              <div class="col-md-6" *ngIf="selectedTemplate.product_type">
                <small class="text-muted">Product Type:</small>
                <div class="fw-semibold">{{selectedTemplate.product_type}}</div>
              </div>
            </div>
            <div class="row mt-2" *ngIf="selectedTemplate.description">
              <div class="col-12">
                <small class="text-muted">Description:</small>
                <div class="fw-semibold">{{selectedTemplate.description}}</div>
              </div>
            </div>
          </div>
        </div>

        <!-- Checklist Items -->
        <div class="card border-0">
          <div class="card-header bg-success text-white">
            <h6 class="mb-0">
              <i class="mdi mdi-format-list-checks me-2"></i>
              Checklist Items ({{selectedTemplate.items?.length || 0}})
            </h6>
          </div>
          <div class="card-body p-0">
            <div class="list-group list-group-flush" *ngIf="selectedTemplate.items && selectedTemplate.items.length > 0">
              <!-- Parent items -->
              <ng-container *ngFor="let item of selectedTemplate.items; let i = index">
                <div class="list-group-item">
                  <div class="d-flex align-items-start gap-3">
                    <!-- Left side: Number badge and content -->
                    <div class="flex-shrink-0">
                      <div class="bg-primary text-white rounded-circle d-flex align-items-center justify-content-center"
                           style="width: 32px; height: 32px; font-size: 0.875rem; font-weight: 600;">
                        {{i + 1}}
                      </div>
                    </div>
                    
                    <!-- Middle: Item details -->
                    <div class="flex-grow-1">
                      <div class="mb-2">
                        <h6 class="mb-0">
                          {{item.title}}
                          <span class="badge bg-danger ms-2" style="font-size: 0.7rem;" *ngIf="item.is_required">Required</span>
                          <span class="badge ms-1" style="font-size: 0.7rem;" 
                                [ngClass]="{
                                  'bg-primary': item.submission_type === 'photo',
                                  'bg-success': item.submission_type === 'video',
                                  'bg-info': item.submission_type === 'either'
                                }">
                            <i class="mdi" [ngClass]="{
                              'mdi-camera': item.submission_type === 'photo',
                              'mdi-video': item.submission_type === 'video',
                              'mdi-file-multiple': item.submission_type === 'either'
                            }"></i>
                            {{item.submission_type === 'either' ? 'Photo OR Video' : (item.submission_type | titlecase)}}
                          </span>
                        </h6>
                      </div>
                      <div class="text-muted mb-2" *ngIf="item.description" [innerHTML]="item.description"></div>
                    
                      <!-- Photo Requirements (only for photo/either) -->
                      <div class="row g-2 mb-2" *ngIf="(item.submission_type === 'photo' || item.submission_type === 'either') && item.photo_requirements && hasPhotoRequirements(item.photo_requirements)">
                        <div class="col-auto" *ngIf="item.photo_requirements.angle">
                          <small class="badge bg-light text-dark">
                            <i class="mdi mdi-camera-metering-spot me-1"></i>
                            {{item.photo_requirements.angle | titlecase}}
                          </small>
                        </div>
                        <div class="col-auto" *ngIf="item.photo_requirements.distance">
                          <small class="badge bg-light text-dark">
                            <i class="mdi mdi-arrow-expand-all me-1"></i>
                            {{item.photo_requirements.distance | titlecase}}
                          </small>
                        </div>
                        <div class="col-auto" *ngIf="item.photo_requirements.lighting">
                          <small class="badge bg-light text-dark">
                            <i class="mdi mdi-lightbulb me-1"></i>
                            {{item.photo_requirements.lighting | titlecase}}
                          </small>
                        </div>
                        <div class="col-auto" *ngIf="item.photo_requirements.focus">
                          <small class="badge bg-light text-dark">
                            <i class="mdi mdi-target me-1"></i>
                            {{item.photo_requirements.focus}}
                          </small>
                        </div>
                        <div class="col-auto" *ngIf="item.max_photos || item.min_photos">
                          <small class="badge bg-info text-white">
                            <i class="mdi mdi-camera me-1"></i>
                            {{getPhotoLimitText(item)}}
                          </small>
                        </div>
                      </div>
                      
                      <!-- Video Requirements (only for video/either) -->
                      <div class="row g-2 mb-2" *ngIf="(item.submission_type === 'video' || item.submission_type === 'either') && item.video_requirements && item.video_requirements.max_video_duration_seconds">
                        <div class="col-auto">
                          <small class="badge bg-light text-dark">
                            <i class="mdi mdi-timer-off me-1"></i>
                            Max Duration: {{item.video_requirements.max_video_duration_seconds}}s
                          </small>
                        </div>
                      </div>
                      
                      <!-- Submission Time Limit -->
                      <div class="row g-2 mb-2" *ngIf="item.submission_time_seconds">
                        <div class="col-auto">
                          <small class="badge bg-warning text-dark">
                            <i class="mdi mdi-clock-alert me-1"></i>
                            Time Limit: {{item.submission_time_seconds}}s
                          </small>
                        </div>
                      </div>
                    </div>

                    <!-- Right side: Sample media (images and videos) -->
                    <div class="flex-shrink-0" style="width: 280px;" *ngIf="(item.sample_images && item.sample_images.length > 0) || (item.sample_videos && item.sample_videos.length > 0)">
                      <!-- Primary Sample Image -->
                      <ng-container *ngIf="item.submission_type === 'photo' || item.submission_type === 'either'">
                        <ng-container *ngFor="let sampleImage of item.sample_images">
                          <div *ngIf="sampleImage.is_primary && sampleImage.image_type === 'sample'" 
                               class="mb-2 p-2 border border-primary rounded bg-light">
                            <div class="d-flex align-items-center mb-2">
                              <small class="text-primary fw-bold">
                                <i class="mdi mdi-target me-1"></i>Match This
                              </small>
                              <span class="badge bg-primary ms-auto" style="font-size: 0.65rem;">Primary</span>
                            </div>
                            <img [src]="sampleImage.url" 
                                 class="img-thumbnail border-primary w-100"
                                 style="height: 180px; object-fit: contain; cursor: pointer; border-width: 2px !important;"
                                 [alt]="sampleImage.label || 'Primary sample image'"
                                 [title]="sampleImage.label || 'Primary Sample Image'"
                                 (click)="previewImage(sampleImage.url)"
                                 (error)="$any($event).target.style.display='none'">
                            <p class="mb-0 mt-1 small text-muted">
                              <i class="mdi mdi-information-outline me-1"></i>
                              Replicate this photo
                            </p>
                          </div>
                        </ng-container>
                        
                        <!-- Reference Images -->
                        <ng-container *ngIf="getReferenceImages(item.sample_images).length > 0">
                          <div class="mb-1">
                            <small class="text-secondary fw-bold">
                              <i class="mdi mdi-image-multiple me-1"></i>Reference ({{ getReferenceImages(item.sample_images).length }})
                            </small>
                          </div>
                          <div class="row g-1">
                            <div class="col-6" *ngFor="let refImage of getReferenceImages(item.sample_images)">
                              <img [src]="refImage.url" 
                                   class="img-thumbnail w-100"
                                   style="height: 80px; object-fit: cover; cursor: pointer;"
                                   [alt]="refImage.label || 'Reference image'"
                                   [title]="refImage.label || 'Reference Image'"
                                   (click)="previewImage(refImage.url)"
                                   (error)="$any($event).target.style.display='none'">
                            </div>
                          </div>
                        </ng-container>
                      </ng-container>
                      
                      <!-- Primary Sample Video -->
                      <ng-container *ngIf="(item.submission_type === 'video' || item.submission_type === 'either') && item.sample_videos && item.sample_videos.length > 0">
                        <ng-container *ngFor="let sampleVideo of item.sample_videos">
                          <div *ngIf="sampleVideo.is_primary" 
                               class="mb-2 p-2 border border-success rounded bg-light">
                            <div class="d-flex align-items-center mb-2">
                              <small class="text-success fw-bold">
                                <i class="mdi mdi-video me-1"></i>Sample Video
                              </small>
                              <span class="badge bg-success ms-auto" style="font-size: 0.65rem;">Primary</span>
                            </div>
                            <video [src]="sampleVideo.url" 
                                   controls
                                   class="w-100 rounded"
                                   style="max-height: 180px; object-fit: contain; cursor: pointer;"
                                   [title]="sampleVideo.label || 'Primary Sample Video'">
                            </video>
                            <p class="mb-0 mt-1 small text-muted">
                              <i class="mdi mdi-information-outline me-1"></i>
                              Reference video
                              <span *ngIf="sampleVideo.duration_seconds"> ({{sampleVideo.duration_seconds}}s)</span>
                            </p>
                          </div>
                        </ng-container>
                      </ng-container>
                    </div>
                  </div>
                </div>
                
                <!-- Child/nested items -->
                <ng-container *ngIf="item.children && item.children.length > 0">
                  <div class="list-group-item ms-4 border-start border-primary border-3 bg-light" 
                       *ngFor="let child of item.children; let j = index">
                    <div class="d-flex align-items-start gap-3">
                      <!-- Left: Number badge -->
                      <div class="flex-shrink-0">
                        <div class="bg-info text-white rounded-circle d-flex align-items-center justify-content-center"
                             style="width: 28px; height: 28px; font-size: 0.75rem; font-weight: 600;">
                          {{i + 1}}.{{j + 1}}
                        </div>
                      </div>
                      
                      <!-- Middle: Content -->
                      <div class="flex-grow-1">
                        <div class="mb-2">
                          <h6 class="mb-0 fs-6">
                            <i class="mdi mdi-subdirectory-arrow-right me-1 text-primary"></i>
                            {{child.title}}
                            <span class="badge bg-danger ms-2" style="font-size: 0.65rem;" *ngIf="child.is_required">Required</span>
                            <span class="badge ms-1" style="font-size: 0.65rem;" 
                                  [ngClass]="{
                                    'bg-primary': child.submission_type === 'photo',
                                    'bg-success': child.submission_type === 'video',
                                    'bg-info': child.submission_type === 'either'
                                  }">
                              <i class="mdi" [ngClass]="{
                                'mdi-camera': child.submission_type === 'photo',
                                'mdi-video': child.submission_type === 'video',
                                'mdi-file-multiple': child.submission_type === 'either'
                              }"></i>
                              {{child.submission_type === 'either' ? 'Photo OR Video' : (child.submission_type | titlecase)}}
                            </span>
                          </h6>
                        </div>
                        <div class="text-muted mb-2 small" *ngIf="child.description" [innerHTML]="child.description"></div>
                        
                        <!-- Photo Requirements for child (only for photo/either) -->
                        <div class="row g-2 mb-2" *ngIf="(child.submission_type === 'photo' || child.submission_type === 'either') && child.photo_requirements && hasPhotoRequirements(child.photo_requirements)">
                          <div class="col-auto" *ngIf="child.photo_requirements.angle">
                            <small class="badge bg-light text-dark">
                              <i class="mdi mdi-camera-metering-spot me-1"></i>
                              {{child.photo_requirements.angle | titlecase}}
                            </small>
                          </div>
                          <div class="col-auto" *ngIf="child.photo_requirements.distance">
                            <small class="badge bg-light text-dark">
                              <i class="mdi mdi-arrow-expand-all me-1"></i>
                              {{child.photo_requirements.distance | titlecase}}
                            </small>
                          </div>
                          <div class="col-auto" *ngIf="child.photo_requirements.lighting">
                            <small class="badge bg-light text-dark">
                              <i class="mdi mdi-lightbulb me-1"></i>
                              {{child.photo_requirements.lighting | titlecase}}
                            </small>
                          </div>
                          <div class="col-auto" *ngIf="child.max_photos || child.min_photos">
                            <small class="badge bg-info text-white">
                              <i class="mdi mdi-camera me-1"></i>
                              {{getPhotoLimitText(child)}}
                            </small>
                          </div>
                        </div>
                        
                        <!-- Video Requirements for child (only for video/either) -->
                        <div class="row g-2 mb-2" *ngIf="(child.submission_type === 'video' || child.submission_type === 'either') && child.video_requirements && child.video_requirements.max_video_duration_seconds">
                          <div class="col-auto">
                            <small class="badge bg-light text-dark">
                              <i class="mdi mdi-timer-off me-1"></i>
                              Max Duration: {{child.video_requirements.max_video_duration_seconds}}s
                            </small>
                          </div>
                        </div>
                        
                        <!-- Submission Time Limit -->
                        <div class="row g-2 mb-2" *ngIf="child.submission_time_seconds">
                          <div class="col-auto">
                            <small class="badge bg-warning text-dark">
                              <i class="mdi mdi-clock-alert me-1"></i>
                              Time Limit: {{child.submission_time_seconds}}s
                            </small>
                          </div>
                        </div>
                      </div>

                      <!-- Right: Sample media -->
                      <div class="flex-shrink-0" style="width: 200px;" *ngIf="(child.sample_images && child.sample_images.length > 0) || (child.sample_videos && child.sample_videos.length > 0)">
                        <!-- Primary Sample Image -->
                        <ng-container *ngIf="child.submission_type === 'photo' || child.submission_type === 'either'">
                          <ng-container *ngFor="let sampleImage of child.sample_images">
                            <div *ngIf="sampleImage.is_primary && sampleImage.image_type === 'sample'" 
                                 class="mb-2 p-2 border border-info rounded" style="background-color: #f0f8ff;">
                              <div class="d-flex align-items-center mb-1">
                                <small class="text-info fw-bold">
                                  <i class="mdi mdi-target me-1"></i>Match This
                                </small>
                                <span class="badge bg-info ms-auto" style="font-size: 0.65rem;">Primary</span>
                              </div>
                              <img [src]="sampleImage.url" 
                                   class="img-thumbnail border-info w-100"
                                   style="height: 120px; object-fit: contain; cursor: pointer; border-width: 2px !important;"
                                   [alt]="sampleImage.label || 'Primary sample'"
                                   (click)="previewImage(sampleImage.url)"
                                   (error)="$any($event).target.style.display='none'">
                            </div>
                          </ng-container>
                          
                          <!-- Reference Images -->
                          <ng-container *ngIf="getReferenceImages(child.sample_images).length > 0">
                            <div class="mb-1">
                              <small class="text-secondary fw-bold">
                                <i class="mdi mdi-image-multiple me-1"></i>Ref ({{ getReferenceImages(child.sample_images).length }})
                              </small>
                            </div>
                            <div class="row g-1">
                              <div class="col-6" *ngFor="let refImage of getReferenceImages(child.sample_images)">
                                <img [src]="refImage.url" 
                                     class="img-thumbnail w-100"
                                     style="height: 60px; object-fit: cover; cursor: pointer;"
                                     [alt]="refImage.label || 'Reference'"
                                     [title]="refImage.label || 'Reference Image'"
                                     (click)="previewImage(refImage.url)"
                                     (error)="$any($event).target.style.display='none'">
                              </div>
                            </div>
                          </ng-container>
                        </ng-container>
                        
                        <!-- Primary Sample Video -->
                        <ng-container *ngIf="(child.submission_type === 'video' || child.submission_type === 'either') && child.sample_videos && child.sample_videos.length > 0">
                          <ng-container *ngFor="let sampleVideo of child.sample_videos">
                            <div *ngIf="sampleVideo.is_primary" 
                                 class="mb-2 p-2 border border-success rounded bg-light">
                              <div class="d-flex align-items-center mb-1">
                                <small class="text-success fw-bold">
                                  <i class="mdi mdi-video me-1"></i>Sample
                                </small>
                                <span class="badge bg-success ms-auto" style="font-size: 0.65rem;">Primary</span>
                              </div>
                              <video [src]="sampleVideo.url" 
                                     controls
                                     class="w-100 rounded"
                                     style="max-height: 120px; object-fit: contain;">
                              </video>
                            </div>
                          </ng-container>
                        </ng-container>
                      </div>
                    </div>
                  </div>
                </ng-container>
              </ng-container>
            </div>
            
            <!-- Empty State -->
            <div class="text-center p-4" *ngIf="!selectedTemplate.items || selectedTemplate.items.length === 0">
              <i class="mdi mdi-clipboard-outline text-muted mb-2" style="font-size: 2rem;"></i>
              <p class="text-muted mb-0">No checklist items defined</p>
            </div>
          </div>
        </div>
      </div>
      
      <div class="modal-footer bg-light d-flex justify-content-between align-items-center py-3">
        <div class="d-flex align-items-center">
          <small class="text-muted me-3" *ngIf="selectedTemplate">
            <i class="mdi mdi-clock-outline me-1"></i>
            Version {{selectedTemplate.version}} | Last updated: {{selectedTemplate.updated_at || selectedTemplate.created_at | date:'medium'}}
          </small>
        </div>
        <div class="d-flex align-items-center gap-2">
          <button type="button" class="btn btn-outline-secondary d-flex align-items-center" (click)="closePreviewModal()">
            <i class="mdi mdi-close me-1"></i>Close Preview
          </button>
          <button type="button" class="btn btn-primary d-flex align-items-center" 
                  (click)="closePreviewModal(); openCreateInstanceModal(selectedTemplate!)">
            <i class="mdi mdi-plus me-1"></i>Start Checklist
          </button>
        </div>
      </div>
    </div>
  </div>
</div>
