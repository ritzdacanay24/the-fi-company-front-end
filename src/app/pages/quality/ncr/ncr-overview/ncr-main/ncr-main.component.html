<div class="container-fluid">
  <div class="row justify-content-center">
    <div class="col-12 col-lg-11 col-xl-10 col-xxl-8">

      <div class="card shadow-sm border-0">
        <div class="card-body p-4">
          
          <!-- Access Control Alert -->
          <div class="alert alert-warning border-warning border-opacity-25 bg-warning bg-opacity-10" role="alert" 
               *ngIf="(this.form?.value?.created_by != currentUserId) && !this.form?.value?.submitted_date && !isLoading">
            <div class="d-flex align-items-start">
              <i class="mdi mdi-account-lock text-warning me-3 mt-1 fs-5"></i>
              <div>
                <h6 class="alert-heading text-warning mb-2">Access Restricted</h6>
                <p class="mb-0">Only the user who created this request can modify this NCR.</p>
              </div>
            </div>
          </div>

          <!-- Submission Status Alert -->
          <div class="alert alert-success border-success border-opacity-25 bg-success bg-opacity-10" role="alert" 
               *ngIf="this.form?.value?.submitted_date && !isLoading">
            <div class="d-flex align-items-start">
              <i class="mdi mdi-check-circle text-success me-3 mt-1 fs-5"></i>
              <div class="flex-grow-1">
                <h6 class="alert-heading text-success mb-2">NCR Submitted</h6>
                <p class="mb-0">This NCR was submitted on {{this.form?.value?.submitted_date}}.</p>
              </div>
              <div>
                <button type="button" class="btn btn-success btn-sm" (click)="reopen()">
                  <i class="mdi mdi-lock-open-outline me-1"></i>Re-open
                </button>
              </div>
            </div>
          </div>

          <app-ncr-form (setFormEmitter)="setFormEmitter($event)" [submitted]="submitted" [id]="id"></app-ncr-form>
        </div>
        
        <div class="card-footer bg-light border-top d-flex justify-content-between p-3">
          <div class="d-flex gap-2">
            <button type="button" class="btn btn-primary" [disabled]="isLoading || this.form?.disabled" (click)="onSubmit()">
              <i class="mdi mdi-content-save me-1"></i>Update NCR
            </button>
            <button type="button" class="btn btn-success" [disabled]="isLoading || this.form?.disabled" (click)="onSubmitAndClose()">
              <i class="mdi mdi-check-circle-outline me-1"></i>Update & Close NCR
            </button>
          </div>
          <button type="button" (click)="onDownloadAsPdf()" class="btn btn-outline-secondary" [disabled]="isLoading">
            <i class="mdi mdi-file-pdf-box text-danger me-2"></i> Download PDF
          </button>
        </div>
      </div>
      
    </div>
  </div>
</div>

<div id="content" #content style="font-size:12px;border:2px solid black" class="d-none d-print-block">

  <h4 class="text-center">Corrective Action</h4>
  <table class="table table-bordered table-sm">
    <tr>
      <td colspan="2">Source: {{data?.source}}</td>
      <td>P.O No. {{data?.po_nbr}}</td>
      <td>WO No. {{data?.wo_nbr}}</td>
      <td>CAR No. {{data?.id}}</td>
    </tr>
    <tr>
      <td colspan="5">CAR Type: {{data?.ncr_type}}</td>
    </tr>
    <tr>
      <td colspan="2">Part No. {{data?.pt_nbr}}</td>
      <td>Rev: {{data?.rev}}</td>
      <td>Initiated By: {{data?.initiated_by}}</td>
      <td>Return No. {{data?.ret_nbr}}</td>
    </tr>
    <tr>
      <td>Acc. {{data?.acc}}</td>
      <td>Rej. {{data?.rej}}</td>
      <td>Sample Size: {{data?.sample_size}}</td>
      <td>Dept./Operator: {{data?.dept_operator}}</td>
      <td>Finished #: {{data?.finished_nbr}}</td>
    </tr>
  </table>
  <table class="table table-bordered table-sm border-top-0">
    <tr>
      <td colspan="3" class="bg-grey">Description of Deficiency/Rejection</td>
    </tr>
    <tr>
      <td colspan="3" style="height:100px;vertical-align: top;white-space: pre-wrap;">{{data?.desc_of_defn_rej}}</td>
    </tr>
    <tr>
      <td colspan="3" class="bg-grey">Containment</td>
    </tr>
    <tr>
      <td colspan="3" style="height:100px;vertical-align: top;white-space: pre-wrap;">{{data?.cont_notes}}</td>
    </tr>
    <tr>
      <td colspan="3">Type: {{data?.cont_type}}</td>
    </tr>
    <tr>
      <td>Dspn by: {{data?.cont_dspn_by}}</td>
      <td>Dspn by: {{data?.cont_dspn_title}}</td>
      <td>Dt: {{data?.cont_dspn_dt}}</td>
    </tr>
    <tr>
      <td colspan="3" class="bg-grey">Disposition/Rework/Repair Instructions</td>
    </tr>
    <tr>
      <td colspan="3" style="height:100px;vertical-align: top;white-space: pre-wrap;">{{data?.dspn_desc}}</td>
    </tr>
    <tr>
      <td colspan="3" class="bg-grey">Impact assessment of nonconformity on other
        product(s) and/or process(es):</td>
    </tr>
    <tr>
      <td colspan="3" style="height:50px;vertical-align: top;white-space: pre-wrap;">{{data?.impact_assesment}}</td>
    </tr>
    <tr>
      <td colspan="3" class="bg-grey">Immediate Correction Made</td>
    </tr>
    <tr>
      <td colspan="3" style="height:100px;vertical-align: top;white-space: pre-wrap;">{{data?.icm_notes}}</td>
    </tr>
    <tr>
      <td>Dspn by: {{data?.icm_dspn_by}}</td>
      <td>Title: {{data?.icm_dspn_title}}</td>
      <td>Dt: {{data?.icm_dspn_dt}}</td>
    </tr>
    <tr class="text-center bg-grey p-1">
      <td colspan="5" class="p-1">Corrective Action</td>
    </tr>
    <tr>
      <td colspan="5">Corrective Action Required? {{data?.ca_action_req}} <br /> If CA is not required, DO NOT proceed
        to the
        next page</td>
    </tr>
    <tr>
      <td colspan="2" class="bg-grey">Issued By:</td>
      <td class="bg-grey">Date:</td>
    </tr>
    <tr>
      <td colspan="2">{{data?.iss_by}}</td>
      <td>{{data?.iss_dt}}</td>
    </tr>
    <tr class="text-center bg-grey p-1">
      <td colspan="5" class="p-1 bolder">Corrective Action</td>
    </tr>
    <tr>
      <td colspan="3">(See next page for Corrective Action Section)</td>
    </tr>
  </table>

  <div class="pagebreak"> </div>

  <table class="table table-bordered table-sm border-top-0">
    <tr class="text-center bg-grey p-3">
      <td colspan="5" class="p-3">Corrective Action</td>
    </tr>
    <tr>
      <td colspan="3">Corrective action must be completed within the due date and forwarded to the quaility
        assurance manager.</td>
    </tr>
    <tr>
      <td colspan="2" class="bg-grey">Corrective Action Issued To</td>
      <td class="bg-grey">Due Date</td>
    </tr>
    <tr>
      <td colspan="2">{{data?.ca_iss_to}}</td>
      <td>{{data?.ca_due_dt}}</td>
    </tr>
    <tr>
      <td colspan="3" class="bg-grey">Containment/Immediate Action Taken
        (Only
        need to be completed if CA is issued to Supplier)</td>
    </tr>
    <tr>
      <td colspan="3" style="height:50px;vertical-align: top;white-space: pre-wrap;">{{data?.ca_cont_immed_action_taken}}</td>
    </tr>
    <tr>
      <td colspan="3" class="bg-grey">Root Cause (Attach additional documentation if
        nescessary)</td>
    </tr>
    <tr>
      <td colspan="3" style="height:50px;vertical-align: top;white-space: pre-wrap;">{{data?.ca_root_cause}}</td>
    </tr>
    <tr>
      <td colspan="3" class="bg-grey">Correction Action(s) Taken to
        Prevent Reoccurrence</td>
    </tr>
    <tr>
      <td colspan="3" style="height:50px;vertical-align: top;white-space: pre-wrap;">{{data?.ca_taken_to_prevent_recurr}}</td>
    </tr>
    <tr>
      <td colspan="2" class="bg-grey">Planned CA Implementation Date:</td>
      <td>{{data?.planned_ca_impl_dt}}</td>
    </tr>
    <tr>
      <td class="bg-grey">Corrective Action By</td>
      <td class="bg-grey">Title</td>
      <td class="bg-grey">Date</td>
    </tr>
    <tr>
      <td>{{data?.ca_by}}</td>
      <td>{{data?.ca_title}}</td>
      <td>{{data?.ca_dt}}</td>
    </tr>
    <tr>
      <td class="bg-grey">Corrective Action Implemented By</td>
      <td class="bg-grey">Title</td>
      <td class="bg-grey">Date</td>
    </tr>
    <tr>
      <td>{{data?.ca_impl_by}}</td>
      <td>{{data?.ca_impl_title}}</td>
      <td>{{data?.ca_impl_dt}}</td>
    </tr>
    <tr>
      <td colspan="3">Below section to be completed by the fi company</td>
    </tr>
    <tr>
      <td colspan="2" class="bg-grey">Verification of CA By:</td>
      <td class="bg-grey">Date</td>
    </tr>
    <tr>
      <td colspan="2" style="height:50px;vertical-align: top;">{{data?.verif_of_ca_by}}</td>
      <td style="height:50px;vertical-align: top;">{{data?.verif_of_ca_dt}}</td>
    </tr>
    <tr>
      <td colspan="2" class="bg-grey">Effectiveness Verification of CA
        By:</td>
      <td class="bg-grey">Date</td>
    </tr>
    <tr>
      <td colspan="2" style="height:50px;vertical-align: top;">{{data?.eff_verif_of_ca_by}}</td>
      <td style="height:50px;vertical-align: top;">{{data?.eff_verif_of_ca_dt}}</td>
    </tr>
    <tr>
      <td colspan="2" class="bg-grey">Comments/Closure By:</td>
      <td class="bg-grey">Date</td>
    </tr>
    <tr>
      <td colspan="2" style="height:50px;vertical-align: top;">{{data?.cmt_cls_by}}</td>
      <td style="height:50px;vertical-align: top;">{{data?.cmt_cls_dt}}</td>
    </tr>
  </table>
  <p class="text-right" style="text-align:right">FORM:8.70-00-1 REV NC</p>
</div>