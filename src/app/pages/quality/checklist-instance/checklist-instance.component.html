<div class="checklist-instance">
  <!-- Loading State -->
  <div class="d-flex justify-content-center align-items-center" style="min-height: 50vh;" *ngIf="loading">
    <div class="text-center">
      <div class="spinner-border text-primary mb-3" role="status" style="width: 4rem; height: 4rem;"></div>
      <h5 class="text-muted mb-2">Loading checklist instance...</h5>
      <div class="progress mx-auto" style="width: 200px; height: 4px;">
        <div class="progress-bar progress-bar-striped progress-bar-animated" style="width: 100%"></div>
      </div>
    </div>
  </div>

  <!-- Main Content Container -->
  <div class="container-fluid" style="max-width: 1200px; padding: 0 1rem;" *ngIf="!loading && instance && template">
    <div class="mx-auto">
    
      <!-- Header Component -->
      <app-checklist-header
        [template]="template"
        [instance]="instance"
        [completedItemsCount]="getCompletedItemsCount()"
        [totalItemsCount]="getTotalItemsCount()"
        (goBackClicked)="goBack()">
      </app-checklist-header>

      <!-- Completion Status -->
      <div class="alert alert-success d-flex align-items-center mb-4" 
           *ngIf="instance.status === 'completed' || instance.status === 'submitted'">
        <i class="mdi mdi-check-circle me-3 fs-4"></i>
        <div>
          <strong>Completed!</strong> Checklist {{instance.status}} on: 
          {{instance.updated_at | date:'medium'}}
        </div>
      </div>

      <!-- Main Content - Photo Taking Mode -->
      <div class="row" *ngIf="!isReviewMode">
        <div class="col-12">
          <div *ngFor="let progress of getCurrentItemsToShow(); let i = index">
            
            <!-- Task Description Component -->
            <app-task-description
              [progress]="progress"
              [currentItemIndex]="getCurrentItemIndex()"
              [totalItemsCount]="getTotalItemsCount()">
            </app-task-description>

            <!-- Side-by-Side Layout for Photos and Sample -->
            <div class="row g-4 mb-4">
              <!-- Photo Section -->
              <div class="col-md-6">
                <app-photo-section
                  [progress]="progress"
                  [instance]="instance"
                  [isCompleted]="progress.completed"
                  (fileSelected)="onFileSelected($event.event, $event.itemId)"
                  (deletePhoto)="deletePhoto($event.photoUrl, $event.itemId)">
                </app-photo-section>
              </div>

              <!-- Sample Reference Section -->
              <div class="col-md-6">
                <app-sample-reference
                  [progress]="progress"
                  [currentComparisonIndex]="currentComparisonIndex"
                  (previousPhoto)="previousComparisonPhoto($event)"
                  (nextPhoto)="nextComparisonPhoto($event)">
                </app-sample-reference>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Review Mode - All Items -->
      <div class="row" *ngIf="isReviewMode">
        <div class="col-12">
          <div class="row g-4">
            <div class="col-md-6 col-lg-4" *ngFor="let progress of itemProgress; let i = index">
              <div class="card h-100 shadow-sm border-0">
                <div class="card-header bg-light border-0 py-3">
                  <div class="d-flex align-items-center justify-content-between">
                    <h6 class="mb-0 fw-bold">
                      Task {{i + 1}}: {{progress.item.title}}
                    </h6>
                    <span class="badge" 
                          [class]="progress.completed ? 'bg-success' : 'bg-warning'">
                      {{progress.completed ? 'Done' : 'Pending'}}
                    </span>
                  </div>
                </div>
                
                <div class="card-body p-3">
                  <!-- Photos Grid -->
                  <div class="row g-2" *ngIf="progress.photos.length > 0">
                    <div class="col-6" *ngFor="let photo of progress.photos; let photoIndex = index">
                      <div class="ratio ratio-1x1 rounded overflow-hidden">
                        <img [src]="getPhotoUrl(photo)" 
                             class="object-fit-cover"
                             [alt]="'Photo ' + (photoIndex + 1)">
                      </div>
                    </div>
                  </div>
                  
                  <div class="text-center py-3 text-muted" *ngIf="progress.photos.length === 0">
                    <i class="mdi mdi-camera-off fs-1"></i>
                    <p class="mb-0 small">No photos taken</p>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Navigation Component -->
      <app-checklist-navigation
        [currentItemIndex]="getCurrentItemIndex()"
        [totalItemsCount]="getTotalItemsCount()"
        [isFirstItem]="isFirstItem()"
        [isLastItem]="isLastItem()"
        [isReviewMode]="isReviewMode"
        [completedItemsCount]="getCompletedItemsCount()"
        [instance]="instance"
        [saving]="saving"
        [requiredCompletionStatus]="getRequiredCompletionStatus()"
        (previousItem)="previousItem()"
        (nextItem)="nextItem()"
        (toggleReviewMode)="isReviewMode = !isReviewMode"
        (saveProgress)="saveProgress()"
        (submitChecklist)="submitChecklist()"
        (goBack)="goBack()">
      </app-checklist-navigation>

    </div>
  </div>

  <!-- Error State -->
  <div class="container text-center py-5" style="max-width: 1400px; margin: 0 auto;" *ngIf="!loading && !instance">
    <i class="mdi mdi-alert-circle-outline text-muted mb-3" style="font-size: 4rem;"></i>
    <h4 class="text-muted mb-3">Checklist Instance Not Found</h4>
    <p class="text-muted mb-4">The checklist instance you're looking for doesn't exist or has been removed.</p>
    <button type="button" class="btn btn-primary rounded-pill px-4" (click)="goBack()">
      <i class="mdi mdi-arrow-left me-2"></i>Back to Checklists
    </button>
  </div>
</div>
