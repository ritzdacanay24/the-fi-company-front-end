<div class="checklist-instance">
  <!-- Loading State with Enhanced Animation -->
  <div class="d-flex justify-content-center align-items-center" style="min-height: 50vh;" *ngIf="loading">
    <div class="text-center">
      <div class="spinner-border text-primary mb-3" role="status" style="width: 4rem; height: 4rem; animation: pulse 1.5s infinite;"></div>
      <h5 class="text-muted mb-2">Loading checklist instance...</h5>
      <div class="progress mx-auto" style="width: 200px; height: 4px;">
        <div class="progress-bar progress-bar-striped progress-bar-animated" style="width: 100%"></div>
      </div>
    </div>
  </div>

  <!-- Main Content Container with Limited Width -->
  <div class="container-fluid" style="max-width: 1200px; padding: 0 1rem;" *ngIf="!loading && instance && template">
    <div class="mx-auto">
    
    <!-- Bootstrap 5.3 Header - Tablet Optimized -->
    <div class="bg-primary bg-gradient text-white position-relative overflow-hidden p-3 mb-3 shadow-lg" style="border-radius: 12px;">
      <!-- Background Pattern -->
      <div class="position-absolute d-none d-lg-block" style="top: -30px; right: -30px; opacity: 0.1;">
        <i class="mdi mdi-clipboard-check-outline" style="font-size: 8rem; transform: rotate(15deg);"></i>
      </div>
      
      <div class="d-flex flex-column position-relative">
        <!-- Header Top Row - Responsive -->
        <div class="d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center mb-3 gap-2">
          <div class="d-flex align-items-center">
            <span class="bg-white bg-opacity-10 rounded-circle d-flex align-items-center justify-content-center me-3"
                  style="width: 2.5rem; height: 2.5rem;">
              <i class="mdi mdi-clipboard-check fs-4 text-white"></i>
            </span>
            <div>
              <h5 class="mb-1 fw-bold text-white">
                {{template.name}}
              </h5>
              <p class="text-white-50 mb-0 small">
                Work Order: {{instance.work_order_number}} | Status: {{instance.status | titlecase}}
              </p>
            </div>
          </div>
          
          <button type="button" class="btn btn-outline-light btn-sm rounded-pill px-3 ms-auto ms-md-0" (click)="goBack()">
            <i class="mdi mdi-arrow-left me-1"></i>Back to Checklists
          </button>
        </div>
        
        <!-- Progress Tracking - Mobile Optimized -->
        <div class="d-flex flex-column flex-sm-row align-items-start align-items-sm-center justify-content-between mb-3 gap-2">
          <div class="d-flex align-items-center">
            <span class="bg-white bg-opacity-10 rounded-pill px-3 py-2 me-2">
              <i class="mdi mdi-progress-check me-1 text-white"></i>
              <span class="text-white fw-semibold small">Progress: {{getCompletedItemsCount()}} of {{getTotalItemsCount()}} items</span>
            </span>
          </div>
          <span class="badge bg-white text-primary px-3 py-2 rounded-pill fw-semibold">
            <i class="mdi mdi-format-list-numbered me-1"></i>
            Step {{getCurrentItemIndex()}} / {{getTotalItemsCount()}}
          </span>
        </div>
        
        <!-- Progress Bar -->
        <div class="progress mb-3" style="height: 6px; border-radius: 3px; background: rgba(255,255,255,0.2);">
          <div class="progress-bar bg-warning progress-bar-striped progress-bar-animated" 
               [style.width.%]="getCompletionPercentage()"
               role="progressbar" 
               [attr.aria-valuenow]="getCompletedItemsCount()" 
               [attr.aria-valuemin]="0" 
               [attr.aria-valuemax]="getTotalItemsCount()"
               style="border-radius: 3px;">
          </div>
        </div>
        
        <!-- Work Order Details - Responsive Grid -->
        <div class="row g-2">
          <div class="col-sm-4">
            <div class="bg-white bg-opacity-10 rounded-3 p-2 text-center">
              <i class="mdi mdi-package-variant fs-5 text-white-50 mb-1"></i>
              <div class="small text-white-50">Part Number</div>
              <div class="fw-bold text-white small">{{instance.part_number}}</div>
            </div>
          </div>
          <div class="col-sm-4">
            <div class="bg-white bg-opacity-10 rounded-3 p-2 text-center">
              <i class="mdi mdi-barcode fs-5 text-white-50 mb-1"></i>
              <div class="small text-white-50">Serial Number</div>
              <div class="fw-bold text-white small">{{instance.serial_number}}</div>
            </div>
          </div>
          <div class="col-sm-4">
            <div class="bg-white bg-opacity-10 rounded-3 p-2 text-center">
              <i class="mdi mdi-information fs-5 text-white-50 mb-1"></i>
              <div class="small text-white-50">Completion</div>
              <div class="fw-bold text-white small">{{getCompletionPercentage()}}%</div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Bootstrap 5.3 Body - Tablet Optimized -->
    <div class="p-3" [class.loading]="saving">
      <!-- Loading Overlay -->
      <div class="loading-overlay" *ngIf="saving">
        <div class="d-flex align-items-center bg-white rounded shadow p-3">
          <div class="spinner-border spinner-border-sm text-primary me-2" role="status"></div>
          <small>Processing...</small>
        </div>
      </div>

      <!-- Submission Status Alert -->
      <div class="alert alert-success mb-3" 
           *ngIf="instance.status === 'completed' || instance.status === 'submitted'">
        <div class="d-flex align-items-center">
          <i class="mdi mdi-check-circle me-2"></i>
          <div>
            <strong>Completed!</strong> Checklist {{instance.status}} on: 
            <span class="fw-bold">{{instance.submitted_at || instance.updated_at | date:'medium'}}</span>
          </div>
        </div>
      </div>

      <!-- Debug Info (remove in production) -->
      <div class="alert alert-info alert-sm mb-3 d-none d-md-block" *ngIf="!loading && itemProgress.length > 0">
        <strong>Debug Info:</strong>
        <div *ngFor="let progress of itemProgress; let i = index" class="small">
          Item {{i+1}} (ID: {{progress.item.id}}): {{progress.photos.length}} photos
          <span *ngIf="progress.photos.length > 0"> - First photo: {{progress.photos[0]}}</span>
        </div>
      </div>

      <!-- Main Content - Photo Taking Mode - Tablet Layout -->
      <div class="row" *ngIf="!isReviewMode">
        <div class="col-12">
          <div *ngFor="let progress of getCurrentItemsToShow(); let i = index">
            
            <!-- Task Description Card - Compact for Tablets -->
            <div class="card mb-3 shadow-sm">
              <div class="card-body p-3">
                <div class="d-flex align-items-start">
                  <!-- Item Number -->
                  <div class="me-3 mt-1">
                    <div class="rounded-circle d-flex align-items-center justify-content-center text-white fw-bold" 
                         style="width: 40px; height: 40px; font-size: 0.9rem;"
                         [class]="progress.completed ? 'bg-success' : 
                                  progress.item.is_required && !progress.completed ? 'bg-danger' : 'bg-secondary'">
                      {{getCurrentItemIndex()}}
                    </div>
                  </div>
                  
                  <div class="flex-grow-1">
                    <h6 class="text-primary mb-2 d-flex flex-column flex-sm-row align-items-start align-items-sm-center gap-1">
                      <span class="d-flex align-items-center">
                        <i class="mdi mdi-clipboard-text me-2"></i>
                        Task {{getCurrentItemIndex()}} of {{getTotalItemsCount()}}
                      </span>
                      <span class="badge bg-danger ms-0 ms-sm-2" *ngIf="progress.item.is_required">Required</span>
                    </h6>
                    <p class="mb-2 fs-6 fw-medium">{{progress.item.title}}</p>
                    <p class="text-muted small mb-3" *ngIf="progress.item.description">
                      <i class="mdi mdi-information-outline me-1"></i>
                      {{progress.item.description}}
                    </p>
                    
                    <!-- Progress Indicator - Simplified for Mobile -->
                    <div class="mt-2">
                      <div class="d-flex align-items-center justify-content-between mb-1">
                        <small class="text-muted fw-bold">Task Progress</small>
                        <small class="text-muted">{{getCurrentItemIndex()}}/{{getTotalItemsCount()}}</small>
                      </div>
                      <div class="progress" style="height: 4px;">
                        <div class="progress-bar progress-bar-striped" 
                             [class]="progress.completed ? 'bg-success' : 'bg-primary'"
                             [style.width.%]="(getCurrentItemIndex() / getTotalItemsCount()) * 100"
                             role="progressbar">
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Photo and Reference Section - Tablet Optimized Layout -->
            <div class="row g-3">
              <!-- Photo Section -->
              <div class="col-12 col-lg-6">
                <div class="card h-100" [class]="progress.photos.length > 0 ? 'border-success' : 'border-secondary'">
                  <!-- Card Header - Streamlined for Touch -->
                  <div class="card-header bg-primary bg-gradient text-white position-relative overflow-hidden p-3" style="border-radius: 8px 8px 0 0;">
                    <!-- Background Pattern - Hidden on smaller screens -->
                    <div class="position-absolute d-none d-xl-block" style="top: -15px; right: -15px; opacity: 0.1;">
                      <i class="mdi mdi-camera-outline" style="font-size: 4rem; transform: rotate(15deg);"></i>
                    </div>
                    
                    <div class="d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center position-relative gap-2">
                      <div class="d-flex align-items-center">
                        <span class="bg-white bg-opacity-10 rounded-circle d-flex align-items-center justify-content-center me-2"
                              style="width: 1.8rem; height: 1.8rem;">
                          <i class="mdi mdi-camera fs-6 text-white"></i>
                        </span>
                        <div>
                          <h6 class="mb-0 fw-bold text-white">
                            Your Photo{{progress.photos.length > 1 ? 's' : ''}}
                          </h6>
                          <small class="text-white-50" *ngIf="progress.photos.length > 0">
                            {{progress.photos.length}} photo{{progress.photos.length > 1 ? 's' : ''}} uploaded
                          </small>
                        </div>
                      </div>
                      
                      <div class="d-flex align-items-center flex-wrap gap-2">
                        <!-- Photo Count Badge -->
                        <span class="badge bg-white text-primary px-2 py-1 rounded-pill fw-semibold" 
                              style="font-size: 0.75rem;">
                          <i class="mdi mdi-camera-image me-1"></i>
                          {{getPhotoCountMessage(progress.item.id)}}
                        </span>
                        <!-- Required indicator -->
                        <span class="badge bg-warning text-dark rounded-pill px-2 py-1 fw-semibold" 
                              *ngIf="getMinPhotos(progress.item) > 0"
                              style="font-size: 0.75rem;">
                          <i class="mdi mdi-alert me-1"></i>
                          Required
                        </span>
                        <!-- Compare Toggle - Touch Friendly -->
                        <button class="btn btn-outline-light btn-sm rounded-pill px-3" 
                                *ngIf="progress.photos.length > 0 && getPrimarySampleImage(progress.item)"
                                (click)="toggleCompareMode(progress.item.id)"
                                style="min-height: 36px;">
                          <i class="mdi mdi-compare me-1"></i>
                          {{isCompareMode[progress.item.id] ? 'Hide' : 'Compare'}}
                        </button>
                      </div>
                    </div>
                  </div>
                  <div class="card-body p-3">
                    
                    <!-- Photo Requirements Info - Compact -->
                    <div class="alert alert-info alert-sm mb-2 p-2" *ngIf="getMinPhotos(progress.item) > 0 || getMaxPhotos(progress.item) < 10">
                      <small>
                        <i class="mdi mdi-information me-1"></i>
                        <span *ngIf="getMinPhotos(progress.item) > 0 && getMaxPhotos(progress.item) < 10">
                          Required: {{getMinPhotos(progress.item)}}-{{getMaxPhotos(progress.item)}} photos
                        </span>
                        <span *ngIf="getMinPhotos(progress.item) > 0 && getMaxPhotos(progress.item) >= 10">
                          Minimum: {{getMinPhotos(progress.item)}} photo{{getMinPhotos(progress.item) > 1 ? 's' : ''}}
                        </span>
                        <span *ngIf="getMinPhotos(progress.item) === 0 && getMaxPhotos(progress.item) < 10">
                          Maximum: {{getMaxPhotos(progress.item)}} photo{{getMaxPhotos(progress.item) > 1 ? 's' : ''}}
                        </span>
                      </small>
                    </div>

                    <!-- Photo Count Validation Message -->
                    <div class="alert alert-sm mb-3" 
                         [class]="getPhotoStatus(progress.item.id) === 'insufficient' ? 'alert-warning' :
                                  getPhotoStatus(progress.item.id) === 'exceeded' ? 'alert-danger' : 'alert-success'"
                         *ngIf="progress.photos.length > 0 && (getPhotoStatus(progress.item.id) === 'insufficient' || getPhotoStatus(progress.item.id) === 'exceeded')">
                      <small>
                        <i class="mdi mdi-alert me-1" *ngIf="getPhotoStatus(progress.item.id) === 'insufficient' || getPhotoStatus(progress.item.id) === 'exceeded'"></i>
                        <i class="mdi mdi-check me-1" *ngIf="getPhotoStatus(progress.item.id) === 'valid'"></i>
                        {{getPhotoCountMessage(progress.item.id)}}
                      </small>
                    </div>

                    <!-- Comparison Mode -->
                    <div class="photo-comparison" *ngIf="progress.photos.length > 0 && isCompareMode[progress.item.id] && getPrimarySampleImage(progress.item)">
                      <div class="comparison-header text-center mb-2">
                        <h6 class="text-muted mb-0">
                          <i class="mdi mdi-compare me-1"></i>
                          Side-by-Side Comparison
                        </h6>
                        <small class="text-muted">Compare your photo with the sample reference</small>
                      </div>
                      
                      <div class="row g-2">
                        <!-- User Photo -->
                        <div class="col-6">
                          <div class="comparison-photo-container">
                            <div class="text-center mb-1">
                              <span class="badge bg-primary">Your Photo</span>
                            </div>
                            <img [src]="getCurrentComparisonPhoto(progress.item.id)" 
                                 class="img-fluid rounded border comparison-image" 
                                 style="width: 100%; height: 200px; object-fit: cover; cursor: pointer;"
                                 (click)="previewImage(getCurrentComparisonPhoto(progress.item.id))"
                                 [alt]="'Your photo for: ' + progress.item.title">
                            
                            <!-- Photo Navigation for multiple photos -->
                            <div class="text-center mt-1" *ngIf="progress.photos.length > 1">
                              <div class="btn-group btn-group-sm">
                                <button class="btn btn-outline-secondary" 
                                        (click)="previousComparisonPhoto(progress.item.id)"
                                        [disabled]="getCurrentComparisonIndex(progress.item.id) === 0">
                                  <i class="mdi mdi-chevron-left"></i>
                                </button>
                                <span class="btn btn-outline-secondary disabled">
                                  {{getCurrentComparisonIndex(progress.item.id) + 1}} / {{progress.photos.length}}
                                </span>
                                <button class="btn btn-outline-secondary" 
                                        (click)="nextComparisonPhoto(progress.item.id)"
                                        [disabled]="getCurrentComparisonIndex(progress.item.id) === progress.photos.length - 1">
                                  <i class="mdi mdi-chevron-right"></i>
                                </button>
                              </div>
                            </div>
                          </div>
                        </div>
                        
                        <!-- Sample Photo -->
                        <div class="col-6">
                          <div class="comparison-photo-container">
                            <div class="text-center mb-1">
                              <span class="badge bg-info">Sample Reference</span>
                            </div>
                            <img [src]="getPrimarySampleImage(progress.item)" 
                                 class="img-fluid rounded border comparison-image" 
                                 style="width: 100%; height: 200px; object-fit: cover; cursor: pointer;"
                                 (click)="previewImage(getPrimarySampleImage(progress.item))"
                                 [alt]="'Sample for: ' + progress.item.title">
                          </div>
                        </div>
                      </div>
                      
                      <!-- Comparison Tips -->
                      <div class="alert alert-info alert-sm mt-2 p-2">
                        <small>
                          <i class="mdi mdi-lightbulb-outline me-1"></i>
                          <strong>Tips:</strong> Check angle, positioning, lighting, and focus. Your photo should match the sample as closely as possible.
                        </small>
                      </div>
                    </div>

                    <!-- Regular Photo Display (when not in comparison mode) -->
                    <div class="photo-display" *ngIf="progress.photos.length > 0 && !isCompareMode[progress.item.id]">
                      <!-- Debug Info -->
                      <div class="alert alert-warning mb-2" *ngIf="progress.photos.length > 0">
                        <small><strong>Debug:</strong> {{progress.photos.length}} photos - Using {{progress.photos.length <= 3 ? 'Grid' : 'Carousel'}} layout</small>
                      </div>
                      
                      <!-- Grid Layout for 3 or fewer photos -->
                      <div class="d-flex flex-wrap gap-2 mb-3" *ngIf="progress.photos.length <= 3">
                        <div *ngFor="let photo of progress.photos; let photoIndex = index" 
                             class="position-relative photo-container">
                          <img [src]="photo" 
                               class="img-fluid rounded photo-preview" 
                               style="width: 100px; height: 100px; object-fit: cover; cursor: pointer;"
                               (click)="previewImage(photo)">
                          <!-- Individual Delete Button - Shows on hover -->
                          <button class="btn btn-danger btn-sm position-absolute top-0 end-0 p-1 photo-delete-btn"
                                  style="transform: translate(25%, -25%); border-radius: 50%; width: 24px; height: 24px; font-size: 10px; opacity: 0; transition: opacity 0.2s ease-in-out;"
                                  (click)="removePhoto(progress.item.id, photoIndex)"
                                  [disabled]="instance.status === 'completed' || instance.status === 'submitted'"
                                  title="Remove this photo">
                            <i class="mdi mdi-close"></i>
                          </button>
                        </div>
                      </div>

                      <!-- Carousel Layout for more than 3 photos -->
                      <div class="photo-carousel mb-3" *ngIf="progress.photos.length > 3" 
                           [id]="'carousel-' + progress.item.id">
                        <div class="carousel slide" [id]="'photoCarousel-' + progress.item.id" data-bs-ride="false">
                          <!-- Carousel Indicators -->
                          <div class="carousel-indicators" *ngIf="progress.photos.length > 1">
                            <button *ngFor="let photo of progress.photos; let i = index" 
                                    type="button" 
                                    [attr.data-bs-target]="'#photoCarousel-' + progress.item.id" 
                                    [attr.data-bs-slide-to]="i" 
                                    [class.active]="i === 0"
                                    [attr.aria-label]="'Photo ' + (i + 1)">
                            </button>
                          </div>
                          
                          <!-- Carousel Inner -->
                          <div class="carousel-inner rounded">
                            <div *ngFor="let photo of progress.photos; let photoIndex = index" 
                                 class="carousel-item position-relative photo-container"
                                 [class.active]="photoIndex === 0">
                              <img [src]="photo" 
                                   class="d-block w-100 photo-preview" 
                                   style="height: 200px; object-fit: cover; cursor: pointer;"
                                   (click)="previewImage(photo)">
                              <!-- Individual Delete Button - Shows on hover -->
                              <button class="btn btn-danger btn-sm position-absolute photo-delete-btn"
                                      style="top: 10px; right: 10px; border-radius: 50%; width: 32px; height: 32px; font-size: 12px; opacity: 0; transition: opacity 0.2s ease-in-out; z-index: 10;"
                                      (click)="removePhoto(progress.item.id, photoIndex)"
                                      [disabled]="instance.status === 'completed' || instance.status === 'submitted'"
                                      title="Remove this photo">
                                <i class="mdi mdi-close"></i>
                              </button>
                              <!-- Photo Counter Badge -->
                              <div class="position-absolute bottom-0 end-0 m-2">
                                <span class="badge bg-dark bg-opacity-75 text-white">
                                  {{photoIndex + 1}} / {{progress.photos.length}}
                                </span>
                              </div>
                            </div>
                          </div>
                          
                          <!-- Enhanced Carousel Controls -->
                          <button class="carousel-control-prev" type="button" 
                                  [attr.data-bs-target]="'#photoCarousel-' + progress.item.id" 
                                  data-bs-slide="prev"
                                  *ngIf="progress.photos.length > 1">
                            <div class="carousel-control-icon-wrapper">
                              <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                            </div>
                            <span class="visually-hidden">Previous</span>
                          </button>
                          <button class="carousel-control-next" type="button" 
                                  [attr.data-bs-target]="'#photoCarousel-' + progress.item.id" 
                                  data-bs-slide="next"
                                  *ngIf="progress.photos.length > 1">
                            <div class="carousel-control-icon-wrapper">
                              <span class="carousel-control-next-icon" aria-hidden="true"></span>
                            </div>
                            <span class="visually-hidden">Next</span>
                          </button>
                        </div>
                        
                        <!-- Thumbnail Strip -->
                        <div class="photo-thumbnails mt-3">
                          <div class="d-flex flex-wrap gap-2 justify-content-center">
                            <div *ngFor="let photo of progress.photos; let photoIndex = index" 
                                 class="position-relative photo-thumbnail-container">
                              <img [src]="photo" 
                                   class="img-fluid rounded photo-thumbnail" 
                                   style="width: 60px; height: 60px; object-fit: cover; cursor: pointer; border: 2px solid transparent; transition: all 0.2s ease;"
                                   [style.border-color]="photoIndex === 0 ? '#007bff' : 'transparent'"
                                   (click)="goToCarouselSlide(progress.item.id, photoIndex)"
                                   [title]="'View photo ' + (photoIndex + 1)"
                                   [attr.data-item-id]="progress.item.id"
                                   [attr.data-photo-index]="photoIndex">
                              <!-- Thumbnail Delete Button -->
                              <button class="btn btn-danger btn-sm position-absolute photo-delete-btn"
                                      style="top: -5px; right: -5px; border-radius: 50%; width: 20px; height: 20px; font-size: 10px; opacity: 0; transition: opacity 0.2s ease-in-out; z-index: 10;"
                                      (click)="$event.stopPropagation(); removePhoto(progress.item.id, photoIndex)"
                                      [disabled]="instance.status === 'completed' || instance.status === 'submitted'"
                                      title="Remove this photo">
                                <i class="mdi mdi-close"></i>
                              </button>
                            </div>
                          </div>
                        </div>
                        
                        <!-- Carousel Info -->
                        <div class="text-center mt-2">
                          <small class="text-muted">
                            <i class="mdi mdi-gesture-swipe-horizontal me-1"></i>
                            Click thumbnails or use arrows to browse {{progress.photos.length}} photos
                          </small>
                        </div>
                      </div>
                      <div class="text-center">
                        <button class="btn btn-outline-danger btn-sm me-2" 
                                (click)="removeAllPhotos(progress.item.id)"
                                [disabled]="instance.status === 'completed' || instance.status === 'submitted'">
                          <i class="mdi mdi-delete me-1"></i>
                          Remove All Photos
                        </button>
                        <label class="btn btn-outline-primary btn-sm" 
                               [for]="'add-more-' + progress.item.id"
                               *ngIf="canAddMorePhotos(progress.item.id) && instance.status !== 'completed' && instance.status !== 'submitted'">
                          <input type="file" accept="image/*" multiple
                                 class="d-none" [id]="'add-more-' + progress.item.id"
                                 (change)="onFileSelectedAndUpload($event, progress.item.id)">
                          <i class="mdi mdi-plus me-1"></i>Add More
                        </label>
                        <small class="text-muted d-block mt-2" 
                               *ngIf="!canAddMorePhotos(progress.item.id) && getMaxPhotos(progress.item) < 10">
                          Maximum photos reached ({{getMaxPhotos(progress.item)}})
                        </small>
                      </div>
                    
                    <!-- Upload Area - Tablet Optimized -->
                    <div class="upload-area" *ngIf="progress.photos.length === 0">
                      <div class="upload-placeholder text-center p-3 border-2 border-dashed rounded-4 photo-upload-area">
                        <div class="upload-animation mb-2">
                          <i class="mdi mdi-camera-plus text-primary mb-2" 
                             style="font-size: 3rem; animation: pulse 2s infinite;"></i>
                        </div>
                        <h6 class="text-primary mb-2 fw-bold fs-6">Upload Photos</h6>
                        <p class="text-muted mb-3 small">
                          <span *ngIf="getMinPhotos(progress.item) > 0" class="d-flex align-items-center justify-content-center">
                            <i class="mdi mdi-alert-circle me-1 text-warning"></i>
                            {{getMinPhotos(progress.item)}} photo{{getMinPhotos(progress.item) > 1 ? 's' : ''}} required
                          </span>
                          <span *ngIf="getMinPhotos(progress.item) === 0" class="d-flex align-items-center justify-content-center">
                            <i class="mdi mdi-camera-image me-1 text-info"></i>
                            Photos optional
                          </span>
                          <span *ngIf="getMaxPhotos(progress.item) < 10" class="d-block mt-1">
                            <small class="text-muted">(max {{getMaxPhotos(progress.item)}})</small>
                          </span>
                        </p>
                        
                        <!-- Error message for invalid item ID -->
                        <div class="alert alert-danger mb-2 p-2" *ngIf="!hasValidItemId(progress.item.id)">
                          <small>
                            <i class="mdi mdi-alert-circle me-2"></i>
                            <strong>Error:</strong> This item has an invalid ID ({{progress.item.id}}). Please reload the page or contact support.
                          </small>
                        </div>
                        
                        <!-- Enhanced Upload Options - Touch Optimized -->
                        <div class="upload-buttons d-flex justify-content-center flex-column flex-sm-row mb-3 gap-2">
                          <!-- Camera Capture - Larger Touch Target -->
                          <label class="btn btn-primary btn-lg rounded-pill px-4 shadow-sm" 
                                 [for]="'camera-' + progress.item.id"
                                 *ngIf="canAddMorePhotos(progress.item.id) && hasValidItemId(progress.item.id)"
                                 style="transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); min-height: 48px; touch-action: manipulation;">
                            <input type="file" accept="image/*" capture="environment"
                                   class="d-none" [id]="'camera-' + progress.item.id"
                                   (change)="hasValidItemId(progress.item.id) ? onFileSelectedAndUpload($event, progress.item.id) : null" 
                                   [disabled]="instance.status === 'completed' || instance.status === 'submitted'">
                            <i class="mdi mdi-camera me-2"></i>
                            Take Photo
                          </label>
                          
                          <!-- Gallery Upload - Larger Touch Target -->
                          <label class="btn btn-outline-primary btn-lg rounded-pill px-4 shadow-sm" 
                                 [for]="'gallery-' + progress.item.id"
                                 *ngIf="canAddMorePhotos(progress.item.id) && hasValidItemId(progress.item.id)"
                                 style="transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); min-height: 48px; touch-action: manipulation;">
                            <input type="file" accept="image/*" multiple
                                   class="d-none" [id]="'gallery-' + progress.item.id"
                                   (change)="hasValidItemId(progress.item.id) ? onFileSelectedAndUpload($event, progress.item.id) : null" 
                                   [disabled]="instance.status === 'completed' || instance.status === 'submitted'">
                            <i class="mdi mdi-image me-2"></i>
                            Choose Files
                          </label>
                        </div>
                        
                        <!-- Max Photos Reached Message with better styling -->
                        <div class="alert alert-warning text-center p-3 mb-0 border-0 rounded-pill" 
                             *ngIf="!canAddMorePhotos(progress.item.id)"
                             style="background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%);">
                          <i class="mdi mdi-alert-circle me-2" style="font-size: 1.2rem;"></i>
                          <small><strong>Maximum photos reached:</strong> {{getMaxPhotos(progress.item)}} photo{{getMaxPhotos(progress.item) > 1 ? 's' : ''}} allowed</small>
                        </div>
                        
                        <!-- Enhanced Quick Tips -->
                        <div class="alert alert-info text-center p-3 mb-0 border-0 rounded-pill" 
                             *ngIf="canAddMorePhotos(progress.item.id)"
                             style="background: linear-gradient(135deg, #d1ecf1 0%, #bee5eb 100%);">
                          <i class="mdi mdi-lightbulb-outline me-2" style="font-size: 1.2rem;"></i>
                          <small><strong>Tip:</strong> Use "Take Photo" for best quality or "Choose Files" for existing photos</small>
                        </div>
                      </div>
                    </div>

                    <!-- Enhanced Upload Progress -->
                    <div class="text-center py-4" *ngIf="uploadProgress[progress.item.id] !== undefined">
                      <div class="upload-progress-container">
                        <i class="mdi mdi-cloud-upload text-primary mb-2" style="font-size: 2rem; animation: pulse 1s infinite;"></i>
                        <h6 class="text-primary mb-2">Uploading Photos...</h6>
                        <div class="progress mx-auto mb-2" style="width: 80%; height: 8px; border-radius: 4px;">
                          <div class="progress-bar progress-bar-striped progress-bar-animated bg-primary" 
                               [style.width.%]="uploadProgress[progress.item.id]"
                               style="transition: width 0.3s ease;"></div>
                        </div>
                        <small class="text-muted fw-bold">{{uploadProgress[progress.item.id]}}% complete</small>
                      </div>
                    </div>

                    <!-- Enhanced Auto Upload Message -->
                    <div class="mt-3" *ngIf="selectedFiles[progress.item.id] && uploadProgress[progress.item.id] === undefined">
                      <div class="alert alert-info alert-sm p-3 mb-0 border-0 rounded-pill text-center"
                           style="background: linear-gradient(135deg, #d1ecf1 0%, #bee5eb 100%);">
                        <i class="mdi mdi-upload me-2 text-info" style="animation: pulse 1s infinite;"></i>
                        <small class="fw-bold">Photos will be uploaded automatically...</small>
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Sample Reference Section - Tablet Optimized -->
              <div class="col-12 col-lg-6">
                <div class="card sample-card h-100">
                  <div class="card-header bg-info bg-gradient text-white position-relative overflow-hidden p-3" style="border-radius: 8px 8px 0 0;">
                    <!-- Background Pattern - Hidden on smaller screens -->
                    <div class="position-absolute d-none d-xl-block" style="top: -15px; right: -15px; opacity: 0.1;">
                      <i class="mdi mdi-image-outline" style="font-size: 4rem; transform: rotate(15deg);"></i>
                    </div>
                    
                    <div class="d-flex justify-content-between align-items-center position-relative">
                      <div class="d-flex align-items-center">
                        <span class="bg-white bg-opacity-10 rounded-circle d-flex align-items-center justify-content-center me-2"
                              style="width: 1.8rem; height: 1.8rem;">
                          <i class="mdi mdi-image fs-6 text-white"></i>
                        </span>
                        <div>
                          <h6 class="mb-0 fw-bold text-white">
                            Sample Reference
                          </h6>
                          <small class="text-white-50">
                            Expected photo example
                          </small>
                        </div>
                      </div>
                    </div>
                  </div>
                  <div class="card-body p-3">
                    <div *ngIf="getPrimarySampleImage(progress.item); else noSample">
                      <div class="sample-image-container mb-3">
                        <img [src]="getPrimarySampleImage(progress.item)" 
                             class="img-fluid rounded border" 
                             style="width: 100%; max-height: 250px; object-fit: contain; background-color: #f8f9fa; cursor: pointer;"
                             [alt]="'Sample for: ' + progress.item.title"
                             (click)="previewImage(getPrimarySampleImage(progress.item))"
                             (error)="onImageError($event)">
                      </div>
                      
                      <div class="requirements-list" *ngIf="hasPhotoRequirements(progress.item.photo_requirements)">
                        <small class="text-muted">
                          <strong>Photo Requirements:</strong>
                          <ul class="mt-2 ps-3">
                            <li *ngIf="getPhotoRequirements(progress.item.photo_requirements)?.angle">
                              <i class="mdi mdi-check"></i> 
                              Angle: {{getPhotoRequirements(progress.item.photo_requirements)?.angle | titlecase}}
                            </li>
                            <li *ngIf="getPhotoRequirements(progress.item.photo_requirements)?.distance">
                              <i class="mdi mdi-check"></i> 
                              Distance: {{getPhotoRequirements(progress.item.photo_requirements)?.distance | titlecase}}
                            </li>
                            <li *ngIf="getPhotoRequirements(progress.item.photo_requirements)?.lighting">
                              <i class="mdi mdi-check"></i> 
                              Lighting: {{getPhotoRequirements(progress.item.photo_requirements)?.lighting | titlecase}}
                            </li>
                            <li *ngIf="getPhotoRequirements(progress.item.photo_requirements)?.focus">
                              <i class="mdi mdi-check"></i> 
                              Focus: {{getPhotoRequirements(progress.item.photo_requirements)?.focus}}
                            </li>
                          </ul>
                        </small>
                      </div>
                      
                      <div class="requirements-list" *ngIf="!hasPhotoRequirements(progress.item.photo_requirements)">
                        <small class="text-muted">
                          <strong>Photo Requirements:</strong>
                          <ul class="mt-2 ps-3">
                            <li><i class="mdi mdi-check"></i> Match the angle and positioning</li>
                            <li><i class="mdi mdi-check"></i> Include all visible components</li>
                            <li><i class="mdi mdi-check"></i> Ensure good lighting and clarity</li>
                          </ul>
                        </small>
                      </div>
                    </div>
                    
                    <ng-template #noSample>
                      <div class="no-sample text-center p-4">
                        <i class="mdi mdi-image-off text-muted mb-2" style="font-size: 3rem;"></i>
                        <p class="text-muted mb-2"><strong>No image to reference</strong></p>
                        <small class="text-muted">Follow standard photo guidelines</small>
                      </div>
                    </ng-template>
                  </div>
                </div>
              </div>
            </div>

            <!-- Notes and Completion Section -->
            <div class="row mt-4">
              <div class="col-12">
                <div class="card mb-4">
                  <div class="card-header bg-success bg-gradient text-white position-relative overflow-hidden p-3" style="border-radius: 8px 8px 0 0;">
                    <!-- Background Pattern -->
                    <div class="position-absolute" style="top: -15px; right: -15px; opacity: 0.1;">
                      <i class="mdi mdi-clipboard-check-outline" style="font-size: 4rem; transform: rotate(15deg);"></i>
                    </div>
                    
                    <div class="d-flex justify-content-between align-items-center position-relative">
                      <div class="d-flex align-items-center">
                        <span class="bg-white bg-opacity-10 rounded-circle d-flex align-items-center justify-content-center me-3"
                              style="width: 2rem; height: 2rem;">
                          <i class="mdi mdi-note-text fs-5 text-white"></i>
                        </span>
                        <div>
                          <h6 class="mb-0 fw-bold text-white">
                            Notes & Completion
                          </h6>
                          <small class="text-white-50">
                            Add notes and mark as complete
                          </small>
                        </div>
                      </div>
                    </div>
                  </div>
                  <div class="card-body p-4">
                    <!-- Notes -->
                    <div class="mb-4">
                      <label class="form-label fw-bold">Notes (Optional)</label>
                      <textarea class="form-control" 
                                rows="3" 
                                [(ngModel)]="progress.notes"
                                [placeholder]="'Add notes for ' + progress.item.title + '...'"
                                [disabled]="instance.status === 'completed' || instance.status === 'submitted'"
                                (input)="onNotesChange(progress.item.id)"
                                style="border-radius: 8px;"></textarea>
                      <div class="text-muted small mt-1">
                        <span *ngIf="notesSaving" class="text-warning">
                          <i class="mdi mdi-loading mdi-spin me-1"></i>Saving notes...
                        </span>
                        <span *ngIf="!notesSaving && notesLastSaved" class="text-success">
                          <i class="mdi mdi-check-circle me-1"></i>Notes saved {{ notesLastSaved | date:'short' }}
                        </span>
                        <span *ngIf="!notesSaving && !notesLastSaved">
                          <i class="mdi mdi-content-save-outline me-1"></i>Notes auto-save as you type
                        </span>
                      </div>
                    </div>
                    
                    <!-- Completion Checkbox -->
                    <div class="form-check d-flex align-items-center p-3 bg-light rounded-3">
                      <input class="form-check-input me-3" 
                             style="transform: scale(1.3);"
                             type="checkbox" 
                             [checked]="progress.completed"
                             (change)="toggleItemCompletion(progress.item.id)"
                             [id]="'item-' + progress.item.id"
                             [disabled]="instance.status === 'completed' || instance.status === 'submitted'">
                      <label class="form-check-label fs-6" [for]="'item-' + progress.item.id">
                        <strong>Mark this task as completed</strong>
                        <div class="text-muted small mt-1" *ngIf="progress.completedAt">
                          Completed: {{progress.completedAt | date:'medium'}}
                        </div>
                      </label>
                    </div>
                  </div>
                </div>
              </div>
            </div>

          </div>
        </div>
      </div>

      <!-- Simplified Tablet-Friendly Review Mode -->
      <div class="review-mode-tablet" *ngIf="isReviewMode">
        <div class="container-fluid" style="max-width: 1200px;">
          
          <!-- Review Header -->
          <div class="card mb-3">
            <div class="card-body p-3">
              <div class="d-flex flex-column flex-sm-row justify-content-between align-items-start align-items-sm-center gap-3">
                <div>
                  <h4 class="mb-1">📋 Photo Review</h4>
                  <p class="text-muted mb-0">Review all completed checklist items</p>
                </div>
                <div class="d-flex align-items-center gap-3">
                  <div class="form-check form-switch">
                    <input type="checkbox" class="form-check-input" id="viewToggle" [(ngModel)]="largeView">
                    <label class="form-check-label fw-bold" for="viewToggle">
                      {{largeView ? '🔍 Detailed' : '📊 Summary'}}
                    </label>
                  </div>
                  <button class="btn btn-outline-primary btn-sm" (click)="isReviewMode = false">
                    <i class="mdi mdi-pencil me-1"></i>Back to Edit
                  </button>
                </div>
              </div>
            </div>
          </div>

          <!-- Summary View (Mobile-Optimized Cards) -->
          <div *ngIf="!largeView">
            <div class="row g-3">
              <div class="col-12 col-md-6 col-lg-4" *ngFor="let progress of itemProgress; let i = index">
                <div class="card h-100" [class]="progress.completed ? 'border-success' : 'border-warning'">
                  <div class="card-body p-3">
                    <div class="d-flex justify-content-between align-items-start mb-2">
                      <h6 class="mb-0 fw-bold">{{i + 1}}. {{progress.item.title}}</h6>
                      <span class="badge" [class]="progress.completed ? 'bg-success' : 'bg-warning'">
                        {{progress.completed ? '✅' : '⏳'}}
                      </span>
                    </div>
                    
                    <div class="d-flex gap-2 mb-3">
                      <!-- Sample Thumbnail -->
                      <div class="flex-shrink-0">
                        <img [src]="getPrimarySampleImage(progress.item)" 
                             class="rounded border" 
                             style="width: 60px; height: 60px; object-fit: cover;"
                             *ngIf="getPrimarySampleImage(progress.item)"
                             [alt]="'Sample for ' + progress.item.title">
                        <div class="bg-light border rounded d-flex align-items-center justify-content-center text-muted" 
                             style="width: 60px; height: 60px;" *ngIf="!getPrimarySampleImage(progress.item)">
                          <i class="mdi mdi-image-off"></i>
                        </div>
                      </div>
                      
                      <!-- User Photos -->
                      <div class="flex-grow-1">
                        <div class="d-flex flex-wrap gap-1" *ngIf="progress.photos.length > 0">
                          <img *ngFor="let photo of progress.photos.slice(0, 3)" 
                               [src]="photo" 
                               class="rounded border" 
                               style="width: 40px; height: 40px; object-fit: cover;"
                               (click)="previewImage(photo)">
                          <div class="bg-primary text-white rounded d-flex align-items-center justify-content-center" 
                               style="width: 40px; height: 40px; font-size: 0.75rem;" 
                               *ngIf="progress.photos.length > 3">
                            +{{progress.photos.length - 3}}
                          </div>
                        </div>
                        <div class="text-muted small" *ngIf="progress.photos.length === 0">
                          No photos uploaded
                        </div>
                      </div>
                    </div>
                    
                    <div class="d-grid">
                      <button class="btn btn-outline-primary btn-sm" (click)="goToItemAndExitReview(i + 1)">
                        <i class="mdi mdi-pencil me-1"></i>Edit Task
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Detailed View -->
          <div *ngIf="largeView">
            <div *ngFor="let progress of itemProgress; let i = index" class="card mb-3">
              <div class="card-header bg-light">
                <div class="d-flex justify-content-between align-items-center">
                  <h5 class="mb-0">{{i + 1}}. {{progress.item.title}}</h5>
                  <span class="badge fs-6" [class]="progress.completed ? 'bg-success' : 'bg-warning'">
                    {{progress.completed ? 'Complete' : 'Incomplete'}}
                  </span>
                </div>
              </div>
              <div class="card-body p-3">
                <div class="row g-3">
                  <div class="col-md-6">
                    <h6 class="text-muted mb-2">📷 Sample Reference</h6>
                    <div class="border rounded bg-light text-center" style="min-height: 200px;">
                      <img [src]="getPrimarySampleImage(progress.item)" 
                           class="img-fluid rounded p-2" 
                           style="max-height: 190px; cursor: pointer;" 
                           (click)="previewImage(getPrimarySampleImage(progress.item))"
                           *ngIf="getPrimarySampleImage(progress.item)">
                      <div class="d-flex align-items-center justify-content-center h-100 text-muted" 
                           *ngIf="!getPrimarySampleImage(progress.item)">
                        <div>
                          <i class="mdi mdi-image-off display-6"></i>
                          <div>No sample available</div>
                        </div>
                      </div>
                    </div>
                  </div>
                  
                  <div class="col-md-6">
                    <h6 class="text-muted mb-2">📸 Your Photos ({{progress.photos.length}})</h6>
                    <div class="border rounded p-2" style="min-height: 200px;">
                      <div class="d-flex flex-wrap gap-2" *ngIf="progress.photos.length > 0">
                        <img *ngFor="let photo of progress.photos" 
                             [src]="photo" 
                             class="rounded border" 
                             style="width: 80px; height: 80px; object-fit: cover; cursor: pointer;"
                             (click)="previewImage(photo)">
                      </div>
                      <div class="d-flex align-items-center justify-content-center h-100 text-muted" 
                           *ngIf="progress.photos.length === 0">
                        <div class="text-center">
                          <i class="mdi mdi-camera-off display-6"></i>
                          <div>No photos uploaded</div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
                
                <div class="mt-3" *ngIf="progress.notes">
                  <h6 class="text-muted mb-2">📝 Notes</h6>
                  <div class="alert alert-info mb-0">{{progress.notes}}</div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Simplified Tablet-Friendly Navigation -->
  <div class="navigation-tablet card shadow-lg mt-3" style="max-width: 1200px; margin: 1rem auto 0 auto;" *ngIf="!loading && instance">
    <div class="card-body p-3">
      
      <!-- Step Navigation (only in non-review mode) -->
      <div class="mb-3" *ngIf="!isReviewMode">
        <h6 class="text-muted mb-3">
          <i class="mdi mdi-step-forward me-2"></i>
          Step {{getCurrentItemIndex()}} of {{getTotalItemsCount()}}
        </h6>
        
        <div class="row g-2">
          <div class="col-4">
            <button type="button" 
                    class="btn btn-outline-primary w-100 rounded-pill" 
                    (click)="previousItem()"
                    [disabled]="isFirstItem()"
                    style="min-height: 48px;">
              <i class="mdi mdi-chevron-left"></i>
              <span class="d-none d-sm-inline ms-1">Previous</span>
            </button>
          </div>
          
          <div class="col-4">
            <div class="text-center">
              <div class="progress mb-1" style="height: 8px;">
                <div class="progress-bar bg-primary" 
                     [style.width.%]="(getCurrentItemIndex() / getTotalItemsCount()) * 100">
                </div>
              </div>
              <small class="text-muted fw-bold">
                {{getCurrentItemIndex()}} / {{getTotalItemsCount()}}
              </small>
            </div>
          </div>
          
          <div class="col-4">
            <button type="button" 
                    class="btn btn-outline-primary w-100 rounded-pill" 
                    (click)="nextItem()"
                    [disabled]="isLastItem()"
                    style="min-height: 48px;">
              <span class="d-none d-sm-inline me-1">Next</span>
              <i class="mdi mdi-chevron-right"></i>
            </button>
          </div>
        </div>
      </div>
      
      <!-- Action Buttons -->
      <div class="d-grid gap-2 d-sm-flex justify-content-sm-center">
        <!-- Close Button -->
        <button (click)="goBack()" 
                type="button" 
                class="btn btn-outline-secondary rounded-pill px-4"
                style="min-height: 48px;">
          <i class="mdi mdi-close me-2"></i>Close
        </button>
        
        <!-- Review Toggle -->
        <button (click)="isReviewMode = !isReviewMode" 
                type="button" 
                class="btn rounded-pill px-4" 
                [class]="isReviewMode ? 'btn-warning' : 'btn-info'"
                style="min-height: 48px;">
          <i class="mdi" [class]="isReviewMode ? 'mdi-pencil' : 'mdi-eye'"></i>
          <span class="ms-2">{{isReviewMode ? 'Edit Mode' : 'Review All'}}</span>
          <span class="badge bg-light ms-2 rounded-pill" 
                [class]="isReviewMode ? 'text-warning' : 'text-info'">
            {{getCompletedItemsCount()}}/{{getTotalItemsCount()}}
          </span>
        </button>
        
        <!-- Save Progress -->
        <button (click)="saveProgress()" 
                type="button" 
                class="btn btn-success rounded-pill px-4" 
                [disabled]="saving"
                style="min-height: 48px;">
          <i class="mdi mdi-content-save me-2" *ngIf="!saving"></i>
          <div class="spinner-border spinner-border-sm me-2" *ngIf="saving"></div>
          Save Progress
        </button>
        
        <!-- Submit -->
        <button (click)="submitChecklist()" 
                type="button" 
                class="btn btn-primary rounded-pill px-4 fw-bold" 
                *ngIf="instance.status !== 'completed' && instance.status !== 'submitted'" 
                [disabled]="saving || getRequiredCompletionStatus().completed < getRequiredCompletionStatus().total"
                style="min-height: 48px;">
          <i class="mdi mdi-send me-2"></i>Submit
          <span class="badge bg-light text-primary ms-2" 
                *ngIf="getRequiredCompletionStatus().completed === getRequiredCompletionStatus().total">
            Ready!
          </span>
        </button>
      </div>
    </div>

  <!-- Error State -->
  <div class="container text-center py-5" style="max-width: 1400px; margin: 0 auto;" *ngIf="!loading && !instance">
    <i class="mdi mdi-alert-circle-outline text-muted mb-3" style="font-size: 4rem;"></i>
    <h4 class="text-muted">Checklist Instance Not Found</h4>
    <p class="text-muted mb-4">The requested checklist instance could not be loaded.</p>
    <button class="btn btn-primary" (click)="goBack()">
      <i class="mdi mdi-arrow-left me-2"></i>Back to Checklists
    </button>
  </div>

</div>
