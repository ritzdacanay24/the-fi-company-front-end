<div class="container-fluid">
  <div class="row justify-content-center">
    <div class="col-12 col-lg-11 col-xl-10 col-xxl-9">

      <!-- Breadcrumb -->
      <nav aria-label="breadcrumb" class="mb-3">
        <ol class="breadcrumb mb-0">
          <li class="breadcrumb-item">
            <a href="#" class="text-decoration-none" (click)="$event.preventDefault(); goToSessions()">
              <i class="mdi mdi-home-outline me-1"></i>Training
            </a>
          </li>
          <li class="breadcrumb-item">
            <a href="#" class="text-decoration-none" (click)="$event.preventDefault(); goToSessions()">
              Training Sessions
            </a>
          </li>
          <li class="breadcrumb-item active" aria-current="page">
            {{ isEditMode ? 'Edit Session' : 'Create New Session' }}
          </li>
        </ol>
      </nav>

      <!-- Page Header with Context -->
      <div class="mb-4">
        <div class="d-flex align-items-center justify-content-between mb-3">
          <div class="d-flex align-items-center">
            <button type="button" class="btn btn-outline-secondary me-3" (click)="goToSessions()" [disabled]="isSaving"
              title="Back to Training Sessions">
              <i class="mdi mdi-arrow-left me-2"></i>Back
            </button>
            <div class="bg-primary bg-gradient rounded-circle me-3 d-flex align-items-center justify-content-center"
              style="width: 60px; height: 60px;">
              <i class="mdi mdi-{{ isEditMode ? 'pencil' : 'plus' }} text-white fs-4"></i>
            </div>
            <div>
              <h2 class="mb-1 text-primary">{{ isEditMode ? 'Edit Training Session' : 'Create Training Session' }}</h2>
              <p class="text-muted mb-0">{{ isEditMode ? 'Update training session details and attendees' : 'Set up a new training session and assign expected attendees' }}</p>
            </div>
          </div>
          
          <!-- Action Buttons -->
          <div class="d-flex gap-2" *ngIf="!isEditMode && !showTemplateSelection">
            <button type="button" class="btn btn-outline-primary" (click)="showTemplateSelection = true">
              <i class="mdi mdi-file-document-multiple me-2"></i>Use Template
            </button>
            <button type="button" class="btn btn-outline-secondary" (click)="clearForm()" *ngIf="selectedTemplate">
              <i class="mdi mdi-refresh me-2"></i>Clear Form
            </button>
          </div>
        </div>

        <div class="alert alert-primary border-primary border-opacity-25 bg-primary bg-opacity-10" role="alert">
          <div class="d-flex align-items-start">
            <i class="mdi mdi-information-outline text-primary me-3 mt-1 fs-5"></i>
            <div>
              <h6 class="alert-heading text-primary mb-2">{{ isEditMode ? 'Updating Training Session' : 'Creating a New Training Session' }}</h6>
              <p class="mb-0">
                {{ isEditMode ? 'Modify session details and attendee list as needed.' : 'Complete all required fields to create a comprehensive training session.' }}
                <strong>Attendees</strong> will be notified upon session creation.
              </p>
            </div>
          </div>
        </div>
      </div>

      <!-- Loading State -->
      <div *ngIf="isLoading" class="text-center py-5">
        <div class="spinner-border text-primary" role="status">
          <span class="visually-hidden">Loading...</span>
        </div>
        <p class="mt-2 text-muted">Loading employee data...</p>
      </div>

      <!-- Template Selection (Only for new sessions) -->
      <div *ngIf="!isLoading && !isEditMode && showTemplateSelection" class="card shadow-sm border-0 mb-4">
        <div class="card-header bg-light">
          <div class="d-flex justify-content-between align-items-center">
            <h5 class="mb-0">
              <i class="mdi mdi-file-document-multiple me-2 text-primary"></i>
              Start with Template
            </h5>
            <a href="#" class="btn btn-sm btn-outline-primary" (click)="$event.preventDefault(); goToTemplates()">
              <i class="mdi mdi-plus me-1"></i>Manage Templates
            </a>
          </div>
        </div>
        <div class="card-body">
          <p class="text-muted mb-3">Use an existing template to quickly set up your training session with pre-defined content.</p>
          
          <div class="row" *ngIf="availableTemplates && availableTemplates.length > 0; else noTemplates">
            <div class="col-md-6 col-lg-4 mb-3" *ngFor="let template of availableTemplates.slice(0, 3)">
              <div class="card border template-preview-card h-100" (click)="useTemplate(template)">
                <div class="card-body p-3">
                  <div class="d-flex justify-content-between align-items-start mb-2">
                    <h6 class="card-title mb-1">{{ template.name }}</h6>
                    <span class="badge rounded-pill" 
                          [style.background-color]="getCategoryColor(template.category)"
                          [style.color]="'white'">
                      {{ template.category }}
                    </span>
                  </div>
                  <p class="card-text text-muted small mb-2">{{ template.descriptionTemplate }}</p>
                  <div class="d-flex justify-content-between align-items-center">
                    <small class="text-muted">
                      <i class="mdi mdi-clock-outline me-1"></i>{{ formatDuration(template.defaultDurationMinutes) }}
                    </small>
                    <button type="button" class="btn btn-sm btn-primary">
                      <i class="mdi mdi-play me-1"></i>Use
                    </button>
                  </div>
                </div>
              </div>
            </div>
            
            <div class="col-12" *ngIf="availableTemplates.length > 3">
              <div class="text-center">
                <a href="#" class="btn btn-outline-primary" (click)="$event.preventDefault(); goToTemplates()">
                  <i class="mdi mdi-eye me-2"></i>View All {{ availableTemplates.length }} Templates
                </a>
              </div>
            </div>
          </div>
          
          <ng-template #noTemplates>
            <div class="text-center py-4">
              <div class="text-muted mb-3">
                <i class="mdi mdi-file-document-plus fs-1"></i>
              </div>
              <p class="text-muted mb-3">No templates available yet.</p>
              <a href="#" class="btn btn-primary" (click)="$event.preventDefault(); goToTemplates()">
                <i class="mdi mdi-plus me-2"></i>Create First Template
              </a>
            </div>
          </ng-template>
          
          <hr class="my-3">
          
          <div class="text-center">
            <button type="button" class="btn btn-outline-secondary" (click)="startFromScratch()">
              <i class="mdi mdi-pencil me-2"></i>Start from Scratch
            </button>
          </div>
        </div>
      </div>

      <!-- Main Form -->
      <div *ngIf="!isLoading">
        <form [formGroup]="trainingForm" (ngSubmit)="onSubmit()">
          <div class="row">
            <!-- Training Details - Full Width -->
            <div class="col-12">
              <div class="card shadow-sm border-0 mb-4">
                <div class="card-header bg-light">
                  <h5 class="mb-0">
                    <i class="mdi mdi-school me-2 text-primary"></i>
                    Training Details
                  </h5>
                </div>
                <div class="card-body">

                  <!-- Training Title -->
                  <div class="mb-3">
                    <label for="title" class="form-label">Training Title *</label>
                    <input type="text" class="form-control" id="title" formControlName="title"
                      [class.is-invalid]="isFieldInvalid('title')" placeholder="e.g., Forklift Safety Training">
                    <div class="form-text">Minimum 3 characters required</div>
                    <div class="invalid-feedback" *ngIf="isFieldInvalid('title')">
                      {{ getFieldError('title') }}
                    </div>
                  </div>

                  <!-- Purpose -->
                  <div class="mb-3">
                    <label for="purpose" class="form-label">Purpose *</label>
                    <input type="text" class="form-control" id="purpose" formControlName="purpose"
                      [class.is-invalid]="isFieldInvalid('purpose')"
                      placeholder="e.g., Safety compliance, Skills development, Certification">
                    <div class="invalid-feedback" *ngIf="isFieldInvalid('purpose')">
                      {{ getFieldError('purpose') }}
                    </div>
                  </div>

                  <!-- Description -->
                  <div class="mb-3">
                    <label for="description" class="form-label">Description *</label>
                    <textarea class="form-control" id="description" formControlName="description"
                      [class.is-invalid]="isFieldInvalid('description')" rows="3"
                      placeholder="Detailed description of the training content and objectives..."></textarea>
                    <div class="form-text">Minimum 10 characters required</div>
                    <div class="invalid-feedback" *ngIf="isFieldInvalid('description')">
                      {{ getFieldError('description') }}
                    </div>
                  </div>

                  <!-- Date & Time Row -->
                  <div class="row">
                    <div class="col-md-3">
                      <div class="mb-3">
                        <label for="date" class="form-label">Date *</label>
                        <input type="date" class="form-control" id="date" formControlName="date"
                          [class.is-invalid]="isFieldInvalid('date')">
                        <div class="invalid-feedback" *ngIf="isFieldInvalid('date')">
                          {{ getFieldError('date') }}
                        </div>
                      </div>
                    </div>
                    <div class="col-md-2">
                      <div class="mb-3">
                        <label for="startTime" class="form-label">Start Time *</label>
                        <input type="time" class="form-control" id="startTime" formControlName="startTime"
                          [class.is-invalid]="isFieldInvalid('startTime')">
                        <div class="invalid-feedback" *ngIf="isFieldInvalid('startTime')">
                          {{ getFieldError('startTime') }}
                        </div>
                      </div>
                    </div>
                    <div class="col-md-2">
                      <div class="mb-3">
                        <label for="endTime" class="form-label">End Time *</label>
                        <input type="time" class="form-control" id="endTime" formControlName="endTime"
                          [class.is-invalid]="isFieldInvalid('endTime')">
                        <div class="invalid-feedback" *ngIf="isFieldInvalid('endTime')">
                          {{ getFieldError('endTime') }}
                        </div>
                      </div>
                    </div>
                    <div class="col-md-5">
                      <div class="mb-3 text-end">
                        <label class="form-label">Duration</label>
                        <div class="form-control-plaintext">
                          <strong>{{ calculateDuration() }}</strong>
                        </div>
                      </div>
                    </div>
                  </div>

                  <!-- Facilitator Name -->
                  <div class="row">
                    <div class="col-md-6">
                      <div class="mb-3">
                        <label for="location" class="form-label">Location *</label>
                        <input type="text" class="form-control" id="location" formControlName="location"
                          [class.is-invalid]="isFieldInvalid('location')"
                          placeholder="e.g., Training Room A, Conference Room B">
                        <div class="invalid-feedback" *ngIf="isFieldInvalid('location')">
                          {{ getFieldError('location') }}
                        </div>
                      </div>
                    </div>
                    <div class="col-md-6">
                      <div class="mb-3">
                        <label for="facilitatorName" class="form-label">Facilitator Name *</label>
                        <input type="text" class="form-control" id="facilitatorName" formControlName="facilitatorName"
                          [class.is-invalid]="isFieldInvalid('facilitatorName')" placeholder="e.g., John Smith">
                        <div class="invalid-feedback" *ngIf="isFieldInvalid('facilitatorName')">
                          {{ getFieldError('facilitatorName') }}
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Attendee Selection Section -->
            <div class="col-12 mt-4">
              <div class="card shadow-sm border-0 mb-4">
                <div class="card-header bg-light">
                  <h5 class="mb-0">
                    <i class="mdi mdi-account-group me-2 text-primary"></i>
                    Expected Attendees
                    <span class="badge bg-primary ms-2">{{ selectedEmployees.length }} selected</span>
                  </h5>
                </div>
                <div class="card-body">

                    <!-- Employee Search -->
                    <div class="row mb-3">
                      <div class="col-md-6">
                        <div class="employee-search-section">
                          <label for="employeeSearch" class="form-label">Search Employees</label>
                          <div class="position-relative">
                            <input type="text" class="form-control" id="employeeSearch" [(ngModel)]="employeeSearchTerm"
                              (input)="onEmployeeSearch(getEventTargetValue($event))"
                              [ngModelOptions]="{standalone: true}"
                              placeholder="Search by name, position, department, or badge number..." autocomplete="off">

                            <!-- Search Dropdown -->
                            <div class="employee-dropdown" *ngIf="showEmployeeDropdown && filteredEmployees.length > 0">
                              <div *ngFor="let employee of filteredEmployees.slice(0, 10)"
                                class="employee-dropdown-item" (click)="selectEmployee(employee)"
                                [class.disabled]="isEmployeeSelected(employee.id)">
                                <div class="employee-avatar">
                                  {{ (employee.firstName || '?').charAt(0) }}{{ (employee.lastName || '?').charAt(0) }}
                                </div>
                                <div class="employee-info">
                                  <div class="employee-name">{{ employee.firstName || 'Unknown' }} {{ employee.lastName || 'Name' }}</div>
                                  <div class="employee-details">{{ employee.position || 'No Position' }} • {{ employee.department || 'No Department' }}
                                  </div>
                                </div>
                                <!-- <div class="employee-badge">{{ employee.badgeNumber || 'No Badge' }}</div> -->
                              </div>
                            </div>
                          </div>
                        </div>
                      </div>

                      <!-- Bulk Selection -->
                      <div class="col-md-6">
                        <div class="bulk-selection-section">
                          <label class="form-label">Bulk Selection</label>
                          <div class="d-flex gap-2 flex-wrap">
                            <button type="button" class="btn btn-outline-secondary"
                              (click)="selectAllEmployees()">
                              <i class="mdi mdi-account-multiple"></i> All Employees
                            </button>
                            <div class="dropdown">
                              <button class="btn btn-outline-secondary dropdown-toggle" type="button"
                                data-bs-toggle="dropdown" aria-expanded="false">
                                <i class="mdi mdi-office-building"></i> By Department
                              </button>
                              <ul class="dropdown-menu">
                                <li *ngFor="let dept of getUniqueDepartments()">
                                  <a class="dropdown-item" href="#"
                                    (click)="selectByDepartment(dept); $event.preventDefault()">
                                    {{ dept }}
                                  </a>
                                </li>
                              </ul>
                            </div>
                            <button type="button" class="btn btn-outline-danger" (click)="clearAllEmployees()">
                              <i class="mdi mdi-close"></i> Clear All
                            </button>
                          </div>
                        </div>
                      </div>
                    </div>

                    <!-- Selected Attendees -->
                    <div class="selected-attendees-section">
                      <h6>Selected Attendees ({{ selectedEmployees.length }})</h6>

                      <div *ngIf="selectedEmployees.length === 0" class="text-muted text-center py-4">
                        <i class="mdi mdi-account-group-outline text-muted" style="font-size: 3rem;"></i>
                        <p>No attendees selected yet. Search and select employees above.</p>
                      </div>

                      <div class="attendees-grid" *ngIf="selectedEmployees.length > 0">
                        <div *ngFor="let employee of selectedEmployees" class="selected-attendee-item">
                          <div class="attendee-avatar">
                            {{ (employee.firstName || '?').charAt(0) }}{{ (employee.lastName || '?').charAt(0) }}
                          </div>
                          <div class="attendee-info">
                            <div class="attendee-name">{{ employee.firstName || 'Unknown' }} {{ employee.lastName || 'Name' }}</div>
                            <div class="attendee-details">{{ employee.position || 'No Position' }} • {{ employee.department || 'No Department' }}</div>
                          </div>
                          <!-- <div class="attendee-badge">{{ employee.badgeNumber }}</div> -->
                          <button type="button" class="btn btn-outline-danger btn-sm"
                            (click)="removeEmployee(employee.id)">
                            <i class="mdi mdi-close"></i>
                          </button>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Success/Error Messages -->
            <div class="alert alert-success" *ngIf="showSuccessMessage" role="alert">
              <i class="mdi mdi-check-circle me-2"></i>
              {{ messageText }}
              <button *ngIf="createdSession" type="button" class="btn btn-sm btn-success ms-3" (click)="goToSignOff()">
                <i class="mdi mdi-card-account-details"></i>
                Go to Sign-Off Page
              </button>
            </div>

            <div class="alert alert-danger" *ngIf="showErrorMessage" role="alert">
              <i class="mdi mdi-alert-circle me-2"></i>
              {{ messageText }}
            </div>

            <!-- Submit Card with Footer -->
            <div class="card shadow-sm border-0">
              <div class="card-footer bg-light border-top d-flex p-3">
                <button type="button" class="btn btn-outline-secondary me-2" [disabled]="isSaving"
                  (click)="goToSessions()">
                  <i class="mdi mdi-close me-1"></i>Cancel
                </button>
                <button type="button" class="btn btn-primary ms-auto"
                  [disabled]="isSaving || trainingForm.invalid || selectedEmployees.length === 0"
                  (click)="onSubmit()">
                  <span *ngIf="isSaving" class="spinner-border spinner-border-sm me-2" role="status"></span>
                  <i *ngIf="!isSaving" class="mdi mdi-check-circle-outline me-1"></i>
                  {{ isSaving ? (isEditMode ? 'Updating...' : 'Creating...') : (isEditMode ? 'Update Training Session' : 'Create Training Session') }}
                </button>
              </div>
            </div>
        </form>
      </div>
    </div>
  </div>
</div>