<div class="container-fluid">
  <div class="row justify-content-center">
    <div class="col-12 col-lg-11 col-xl-10 col-xxl-8">

      <!-- Loading State -->
      <div *ngIf="isLoading" class="d-flex justify-content-center align-items-center" style="min-height: 400px;">
        <div class="text-center">
          <div class="spinner-border text-warning mb-3" role="status">
            <span class="visually-hidden">Loading...</span>
          </div>
          <p class="text-muted">Loading safety incident details...</p>
        </div>
      </div>

      <!-- Page Header with Context -->
      <div class="mb-4" *ngIf="!isLoading">
        <div class="d-flex align-items-center mb-3">
          <button type="button" class="btn btn-outline-secondary me-3" (click)="goBack()" 
            title="Back to Safety Incident List">
            <i class="mdi mdi-arrow-left me-2"></i>Back
          </button>
          <div class="bg-warning bg-gradient rounded-circle me-3 d-flex align-items-center justify-content-center"
            style="width: 60px; height: 60px;">
            <i class="mdi mdi-shield-alert text-white fs-4"></i>
          </div>
          <div class="flex-grow-1">
            <h2 class="mb-1 text-warning">{{title}}</h2>
            <p class="text-muted mb-0">View safety incident report and investigation details</p>
          </div>
          <button type="button" class="btn btn-warning" (click)="goToEdit()" 
            title="Edit Safety Incident">
            <i class="mdi mdi-pencil me-1"></i>Edit
          </button>
        </div>

        <!-- Incident Summary Alert -->
        <div class="alert border-0 shadow-sm mb-4" [ngClass]="{
          'alert-danger bg-danger bg-opacity-10 border-danger border-opacity-25': getSeverityBadgeClass(processedData.type_of_incident) === 'bg-danger',
          'alert-warning bg-warning bg-opacity-10 border-warning border-opacity-25': getSeverityBadgeClass(processedData.type_of_incident) === 'bg-warning',
          'alert-info bg-info bg-opacity-10 border-info border-opacity-25': getSeverityBadgeClass(processedData.type_of_incident) === 'bg-info',
          'alert-primary bg-primary bg-opacity-10 border-primary border-opacity-25': getSeverityBadgeClass(processedData.type_of_incident) === 'bg-primary',
          'alert-secondary bg-secondary bg-opacity-10 border-secondary border-opacity-25': getSeverityBadgeClass(processedData.type_of_incident) === 'bg-secondary'
        }">
          <div class="d-flex align-items-start">
            <i class="mdi mdi-shield-alert fs-4 me-3 mt-1" [ngClass]="{
              'text-danger': getSeverityBadgeClass(processedData.type_of_incident) === 'bg-danger',
              'text-warning': getSeverityBadgeClass(processedData.type_of_incident) === 'bg-warning',
              'text-info': getSeverityBadgeClass(processedData.type_of_incident) === 'bg-info',
              'text-primary': getSeverityBadgeClass(processedData.type_of_incident) === 'bg-primary',
              'text-secondary': getSeverityBadgeClass(processedData.type_of_incident) === 'bg-secondary'
            }"></i>
            <div>
              <div class="d-flex align-items-center flex-wrap gap-2 mb-2">
                <h6 class="alert-heading mb-0">Safety Incident #{{processedData.id}}</h6>
                <span class="badge" [ngClass]="getStatusBadgeClass(data?.status)">
                  {{processedData.status}}
                </span>
                <span class="badge" [ngClass]="getSeverityBadgeClass(processedData.type_of_incident)">
                  {{processedData.type_of_incident}}
                </span>
              </div>
              <p class="mb-1">
                <strong>Date:</strong> {{processedData.date_of_incident}} 
                <span *ngIf="processedData.time_of_incident !== 'N/A'">at {{processedData.time_of_incident}}</span>
              </p>
              <p class="mb-0">
                <strong>Location:</strong> {{processedData.location_of_incident}}
                <span *ngIf="processedData.location_of_incident_other !== 'N/A'"> - {{processedData.location_of_incident_other}}</span>
              </p>
            </div>
          </div>
        </div>
      </div>

      <!-- Main Content -->
      <div class="row" *ngIf="!isLoading">
        
        <!-- Left Column - Incident Details -->
        <div class="col-md-8">
          
          <!-- Reporter Information Card -->
          <div class="card shadow-sm border-0 mb-4">
            <div class="card-header bg-light border-0 py-3">
              <h5 class="card-title mb-0">
                <i class="mdi mdi-account-circle me-2 text-primary"></i>Reporter Information
              </h5>
            </div>
            <div class="card-body">
              <div class="row">
                <div class="col-md-6 mb-3">
                  <label class="form-label text-muted small">First Name</label>
                  <p class="mb-0 fw-medium">{{processedData.first_name}}</p>
                </div>
                <div class="col-md-6 mb-3">
                  <label class="form-label text-muted small">Last Name</label>
                  <p class="mb-0 fw-medium">{{processedData.last_name}}</p>
                </div>
              </div>
            </div>
          </div>

          <!-- Incident Details Card -->
          <div class="card shadow-sm border-0 mb-4">
            <div class="card-header bg-light border-0 py-3">
              <h5 class="card-title mb-0">
                <i class="mdi mdi-calendar-clock me-2 text-primary"></i>Incident Details
              </h5>
            </div>
            <div class="card-body">
              <div class="row">
                <div class="col-md-6 mb-3">
                  <label class="form-label text-muted small">Date of Incident</label>
                  <p class="mb-0 fw-medium">{{processedData.date_of_incident}}</p>
                </div>
                <div class="col-md-6 mb-3">
                  <label class="form-label text-muted small">Time of Incident</label>
                  <p class="mb-0 fw-medium">{{processedData.time_of_incident}}</p>
                </div>
              </div>
            </div>
          </div>

          <!-- Classification Card -->
          <div class="card shadow-sm border-0 mb-4">
            <div class="card-header bg-light border-0 py-3">
              <h5 class="card-title mb-0">
                <i class="mdi mdi-tag-multiple me-2 text-primary"></i>Incident Classification
              </h5>
            </div>
            <div class="card-body">
              <div class="row">
                <div class="col-md-6 mb-3">
                  <label class="form-label text-muted small">Type of Incident</label>
                  <p class="mb-0 fw-medium">{{processedData.type_of_incident}}</p>
                </div>
                <div class="col-md-6 mb-3" *ngIf="processedData.type_of_incident_other !== 'N/A'">
                  <label class="form-label text-muted small">Other Type Specified</label>
                  <p class="mb-0 fw-medium">{{processedData.type_of_incident_other}}</p>
                </div>
              </div>
              <div class="row">
                <div class="col-md-12 mb-3">
                  <label class="form-label text-muted small">Location of Incident</label>
                  <p class="mb-0 fw-medium">{{processedData.location_of_incident}}</p>
                  <div *ngIf="processedData.location_of_incident_other !== 'N/A'" class="mt-2">
                    <label class="form-label text-muted small">Specific Area</label>
                    <p class="mb-0 fw-medium">{{processedData.location_of_incident_other}}</p>
                  </div>
                  <div *ngIf="processedData.location_of_incident_other_other !== 'N/A'" class="mt-2">
                    <label class="form-label text-muted small">Additional Location Details</label>
                    <p class="mb-0 fw-medium">{{processedData.location_of_incident_other_other}}</p>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Description Card -->
          <div class="card shadow-sm border-0 mb-4">
            <div class="card-header bg-light border-0 py-3">
              <h5 class="card-title mb-0">
                <i class="mdi mdi-text-long me-2 text-primary"></i>Incident Description
              </h5>
            </div>
            <div class="card-body">
              <div class="mb-3">
                <label class="form-label text-muted small">Description of Incident</label>
                <div class="p-3 bg-light rounded">
                  <p class="mb-0" [innerHTML]="processedData.description_of_incident"></p>
                </div>
              </div>
              <div class="mb-3">
                <label class="form-label text-muted small">Details of Damage or Personal Injury</label>
                <div class="p-3 bg-light rounded">
                  <p class="mb-0" [innerHTML]="processedData.details_of_any_damage_or_personal_injury"></p>
                </div>
              </div>
            </div>
          </div>

          <!-- Corrective Actions Card -->
          <div class="card shadow-sm border-0 mb-4">
            <div class="card-header bg-light border-0 py-3">
              <h5 class="card-title mb-0">
                <i class="mdi mdi-shield-check me-2 text-primary"></i>Corrective Actions
              </h5>
            </div>
            <div class="card-body">
              <div class="row">
                <div class="col-md-6 mb-3">
                  <label class="form-label text-muted small">Action Owner</label>
                  <p class="mb-0 fw-medium">{{processedData.corrective_action_owner}}</p>
                  <small class="text-muted" *ngIf="processedData.corrective_action_owner_user_email !== 'N/A'">
                    {{processedData.corrective_action_owner_user_email}}
                  </small>
                </div>
                <div class="col-md-3 mb-3">
                  <label class="form-label text-muted small">Proposed Date</label>
                  <p class="mb-0 fw-medium">{{processedData.proposed_corrective_action_completion_date}}</p>
                </div>
                <div class="col-md-3 mb-3">
                  <label class="form-label text-muted small">Completed Date</label>
                  <p class="mb-0 fw-medium">{{processedData.confirmed_corrective_action_completion_date}}</p>
                </div>
              </div>
              <div class="mb-3">
                <label class="form-label text-muted small">Proposed Corrective Action</label>
                <div class="p-3 bg-light rounded">
                  <p class="mb-0" [innerHTML]="processedData.proposed_corrective_action"></p>
                </div>
              </div>
              <div class="mb-3" *ngIf="processedData.comments !== 'N/A'">
                <label class="form-label text-muted small">Administrative Comments</label>
                <div class="p-3 bg-light rounded">
                  <p class="mb-0" [innerHTML]="processedData.comments"></p>
                </div>
              </div>
            </div>
          </div>

        </div>

        <!-- Right Column - Metadata & Attachments -->
        <div class="col-md-4">
          
          <!-- Status Card -->
          <div class="card shadow-sm border-0 mb-4">
            <div class="card-header bg-light border-0 py-3">
              <h6 class="card-title mb-0">
                <i class="mdi mdi-information me-2 text-primary"></i>Investigation Status
              </h6>
            </div>
            <div class="card-body">
              <div class="text-center mb-3">
                <span class="badge fs-6 px-3 py-2" [ngClass]="getStatusBadgeClass(data?.status)">
                  {{processedData.status}}
                </span>
              </div>
              <div class="d-flex align-items-center mb-2">
                <i class="mdi mdi-shield-alert me-2 text-muted"></i>
                <span class="badge" [ngClass]="getSeverityBadgeClass(processedData.type_of_incident)">
                  Severity Classification
                </span>
              </div>
            </div>
          </div>

          <!-- Supporting Documentation -->
          <div class="card shadow-sm border-0 mb-4">
            <div class="card-header bg-light border-0 py-3">
              <h6 class="card-title mb-0">
                <i class="mdi mdi-paperclip me-2 text-primary"></i>Supporting Documentation
              </h6>
            </div>
            <div class="card-body">
              <div *ngIf="attachments.length === 0" class="text-center text-muted py-3">
                <i class="mdi mdi-file-outline fs-1 mb-2 d-block"></i>
                No supporting documents uploaded
              </div>
              <div *ngIf="attachments.length > 0">
                <div *ngFor="let attachment of attachments" class="d-flex align-items-center p-2 border rounded mb-2">
                  <i class="mdi mdi-file-document me-2 text-primary"></i>
                  <div class="flex-grow-1" style="overflow:hidden; text-overflow: ellipsis;">
                    <p class="mb-0 small fw-medium">{{attachment.fileName}}</p>
                    <small class="text-muted">{{attachment.fileSizeConv}}</small>
                  </div>
                  <a [href]="attachment.url" target="_blank" class="btn btn-sm btn-outline-primary">
                    <i class="mdi mdi-download"></i>
                  </a>
                </div>
              </div>
            </div>
          </div>

        </div>
      </div>

    </div>
  </div>
</div>

<style>
.timeline-marker {
  width: 8px;
  height: 8px;
  border-radius: 50%;
  flex-shrink: 0;
}

.timeline-item:not(:last-child) {
  position: relative;
}

.timeline-item:not(:last-child)::before {
  content: '';
  position: absolute;
  left: 4px;
  top: 20px;
  width: 1px;
  height: calc(100% - 8px);
  background-color: #dee2e6;
}

.badge.fs-6 {
  font-size: 0.875rem !important;
}
</style>