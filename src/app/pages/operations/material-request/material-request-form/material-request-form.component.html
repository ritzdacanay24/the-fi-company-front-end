<form [formGroup]="form" class="settings-form" autocomplete="off">

  <!-- Form Lock Status Alert -->
  <div class="alert alert-info d-flex align-items-center mb-4" *ngIf="form.disabled">
    <i class="mdi mdi-lock-outline me-2 fs-5"></i>
    <div>
      <strong>Read-Only Mode:</strong> This form is locked to prevent modifications and maintain data integrity.
    </div>
  </div>

  <div class="body">
    <ng-container formGroupName="main">

      <!-- Request Information Section -->
      <div class="mb-4 pb-4 border-bottom">
        <div class="mb-3">
          <h3 class="h5 mb-1">Request Information</h3>
          <p class="text-muted mb-0">
            Basic information about the material request and requestor.
          </p>
        </div>

        <div class="row">
          <div class="col-md-6 mb-3">
            <label class="form-label" [ngClass]="formValidator('main.requestor')">
              Requestor
            </label>
            <input type="text" class="form-control" name="requestor" formControlName="requestor"
              placeholder="Enter your name" [ngClass]="{ 'is-invalid': submitted && f.requestor.errors }" />
            <div class="form-text">
              <i class="mdi mdi-information-outline me-1"></i>
              Name of the person requesting the materials.
            </div>
          </div>

          <div class="col-md-6 mb-3">
            <label class="form-label" [ngClass]="formValidator('main.dueDate')">
              Due Date
            </label>
            <input type="date" class="form-control" name="dueDate" formControlName="dueDate"
              placeholder="Enter due date" [ngClass]="{ 'is-invalid': submitted && f.dueDate.errors }" />
            <div class="form-text">
              <i class="mdi mdi-information-outline me-1"></i>
              When these materials are needed.
            </div>
          </div>
        </div>

        <div class="row">
          <div class="col-md-6 mb-3">
            <label class="form-label" [ngClass]="formValidator('main.assemblyNumber')">
              Assembly Number
            </label>
            <input type="text" class="form-control" name="assemblyNumber" formControlName="assemblyNumber"
              placeholder="Enter assembly number" [ngClass]="{ 'is-invalid': submitted && f.assemblyNumber.errors }" />
            <div class="form-text">
              <i class="mdi mdi-information-outline me-1"></i>
              Assembly or part number this request relates to.
            </div>
          </div>

          <div class="col-md-6 mb-3">
            <label class="form-label" [ngClass]="formValidator('main.priority')">
              Priority
            </label>
            <select class="form-select" formControlName="priority"
              [ngClass]="{ 'is-invalid': submitted && f.priority.errors }">
              <option *ngFor="let row of materialRequestForm.priorityOptions">{{row}}</option>
            </select>
            <div class="form-text">
              <i class="mdi mdi-information-outline me-1"></i>
              Request priority level for scheduling.
            </div>
          </div>
        </div>
      </div>

      <!-- Production Details Section -->
      <div class="mb-4 pb-4 border-bottom">
        <div class="mb-3">
          <h3 class="h5 mb-1">Production Details</h3>
          <p class="text-muted mb-0">
            Pick list and line number references for production tracking.
          </p>
        </div>

        <div class="row">
          <div class="col-md-6 mb-3">
            <label class="form-label" [ngClass]="formValidator('main.pickList')">
              Pick List
            </label>
            <input type="text" class="form-control" name="pickList" formControlName="pickList"
              placeholder="Enter pick list number" [ngClass]="{ 'is-invalid': submitted && f.pickList.errors }" />
            <div class="form-text">
              <i class="mdi mdi-information-outline me-1"></i>
              Production pick list number reference.
            </div>
          </div>

          <div class="col-md-6 mb-3">
            <label class="form-label" [ngClass]="formValidator('main.lineNumber')">
              Line Number
            </label>
            <input type="text" class="form-control" name="lineNumber" formControlName="lineNumber"
              placeholder="Enter line number" [ngClass]="{ 'is-invalid': submitted && f.lineNumber.errors }" />
            <div class="form-text">
              <i class="mdi mdi-information-outline me-1"></i>
              Production line number for tracking.
            </div>
          </div>
        </div>
      </div>

      <!-- Additional Information Section -->
      <div class="mb-4 pb-4 border-bottom">
        <div class="mb-3">
          <h3 class="h5 mb-1">Additional Information</h3>
          <p class="text-muted mb-0">
            Special instructions and request status settings.
          </p>
        </div>

        <div class="row">
          <div class="col-12 mb-3">
            <label class="form-label" [ngClass]="formValidator('main.specialInstructions')">
              Special Instructions
            </label>
            <textarea type="text" class="form-control" name="specialInstructions" formControlName="specialInstructions"
              placeholder="Enter any special instructions or requirements"
              [ngClass]="{ 'is-invalid': submitted && f.specialInstructions.errors }" rows="4"></textarea>
            <div class="form-text">
              <i class="mdi mdi-information-outline me-1"></i>
              Any special handling instructions or requirements for this request.
            </div>
          </div>
        </div>

        <div class="row">
          <div class="col-md-12 mb-3">
            <label class="form-label">Request Status</label>
            
            <!-- Active Status Display -->
            <div class="card shadow-none px-0 rounded-0" *ngIf="form.get('main.active')?.value">
              <div class="d-flex align-items-center">
                <div class="flex-shrink-0">
                  <i class="mdi mdi-check-circle text-success fs-4"></i>
                </div>
                <div class="flex-grow-1 ms-3">
                  <h6 class="mb-1 text-success">Active Request</h6>
                  <p class="text-muted mb-0 small">This material request is active and available for processing.</p>
                </div>
                <div class="flex-shrink-0">
                  <button type="button" class="btn btn-outline-danger btn-sm" 
                          (click)="onActiveChange && onActiveChange()"
                          title="Deactivate this request">
                    <i class="mdi mdi-close-circle-outline me-1"></i>
                    Deactivate
                  </button>
                </div>
              </div>
            </div>

            <!-- Deactivated Status Display -->
            <div class="card shadow-none px-0 rounded-0" *ngIf="!form.get('main.active')?.value">
              <div class="d-flex align-items-center">
                <div class="flex-shrink-0">
                  <i class="mdi mdi-alert-circle text-warning fs-4"></i>
                </div>
                <div class="flex-grow-1 ms-3">
                  <h6 class="mb-1 text-warning">Deactivated Request</h6>
                  <div class="small text-muted">
                    <div *ngIf="form.get('main.deleteReason')?.value" class="mb-1">
                      <strong>Reason:</strong> {{form.get('main.deleteReason')?.value}}
                    </div>
                    <div *ngIf="form.get('main.deleteReasonDate')?.value">
                      <strong>Date:</strong> {{form.get('main.deleteReasonDate')?.value | date:'medium'}}
                    </div>
                  </div>
                </div>
                <div class="flex-shrink-0">
                  <button type="button" class="btn btn-outline-success btn-sm" 
                          (click)="onActiveChange && onActiveChange()"
                          title="Reactivate this request">
                    <i class="mdi mdi-check-circle-outline me-1"></i>
                    Reactivate
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </ng-container>

    <!-- Line Details Section -->
    <div class="mb-4">
      <div class="mb-3">
        <h3 class="h5 mb-1">Line Details</h3>
        <p class="text-muted mb-0">
          Individual material items and quantities requested.
        </p>
      </div>

      <div *ngIf="enableEdit">
        <div class="alert alert-light border mb-3">
          <div class="d-flex align-items-center mb-2">
            <i class="mdi mdi-information-outline text-primary me-2"></i>
            <strong>Input Format:</strong>
          </div>
          <p class="mb-1">
            One <span class="text-primary fw-bold">PART NUMBER</span> and <span
              class="text-success fw-bold">QUANTITY</span> per line.
          </p>
          <div class="mt-2">
            <small class="text-muted">Examples:</small>
            <ul class="list-unstyled mt-1 mb-0">
              <li><span class="text-primary">EYE12794</span> <span class="text-success">25</span></li>
              <li><span class="text-primary">ELE-44581-424</span> <span class="text-success">3</span></li>
              <li><span class="text-primary">EYE12795</span> <span class="text-success">5</span></li>
            </ul>
          </div>
        </div>

        <div class="row">
          <div class="col-md-6 mb-3">
            <label class="form-label">Default Reason Code</label>
            <ng-select [appendTo]="'body'" [items]="materialRequestForm.reasonCategory" [searchable]="true"
              [(ngModel)]="reasonCode" [ngModelOptions]="{standalone: true}" bindLabel="value" bindValue="value"
              placeholder="Select default reason code for all items" [clearable]="true" [editableSearchTerm]="true">
            </ng-select>
            <div class="form-text">
              <i class="mdi mdi-information-outline me-1"></i>
              This reason code will be applied to all new items added below.
            </div>
          </div>
        </div>

        <div class="mb-3">
          <label class="form-label">Bulk Item Entry</label>
          <ace [config]="aceConfig" [mode]="'plain_text'" [theme]="aceTheme" [(value)]="value"
            (textChanged)="onChange($event)" #editor class="border border-light" id="editor"></ace>
          <div class="form-text">
            <i class="mdi mdi-information-outline me-1"></i>
            Enter multiple items quickly using the format above, then click Validate to process.
          </div>
        </div>

        <button class="btn btn-primary mb-4" (click)="onValidate()" [disabled]="this.form?.disabled">
          <i class="mdi mdi-check-circle-outline me-1"></i>
          Validate Items
        </button>
      </div>

      <!-- Items Summary -->
      <div *ngIf="getDetails.length" class="mb-3">
        <div class="d-flex align-items-center justify-content-between">
          <div>
            <span class="text-muted">Request Items:</span>
            <span class="badge bg-primary ms-2">{{getDetails.length}} items</span>
          </div>
          <span *ngIf="this.form.value.main.pickedCompletedDate" class="badge bg-success">
            <i class="mdi mdi-check-circle me-1"></i>Picked Complete
          </span>
        </div>
      </div>

      <!-- Read-Only Table (When Picked/Completed) -->
      <div *ngIf="getDetails.length && this.form.value.main.pickedCompletedDate">
        <div class="table-responsive">
          <table class="table table-hover mb-0 border">
            <thead class="bg-light">
              <tr>
                <th class="border-0 fw-semibold">Part Number</th>
                <th class="border-0 fw-semibold">Description</th>
                <th class="border-0 fw-semibold">Reason</th>
                <th class="border-0 fw-semibold text-end">Requested</th>
                <th class="border-0 fw-semibold text-end">Picked</th>
                <th class="border-0 fw-semibold text-end">Shortage ID</th>
                <th class="border-0 fw-semibold">Transaction</th>
                <th class="border-0 fw-semibold">Account</th>
                <th class="border-0 fw-semibold">Comments</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let row of getDetails.controls; let i = index">
                <td class="align-middle">
                  <span class="fw-medium text-dark">{{row.value.partNumber}}</span>
                </td>
                <td class="align-middle">
                  <div class="text-truncate" style="max-width: 200px;" [title]="row.value.description">
                    {{row.value.description || 'No description'}}
                  </div>
                </td>
                <td class="align-middle">
                  <span class="badge bg-secondary">{{row.value.reasonCode}}</span>
                </td>
                <td class="align-middle text-end">
                  <span class="fw-medium">{{row.value.qty}}</span>
                </td>
                <td class="align-middle text-end">
                  <span class="fw-medium text-success">{{row.value.qtyPicked}}</span>
                </td>
                <td class="align-middle text-end">
                  <a (click)="viewShortageId(row.value.shortage_id)"
                    class="btn btn-link btn-sm p-0 text-decoration-none" *ngIf="row.value.shortage_id">
                    {{row.value.shortage_id}}
                  </a>
                  <span class="text-muted" *ngIf="!row.value.shortage_id">-</span>
                </td>
                <td class="align-middle">
                  <small class="text-muted">{{row.value.trType || '-'}}</small>
                </td>
                <td class="align-middle">
                  <small class="text-muted">{{row.value.ac_code || '-'}}</small>
                </td>
                <td class="align-middle">
                  <div class="text-truncate" style="max-width: 150px;" [title]="row.value.notes">
                    {{row.value.notes || '-'}}
                  </div>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>

      <!-- Editable Table (Active Request) -->
      <ng-container formGroupName="details" *ngIf="getDetails.length && !this.form.value.main.pickedCompletedDate">
        <div class="table-responsive">
          <table class="table table-borderless mb-0 border">
            <thead class="bg-light sticky-top">
              <tr>
                <th class="border-0 text-center" style="width: 60px;">
                  <i class="mdi mdi-information-outline text-muted" title="Item Status"></i>
                </th>
                <th class="border-0 fw-semibold" style="min-width: 220px;">
                  Part Number <span class="text-danger">*</span>
                </th>
                <th class="border-0 fw-semibold" style="min-width: 200px;">
                  Reason Code <span class="text-danger">*</span>
                </th>
                <th class="border-0 fw-semibold text-center" style="min-width: 120px;">
                  Quantity <span class="text-danger">*</span>
                </th>
                <th class="border-0 fw-semibold text-center" style="min-width: 120px;">
                  Available
                </th>
                <th class="border-0 fw-semibold" style="min-width: 180px;" *ngIf="id">
                  Transaction
                </th>
                <th class="border-0 fw-semibold" style="min-width: 180px;" *ngIf="id">
                  Account Code
                </th>
                <th class="border-0 fw-semibold" style="min-width: 200px;">
                  Comments
                </th>
                <th class="border-0 text-center" style="width: 60px;">
                  <i class="mdi mdi-delete-outline text-muted" title="Actions"></i>
                </th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let row of getDetails.controls; let i=index" [formGroupName]="i"
                class="border-bottom position-relative">

                <!-- Status Column -->
                <td class="align-middle text-center py-3">
                  <div class="d-flex flex-column align-items-center">
                    <!-- Loading State -->
                    <div *ngIf="isLoading" class="spinner-border spinner-border-sm text-primary" role="status">
                      <span class="visually-hidden">Loading...</span>
                    </div>

                    <!-- Success State -->
                    <div *ngIf="!isLoading && !row.value.message && !row.value.isDuplicate" class="text-success"
                      title="Valid part number">
                      <i class="mdi mdi-check-circle fs-5"></i>
                    </div>

                    <!-- Error State -->
                    <div *ngIf="!isLoading && row.value.message" class="text-danger"
                      [title]="'Part number not found: ' + row.value.message">
                      <i class="mdi mdi-alert-circle fs-5"></i>
                    </div>

                    <!-- Warning State -->
                    <div *ngIf="!isLoading && row.value.isDuplicate" class="text-warning"
                      title="Duplicate part number detected">
                      <i class="mdi mdi-content-duplicate fs-5"></i>
                    </div>
                  </div>
                </td>

                <!-- Part Number Column -->
                <td class="align-middle py-3">
                  <app-qad-part-search appendToBody="body" (notifyParent)="notifyParent($event, i, row)"
                    [value]="row.value.partNumber" [showLabel]="false" [virtualScroll]="false"
                    [editableSearchTerm]="true" [hideSelected]="false" [className]="'custom1'"
                    [disabled]="form.disabled"
                    [ngClass]="{ 'is-invalid': isValidating && row.get('partNumber').errors }">
                  </app-qad-part-search>
                </td>

                <!-- Reason Code Column -->
                <td class="align-middle py-3">
                  <ng-select [appendTo]="'body'" [items]="materialRequestForm.reasonCategory" [searchable]="true"
                    formControlName="reasonCode" bindLabel="value" bindValue="value" placeholder="Select reason"
                    [clearable]="true" [editableSearchTerm]="true"
                    [ngClass]="{ 'is-invalid': isValidating && row.get('reasonCode').errors }">
                  </ng-select>
                </td>

                <!-- Quantity Column -->
                <td class="align-middle py-3">
                  <input type="number" class="form-control text-center" formControlName="qty" placeholder="0" min="1"
                    [ngClass]="{ 'is-invalid': isValidating && row.get('qty').errors }" />
                </td>

                <!-- Available Quantity Column -->
                <td class="align-middle py-3 text-center">
                  <span class="badge" [ngClass]="row.value.availableQty > 0 ? 'bg-success' : 'bg-warning'">
                    {{row.value.availableQty || '0'}}
                  </span>
                </td>

                <!-- Transaction Column -->
                <td class="align-middle py-3" *ngIf="id">
                  <ng-select appendTo="body" [items]="materialRequestForm.transactionType" [searchable]="true"
                    formControlName="trType" bindLabel="TrType" bindValue="TrType" placeholder="Select transaction"
                    [clearable]="false" [editableSearchTerm]="true"
                    [ngClass]="{ 'is-invalid': isValidating && row.get('trType').errors }">
                    <ng-template ng-option-tmp let-item="item">
                      <div class="fw-medium">{{item.TrType}}</div>
                      <small class="text-muted">{{item.Description}}</small>
                    </ng-template>
                  </ng-select>
                </td>

                <!-- Account Code Column -->
                <td class="align-middle py-3" *ngIf="id">
                  <ng-select appendTo="body" [items]="materialRequestForm.accountCodes" [searchable]="true"
                    formControlName="ac_code" bindLabel="ac_code" bindValue="ac_code" placeholder="Select account"
                    [clearable]="false" [editableSearchTerm]="true"
                    [ngClass]="{ 'is-invalid': isValidating && row.get('ac_code').errors }">
                    <ng-template ng-option-tmp let-item="item">
                      <div class="fw-medium">{{item.ac_code}}</div>
                      <small class="text-muted">{{item.ac_desc}}</small>
                    </ng-template>
                  </ng-select>
                </td>

                <!-- Comments Column -->
                <td class="align-middle py-3">
                  <input type="text" class="form-control" formControlName="notes" placeholder="Optional notes..." />
                </td>

                <!-- Actions Column -->
                <td class="align-middle py-3 text-center">
                  <button class="btn btn-outline-danger btn-sm" (click)="onDeleteItem(row.value, i)"
                    [disabled]="form.disabled" title="Remove this item">
                    <i class="mdi mdi-delete-outline"></i>
                  </button>
                </td>
              </tr>

              <!-- Description Row -->
              <tr *ngFor="let row of getDetails.controls; let i=index" class="bg-light">
                <td colspan="10" class="py-2 border-bottom">
                  <div class="d-flex align-items-center">
                    <i class="mdi mdi-information-outline text-muted me-2"></i>
                    <small class="text-muted">
                      <strong>Description:</strong>
                      <span [class]="row.value.description ? 'text-dark' : 'text-warning'">
                        {{row.value.description || 'No description found'}}
                      </span>
                    </small>
                  </div>
                </td>
              </tr>
            </tbody>
          </table>
        </div>

        <!-- Empty State for Editable Table -->
        <div class="text-center py-5 border rounded bg-light" *ngIf="!getDetails.length">
          <div class="text-muted">
            <i class="mdi mdi-package-variant-closed display-4 text-muted mb-3"></i>
            <h6 class="text-muted">No items added yet</h6>
            <p class="mb-0">Use the bulk entry tool above to add multiple items quickly.</p>
          </div>
        </div>
      </ng-container>

      <!-- No Items Message -->
      <div class="alert alert-info d-flex align-items-center" *ngIf="!getDetails.length && !enableEdit">
        <i class="mdi mdi-information-outline me-2"></i>
        <div>
          No line items have been added to this material request yet.
        </div>
      </div>
    </div>
  </div>
</form>