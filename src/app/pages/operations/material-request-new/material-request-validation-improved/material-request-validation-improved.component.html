    <!-- Reviewer Section: Only visible to assigned reviewer when pending-department-review -->
    <div class="row mb-3" *ngIf="requestData?.currentReviewer === authService.currentUserValue?.id && requestData?.status === 'pending-department-review'">
      <div class="col-12">
        <div class="card card-body border-info">
          <h5 class="mb-3 text-info">You are assigned as Reviewer</h5>
          <div class="mb-2">
            <label for="reviewerNotesInput" class="form-label">Reviewer Notes</label>
            <textarea id="reviewerNotesInput" class="form-control" [(ngModel)]="reviewerNotes" name="reviewerNotesInput" rows="3" placeholder="Add your review notes here..."></textarea>
          </div>
          <button type="button" class="btn btn-primary" (click)="reviewerSubmitNotes(reviewerNotes)">
            <i class="ri-share-back-line"></i> Send Back to Admin
          </button>
        </div>
      </div>
    </div>
<div class="container-fluid" *ngIf="!isLoading && requestData">
  
  <!-- Header Section -->
  <div class="row mb-4">
    <div class="col-12">
      <div class="card">
        <div class="card-header">
          <div class="d-flex justify-content-between align-items-center">
            <div>
              <h4 class="mb-1">Material Request Validation</h4>
              <p class="text-muted mb-0">Request ID: <strong>#{{requestId}}</strong></p>
            </div>
            <button class="btn btn-outline-secondary" (click)="goBack()">
              <i class="ri-arrow-left-line"></i> Back to List
            </button>
          </div>
        </div>
        
        <!-- Request Summary -->
        <div class="card-body">
          <div class="row">
            <div class="col-md-6">
              <h6 class="text-muted mb-3">Request Information</h6>
              <div class="row">
                <div class="col-6">
                  <p class="mb-2"><strong>Requestor:</strong> {{requestData.requestor}}</p>
                  <p class="mb-2"><strong>Assembly:</strong> {{requestData.assemblyNumber}}</p>
                  <p class="mb-2"><strong>Line Number:</strong> {{requestData.lineNumber}}</p>
                </div>
                <div class="col-6">
                  <p class="mb-2"><strong>Pick List:</strong> {{requestData.pickList}}</p>
                  <p class="mb-2"><strong>Due Date:</strong> {{requestData.dueDate | date:'short'}}</p>
                  <p class="mb-2"><strong>Priority:</strong> 
                    <span class="badge" 
                          [class]="'bg-' + (requestData.priority === 'Critical' ? 'danger' : 
                                           requestData.priority === 'High' ? 'warning' : 
                                           requestData.priority === 'Medium' ? 'primary' : 'secondary')">
                      {{requestData.priority}}
                    </span>
                  </p>
                </div>
              </div>
              <div *ngIf="requestData.specialInstructions">
                <p class="mb-2"><strong>Special Instructions:</strong></p>
                <p class="text-muted">{{requestData.specialInstructions}}</p>
              </div>
            </div>
            
            <div class="col-md-6">
              <h6 class="text-muted mb-3">Validation Progress</h6>
              <div class="validation-progress">
                <div class="d-flex justify-content-between align-items-center mb-2">
                  <span>Items Validated</span>
                  <span class="fw-bold">{{validationStatus.itemsValidated}} / {{validationStatus.totalItems}}</span>
                </div>
                <div class="progress mb-3">
                  <div class="progress-bar" 
                       [style.width.%]="getProgressPercentage()"
                       [class]="validationStatus.hasErrors ? 'bg-warning' : 'bg-success'">
                  </div>
                </div>
                
                <div class="validation-status">
                  <div class="status-indicator" 
                       [class]="validationStatus.isComplete ? 'completed' : 'in-progress'">
                    <i [class]="validationStatus.isComplete ? 'ri-checkbox-circle-fill' : 'ri-time-line'"></i>
                    <span>{{validationStatus.isComplete ? 'Validation Complete' : 'Validation In Progress'}}</span>
                  </div>
                  
                  <div class="status-indicator" 
                       [class]="validationStatus.hasErrors ? 'has-errors' : 'no-errors'"
                       *ngIf="validationStatus.itemsValidated > 0">
                    <i [class]="validationStatus.hasErrors ? 'ri-error-warning-line' : 'ri-shield-check-line'"></i>
                    <span>{{validationStatus.hasErrors ? 'Issues Found' : 'No Issues'}}</span>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Send to Reviewer Button and Dialog (simple inline version) -->
    <div class="row mb-3">
      <div class="col-12">
        <button type="button" class="btn btn-outline-info" (click)="showSendToReviewer = !showSendToReviewer">
          <i class="ri-share-forward-line"></i> Send to Reviewer
        </button>
        <div *ngIf="showSendToReviewer" class="mt-3 card card-body">
          <div class="mb-2">
            <label for="reviewerId" class="form-label">Select Reviewer</label>
            <select id="reviewerId" class="form-select" [(ngModel)]="reviewerId" name="reviewerId">
              <option [ngValue]="null">-- Select Reviewer --</option>
              <option *ngFor="let user of reviewerList" [ngValue]="user.id" [disabled]="user.id === authService.currentUserValue?.id">
                {{user.name || user.username || user.email}}<span *ngIf="user.email"> ({{user.email}})</span>
              </option>
            </select>
          </div>
          <div class="mb-2">
            <label for="reviewerNotes" class="form-label">Notes to Reviewer</label>
            <textarea id="reviewerNotes" class="form-control" [(ngModel)]="reviewerNotes" name="reviewerNotes" rows="2" placeholder="Enter notes for reviewer..."></textarea>
          </div>
          <button type="button" class="btn btn-primary me-2" [disabled]="!reviewerId || reviewerList.length === 0" (click)="onSendReviewerClick()">Send</button>
          <div *ngIf="reviewerList.length === 0" class="alert alert-warning mt-2">
            No reviewers available.
          </div>
          <button type="button" class="btn btn-secondary" (click)="showSendToReviewer = false">Cancel</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Validation Form -->
  <form [formGroup]="validationForm" (ngSubmit)="saveValidation()">
    
    <!-- Bulk Actions -->
    <div class="row mb-3">
      <div class="col-12">
        <div class="card">
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-center">
              <h6 class="mb-0">Bulk Actions</h6>
              <div class="btn-group" role="group">
                <button type="button" 
                        class="btn btn-outline-success btn-sm" 
                        (click)="approveAllItems()">
                  <i class="ri-checkbox-multiple-line"></i> Approve All
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Items Validation -->
    <div class="row mb-4">
      <div class="col-12">
        <div class="card">
          <div class="card-header">
            <h5 class="mb-0">Item Validation</h5>
          </div>
          <div class="card-body p-0">
            <div class="table-responsive">
              <table class="table table-hover mb-0">
                <thead class="table-light">
                  <tr>
                    <th width="5%">Status</th>
                    <th width="15%">Part Number</th>
                    <th width="20%">Description</th>
                    <th width="10%">Requested</th>
                    <th width="10%">Available</th>
                    <th width="10%">Approved</th>
                    <th width="15%">Reason Code</th>
                    <th width="15%">Actions</th>
                  </tr>
                </thead>
                <tbody formArrayName="items">
                  <tr *ngFor="let item of items.controls; let i = index" 
                      [formGroupName]="i"
                      [class]="'table-row-' + item.get('status')?.value">
                    
                    <!-- Status -->
                    <td>
                      <span class="badge" 
                            [class]="'badge ' + getItemStatusClass(item.get('status')?.value)">
                        <i [class]="getItemStatusIcon(item.get('status')?.value)"></i>
                      </span>
                    </td>
                    
                    <!-- Part Number -->
                    <td>
                      <strong>{{item.get('partNumber')?.value}}</strong>
                    </td>
                    
                    <!-- Description -->
                    <td>
                      <span class="text-muted">{{item.get('description')?.value || 'No description'}}</span>
                    </td>
                    
                    <!-- Requested Quantity -->
                    <td>
                      <span class="fw-bold">{{item.get('requestedQty')?.value}}</span>
                    </td>
                    
                    <!-- Available Quantity -->
                    <td>
                      <span [class]="item.get('availableQty')?.value >= item.get('requestedQty')?.value ? 'text-success' : 'text-danger'">
                        {{item.get('availableQty')?.value}}
                      </span>
                    </td>
                    
                    <!-- Approved Quantity -->
                    <td>
                      <input type="number" 
                             class="form-control form-control-sm" 
                             formControlName="approvedQty"
                             [min]="0"
                             [max]="item.get('availableQty')?.value"
                             [class.is-invalid]="submitted && item.get('approvedQty')?.errors">
                    </td>
                    
                    <!-- Reason Code -->
                    <td>
                      <span class="badge bg-light text-dark">{{item.get('reasonCode')?.value}}</span>
                    </td>
                    
                    <!-- Actions -->
                    <td>
                      <div class="btn-group btn-group-sm" role="group">
                        <button type="button" 
                                class="btn btn-outline-success" 
                                (click)="approveItem(i)"
                                [class.active]="item.get('status')?.value === 'approved'"
                                title="Approve">
                          <i class="ri-check-line"></i>
                        </button>
                        <button type="button" 
                                class="btn btn-outline-danger" 
                                (click)="rejectItem(i)"
                                [class.active]="item.get('status')?.value === 'rejected'"
                                title="Reject">
                          <i class="ri-close-line"></i>
                        </button>
                        <button type="button" 
                                class="btn btn-outline-warning" 
                                (click)="flagForReview(i)"
                                [class.active]="item.get('status')?.value === 'needs-review'"
                                title="Flag for Review">
                          <i class="ri-flag-line"></i>
                        </button>
                      </div>
                    </td>
                  </tr>
                  
                  <!-- Validation Notes Row -->
                  <tr *ngFor="let item of items.controls; let i = index" 
                      [formGroupName]="i"
                      class="table-row-notes">
                    <td colspan="8">
                      <div class="validation-notes-section" 
                           *ngIf="item.get('status')?.value !== 'pending'">
                        <label class="form-label">Validation Notes:</label>
                        <textarea class="form-control form-control-sm" 
                                  formControlName="validationNotes"
                                  rows="2"
                                  placeholder="Add notes about this validation decision..."></textarea>
                      </div>
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Admin Notes Section -->
    <div class="row mb-4">
      <div class="col-12">
        <div class="card">
          <div class="card-header">
            <h5 class="mb-0">Admin Notes</h5>
          </div>
          <div class="card-body">
            <textarea class="form-control" 
                      formControlName="adminNotes"
                      rows="4"
                      placeholder="Add overall notes about this validation, any concerns, or instructions for the picking team..."></textarea>
          </div>
        </div>
      </div>
    </div>

    <!-- Action Buttons -->
    <div class="row">
      <div class="col-12">
        <div class="card">
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-center">
              <div>
                <button type="button" 
                        class="btn btn-outline-secondary me-2" 
                        (click)="goBack()"
                        [disabled]="isLoading">
                  Cancel
                </button>
                <button type="button" 
                        class="btn btn-outline-primary me-2" 
                        (click)="saveValidation()"
                        [disabled]="isLoading">
                  <span *ngIf="isLoading" class="spinner-border spinner-border-sm me-2"></span>
                  Save Progress
                </button>
              </div>
              
              <div>
                <button type="button" 
                        class="btn btn-outline-danger me-2" 
                        (click)="rejectRequest()"
                        [disabled]="isLoading">
                  <i class="ri-close-circle-line"></i> Reject Request
                </button>
                <button type="button" 
                        class="btn btn-success" 
                        (click)="approveAndSendToPicking()"
                        [disabled]="isLoading || !validationStatus.isComplete || validationStatus.hasErrors">
                  <i class="ri-send-plane-line"></i> Approve & Send to Picking
                </button>
              </div>
            </div>
            
            <!-- Validation Summary -->
            <div class="mt-3 pt-3 border-top" *ngIf="validationStatus.itemsValidated > 0">
              <div class="row text-center">
                <div class="col-md-3">
                  <div class="validation-summary-item">
                    <div class="number text-primary">{{validationStatus.totalItems}}</div>
                    <div class="label">Total Items</div>
                  </div>
                </div>
                <div class="col-md-3">
                  <div class="validation-summary-item">
                    <div class="number text-success">
                      {{ getApprovedCount() }}
                    </div>
                    <div class="label">Approved</div>
                  </div>
                </div>
                <div class="col-md-3">
                  <div class="validation-summary-item">
                    <div class="number text-danger">
                      {{ getRejectedCount() }}
                    </div>
                    <div class="label">Rejected</div>
                  </div>
                </div>
                <div class="col-md-3">
                  <div class="validation-summary-item">
                    <div class="number text-warning">
                      {{ getNeedsReviewCount() }}
                    </div>
                    <div class="label">Needs Review</div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

  </form>

</div>

<!-- Loading State -->
<div class="d-flex justify-content-center align-items-center" style="min-height: 400px;" *ngIf="isLoading">
  <div class="text-center">
    <div class="spinner-border text-primary" role="status">
      <span class="visually-hidden">Loading...</span>
    </div>
    <p class="mt-3 text-muted">Loading request data...</p>
  </div>
</div>
