<div class="container-fluid">
  <div class="row justify-content-center">
    <div class="col-12">
      
      <!-- Breadcrumb -->
      <nav aria-label="breadcrumb" class="mb-3">
        <ol class="breadcrumb mb-0">
          <li class="breadcrumb-item">
            <a href="#" class="text-decoration-none" (click)="$event.preventDefault()">
              <i class="mdi mdi-home-outline me-1"></i>Operations
            </a>
          </li>
          <li class="breadcrumb-item active" aria-current="page">
            Organization Chart
          </li>
        </ol>
      </nav>
      

      <div class="card shadow-sm border-0">
        <div class="card-header">
          <div class="d-flex align-items-stretch justify-content-between flex-wrap gap-3">
            <div class="d-flex align-items-stretch gap-3 flex-grow-1">
              <div class="form-icon d-flex align-items-center" style="min-width: 300px; max-width: 400px;">
                <app-user-search-v1 (notifyParent)="notifyParent($event)" [value]="query" [showLabel]="false"
                    [appendToBody]="'body'" [ngClass]="'mb-0 w-100'" [placeholder]="'Search employees...'"
                    [editableSearchTerm]="false"></app-user-search-v1>
              </div>
              
              <div class="d-flex align-items-center gap-2">
                <button class="btn btn-outline-secondary d-flex align-items-center" (click)="getData()" title="Refresh chart">
                  <i class="mdi mdi-refresh me-1"></i>Refresh
                </button>
                
                <button class="btn btn-outline-primary d-flex align-items-center" (click)="toggleLayout()" 
                        [title]="isHorizontalLayout ? 'Switch to Vertical Layout' : 'Switch to Horizontal Layout'">
                  <i class="mdi me-1" [ngClass]="layoutIcon"></i>
                  {{isHorizontalLayout ? 'Vertical' : 'Horizontal'}}
                </button>
                
                <div class="dropdown" ngbDropdown container="body">
                  <button class="btn btn-success d-flex align-items-center" 
                          type="button" 
                          id="departmentDropdown"
                          ngbDropdownToggle>
                    <i class="mdi mdi-domain me-1"></i>Departments
                    <i class="mdi mdi-chevron-down ms-1"></i>
                  </button>
                  <div class="dropdown-menu" 
                       ngbDropdownMenu 
                       aria-labelledby="departmentDropdown">
                    <a class="dropdown-item" href="#" (click)="$event.preventDefault(); openDepartmentModal()">
                      <i class="mdi mdi-plus me-2"></i>Add New Department
                    </a>
                    <div class="dropdown-divider"></div>
                    <h6 class="dropdown-header">Existing Departments ({{departments.length}})</h6>
                    <a class="dropdown-item" 
                       href="#" 
                       *ngFor="let dept of departments"
                       (click)="$event.preventDefault(); openDepartmentModal(dept)">
                      <div class="d-flex justify-content-between align-items-center">
                        <div class="flex-grow-1">
                          <div class="fw-semibold">{{dept.department_name}}</div>
                          <small class="text-muted">
                            {{dept.user_count || 0}} users
                          </small>
                        </div>
                        <i class="mdi mdi-pencil text-primary ms-2" title="Edit Department"></i>
                      </div>
                    </a>
                    <div *ngIf="departments.length === 0" class="dropdown-item-text text-muted">
                      <small>No departments found</small>
                    </div>
                  </div>
                </div>

                <!-- User Assignment Section -->
                <div class="dropdown" ngbDropdown container="body">
                  <!-- <button class="btn btn-outline-info d-flex align-items-center" 
                          type="button" 
                          id="userAssignmentDropdown"
                          ngbDropdownToggle>
                    <i class="mdi mdi-account-plus me-1"></i>Assign Users
                    <i class="mdi mdi-chevron-down ms-1"></i>
                  </button> -->
                  <div class="dropdown-menu p-3" 
                       ngbDropdownMenu 
                       aria-labelledby="userAssignmentDropdown"
                       style="min-width: 350px;">
                    <h6 class="dropdown-header">Assign User to Department</h6>
                    
                    <div class="mb-3">
                      <label class="form-label small fw-semibold">Select User:</label>
                      <app-user-search-v1 
                        (notifyParent)="onUserSelected($event)" 
                        [value]="selectedUserId"
                        [showLabel]="false"
                        [placeholder]="'Search and select user...'"
                        className="mb-0">
                      </app-user-search-v1>
                    </div>
                    
                    <div class="mb-3" *ngIf="selectedUser">
                      <label class="form-label small fw-semibold">Assign to Department:</label>
                      <select class="form-select form-select-sm" 
                              [(ngModel)]="selectedDepartmentId" 
                              (change)="assignUserToDepartment()">
                        <option value="">-- Select Department --</option>
                        <option *ngFor="let dept of departments" [value]="dept.id">
                          {{dept.department_name}}
                        </option>
                      </select>
                    </div>
                    
                    <div *ngIf="selectedUser" class="text-center">
                      <small class="text-muted">
                        Selected: <strong>{{selectedUser.first}} {{selectedUser.last}}</strong>
                      </small>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            
            <div class="d-flex align-items-center">
              <div class="d-flex gap-4 small text-muted">
                <span>
                  <i class="mdi mdi-account-multiple text-info me-1"></i>
                  <strong>{{originalData?.length || 0}}</strong> Employees
                </span>
                <span *ngIf="currentView">
                  <i class="mdi mdi-account-circle text-primary me-1"></i>
                  Viewing: <strong>{{currentView}}</strong>
                </span>
              </div>
            </div>
          </div>
        </div>
        
        <div class="card-body p-0 position-relative" style="height: calc(100vh - 223px);">
          <div #chartContainer id="chartContainer"></div>
          
          <!-- Status Legend - Inside Chart Area -->
          <div class="position-absolute top-0 end-0 m-3" style="z-index: 1000;">
            <div class="card shadow border-0" style="min-width: 220px;">
              <div class="card-header bg-body-secondary border-0 py-2">
                <h6 class="mb-0 text-body-secondary fw-semibold">
                  <i class="mdi mdi-information-outline me-2"></i>
                  Status Legend
                </h6>
              </div>
              <div class="card-body p-3">
                <table class="table table-sm mb-0">
                  <tbody>
                    <tr>
                      <td class="px-2 py-1">
                        <div class="rounded-circle"
                            style="background-color:gray;width: 12px; height: 12px; margin-top: 2px;"></div>
                      </td>
                      <td class="py-1">
                        <small class="text-body-secondary">Hire date not set</small>
                      </td>
                    </tr>
                    <tr>
                      <td class="px-2 py-1">
                        <div class="rounded-circle"
                            style="background-color:orange;width: 12px; height: 12px; margin-top: 2px;"></div>
                      </td>
                      <td class="py-1">
                        <small class="text-body-secondary">New Position</small>
                      </td>
                    </tr>
                    <tr>
                      <td class="px-2 py-1">
                        <div class="rounded-circle"
                            style="background-color:rgb(0, 195, 255);width: 12px; height: 12px; margin-top: 2px;"></div>
                      </td>
                      <td class="py-1">
                        <small class="text-body-secondary">Less than 6 months</small>
                      </td>
                    </tr>
                    <tr>
                      <td class="px-2 py-1">
                        <div class="rounded-circle"
                            style="background-color:#4B0082;width: 12px; height: 12px; margin-top: 2px;"></div>
                      </td>
                      <td class="py-1">
                        <small class="text-body-secondary">Less than 12 months</small>
                      </td>
                    </tr>
                    <tr>
                      <td class="px-2 py-1">
                        <div class="rounded-circle"
                            style="background-color:#002D62;width: 12px; height: 12px; margin-top: 2px;"></div>
                      </td>
                      <td class="py-1">
                        <small class="text-body-secondary">12+ months</small>
                      </td>
                    </tr>
                    <tr>
                      <td class="px-2 py-1">
                        <div class="rounded-circle"
                            style="background-color:red;width: 12px; height: 12px; margin-top: 2px;"></div>
                      </td>
                      <td class="py-1">
                        <small class="text-body-secondary">Open Position</small>
                      </td>
                    </tr>
                  </tbody>
                </table>
                <!-- <div class="border-top pt-2 mt-2">
                  <small class="text-muted">
                    <i class="mdi mdi-information me-1"></i>
                    <strong>Tip:</strong> Use the "Assign Users" dropdown to assign employees to departments
                  </small>
                </div> -->
              </div>
            </div>
          </div>
        </div>
      </div>

      
      <!-- Floating Action Buttons -->
      <div class="action-buttons" style="position: absolute;bottom: 40px;right: 35px;">
        <div class="card shadow border-0">
          <div class="card-body p-3">
            <div class="btn-group-verticalw-50">
              <div class="mb-2" *ngIf="currentView">
                <div class="alert alert-info py-2 px-3 mb-2 border-0">
                  <div class="d-flex align-items-center justify-content-between">
                    <small class="text-body">
                      <i class="mdi mdi-account-circle me-1"></i>
                      Viewing User: <strong>{{currentView}}</strong>
                    </small>
                    <button class="btn btn-sm btn-outline-info" (click)="clearMark()">
                      <i class="mdi mdi-close"></i>
                    </button>
                  </div>
                </div>
              </div>

              <div *ngIf="currentView" class="mb-2">
                <button (click)="chart?.setExpanded && chart.setExpanded(currentView).render()"
                    class="btn btn-info mb-1w-50"
                    [disabled]="!chart?.setExpanded">
                    <i class="mdi mdi-plus me-1"></i>Set Expand
                </button>
                <button (click)="chart?.setExpanded && chart.setExpanded(currentView, false).render()"
                    class="btn btn-info mb-1w-50"
                    [disabled]="!chart?.setExpanded">
                    <i class="mdi mdi-minus me-1"></i>Collapse
                </button>
                <button (click)="chart?.setUpToTheRootHighlighted && chart.setUpToTheRootHighlighted(currentView).render().fit()"
                    class="btn btn-info mb-2w-50"
                    [disabled]="!chart?.setUpToTheRootHighlighted">
                    <i class="mdi mdi-sitemap me-1"></i>Mark Root
                </button>
              </div>

              <button (click)="chart?.expandAll && chart.expandAll()" 
                      class="btn btn-primary mb-2w-50"
                      [disabled]="!chart?.expandAll">
                  <i class="mdi mdi-unfold-more-horizontal me-1"></i>Expand All
              </button>
              <button (click)="chart?.collapseAll && chart.collapseAll()" 
                      class="btn btn-primary mb-2w-50"
                      [disabled]="!chart?.collapseAll">
                  <i class="mdi mdi-unfold-less-horizontal me-1"></i>Collapse All
              </button>
              <button (click)="chart?.fit && chart.fit()" 
                      class="btn btn-primary mb-2w-50"
                      [disabled]="!chart?.fit">
                  <i class="mdi mdi-fit-to-screen me-1"></i>Fit
              </button>
            </div>
          </div>
        </div>
      </div>
      
    </div>
  </div>
</div>

<!-- Department Management Modal -->
<app-department-modal
  [isVisible]="showDepartmentModal"
  [currentDepartment]="currentDepartment"
  (departmentSaved)="onDepartmentSaved()"
  (departmentDeleted)="onDepartmentDeleted()"
  (modalClosed)="closeDepartmentModal()">
</app-department-modal>